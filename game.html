<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <!-- âœ… ëª¨ë°”ì¼ì—ì„œ í™•ëŒ€/ìŠ¤í¬ë¡¤ í”ë“¤ë¦¼ ìµœì†Œí™” -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Bull vs Bear : Arena Pro V15</title>

  <!-- ê²Œì„ ë¼ì´ë¸ŒëŸ¬ë¦¬ -->
  <script src="https://unpkg.com/lightweight-charts@3.8.0/dist/lightweight-charts.standalone.production.js"></script>
  <script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>

  <style>
    :root{
      --pcw: 1600; /* PC ê¸°ì¤€ í­ */
      --pch: 940;  /* PC ê¸°ì¤€ ë†’ì´(ëŒ€ëµ) */
      --scale: 1;
    }

    /* âœ… ìŠ¤í¬ë¡¤ ì—†ëŠ” ë·°ì–´: í˜ì´ì§€ ì „ì²´ ê³ ì • */
    html, body{
      height: 100%;
      margin: 0;
      overflow: hidden; /* í•µì‹¬: ìŠ¤í¬ë¡¤ ì œê±° (pull-to-refresh ì›ì²œ ì°¨ë‹¨) */
      background: #0b0e11;
      color: #fff;
      font-family: sans-serif;
      touch-action: manipulation; /* í™•ëŒ€/ë”ë¸”íƒ­ ì„±í–¥ ì–µì œ */
      -webkit-tap-highlight-color: transparent;
    }

    /* âœ… ë·°ì–´ í”„ë ˆì„ */
    .viewer{
      position: fixed;
      inset: 0;
      overflow: hidden;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      background: #0b0e11;
    }

    /* âœ… PC í™”ë©´ ì¶•ì†Œ ìº”ë²„ìŠ¤ */
    .pc-canvas{
      width: calc(var(--pcw) * 1px);
      transform-origin: top center;
      transform: scale(var(--scale));
    }

    /* âœ… ìƒë‹¨ HUD (ì¡°ì‘ ë°©í•´ ìµœì†Œ) */
    .hud{
      position: fixed;
      top: 10px;
      left: 10px;
      right: 10px;
      z-index: 99999;
      display: flex;
      justify-content: space-between;
      align-items: center;
      pointer-events: none;
    }
    .hud a, .hud .pill{
      pointer-events: auto;
      text-decoration: none;
      font-weight: 900;
      font-size: 13px;
      padding: 8px 10px;
      border-radius: 12px;
      border: 1px solid rgba(243,186,47,0.35);
      background: rgba(24,26,32,0.78);
      color: #f3ba2f;
      backdrop-filter: blur(6px);
    }
    .hud .pill{
      color: #d1d4dc;
      border-color: rgba(209,212,220,0.18);
      font-weight: 700;
    }

    /* (ì„ íƒ) ì„¸ë¡œëª¨ë“œ ì•ˆë‚´ */
    .rotate-hint{
      position: fixed;
      inset: 0;
      z-index: 99998;
      display: none;
      align-items: center;
      justify-content: center;
      text-align: center;
      padding: 24px;
      background: rgba(0,0,0,0.75);
      color: #f3ba2f;
      font-weight: 900;
      line-height: 1.5;
    }
    .rotate-hint small{
      display:block;
      margin-top: 8px;
      color: #d1d4dc;
      font-weight: 700;
    }

    /* =========================
       âœ… ê²Œì„ CSS (ê¸°ì¡´ game.htmlê³¼ ë™ì¼)
    ========================= */
    .game-header { text-align: center; margin-bottom: 10px; }
    .game-header h1 { color: #f3ba2f; margin: 0; font-size: 28px; text-shadow: 2px 2px #cf304a; letter-spacing: 2px; }
    .main-container { width: 98%; max-width: 1600px; height: 850px; margin: 0 auto; background: #0b0e11; border: 1px solid #f3ba2f; border-radius: 12px; display: flex; flex-direction: column; overflow: hidden; box-shadow: 0 20px 50px rgba(0,0,0,0.8); }
    .chart-section { flex: 1.1; display: flex; border-bottom: 2px solid #2b3139; min-height: 450px; }
    #tg-tv-main { flex: 1; border-right: 1px solid #2b3139; background: #131722; }
    #tg-sub-chart { flex: 1; background: #131722; position: relative; }
    .control-section { flex: 0.9; background: #181a20; display: flex; padding: 20px; gap: 20px; }

    .box { background: #0b0e11; border-radius: 8px; border: 1px solid #2b3139; padding: 15px; }
    .orderbook { flex: 0.7; font-family: monospace; }
    .trading { flex: 1.2; display: flex; flex-direction: column; gap: 10px; }
    .status { flex: 1; background: #131722; position: relative; min-width: 320px; overflow: hidden; }

    input { background: #1e2329; border: 1px solid #333; color: #fff; padding: 10px; border-radius: 4px; width: 90%; font-size: 14px; }
    button { cursor: pointer; border: none; border-radius: 4px; font-weight: bold; transition: 0.2s; }
    button:hover { opacity: 0.8; }

    .btn-long { background: #02c076; color: #fff; padding: 15px; font-size: 16px; }
    .btn-short { background: #cf304a; color: #fff; padding: 15px; font-size: 16px; }
    .btn-exit { background: #fff; color: #000; padding: 12px; width: 100%; margin-top: 10px; font-size: 14px; }
    .btn-refill { background: linear-gradient(180deg, #f3ba2f 0%, #d9a522 100%); color: #000; padding: 8px 15px; font-size: 11px; }

    .order-item { display: flex; justify-content: space-between; font-size: 11px; padding: 6px 5px; border-bottom: 1px solid #222; }
    .cancel-btn { color: #848e9c; cursor: pointer; }

    .pos-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 5px; margin-top: 5px; border-top: 1px solid #2b3139; padding-top: 5px; }
    .pos-label { font-size: 10px; color: #848e9c; margin-bottom: 2px; }
    .pos-value { font-size: 13px; font-weight: bold; color: #eee; }
  </style>
</head>

<body>

  <!-- âœ… ìƒë‹¨ HUD -->
  <div class="hud">
    <a href="index.html">â† ëŒì•„ê°€ê¸°</a>
    <div class="pill">ëª¨ë°”ì¼ì€ PC í™”ë©´ ì¶•ì†Œ ë·°ì–´ ëª¨ë“œ</div>
  </div>

  <!-- (ì„ íƒ) ì„¸ë¡œëª¨ë“œ ì•ˆë‚´ -->
  <div class="rotate-hint" id="rotateHint">
    ğŸ“± ê°€ë¡œëª¨ë“œë¥¼ ê¶Œì¥í•©ë‹ˆë‹¤
    <small>ëª¨ë°”ì¼ì—ì„œëŠ” PC í™”ë©´ì„ ì¶•ì†Œí•´ ë³´ì—¬ì£¼ëŠ” ë·°ì–´ ëª¨ë“œì…ë‹ˆë‹¤</small>
  </div>

  <!-- âœ… ìŠ¤í¬ë¡¤ ì—†ëŠ” ë·°ì–´ -->
  <div class="viewer">
    <div class="pc-canvas" id="pcCanvas">

      <!-- ====== ê²Œì„ HTML ====== -->
      <div class="game-header" style="margin-bottom: 20px;">
        <h1 style="font-size: 34px; margin-bottom: 10px;">
          <span style="color: #f3ba2f;">BULL vs BEAR : ARENA</span>
          <span style="font-size: 22px; color: #ffffff; font-weight: normal; margin-left: 12px; vertical-align: middle;">ê°€ìƒ íŠ¸ë ˆì´ë”© ê²Œì„</span>
        </h1>

        <div style="background: rgba(243, 186, 47, 0.1); border: 1px solid rgba(243, 186, 47, 0.3); padding: 15px; border-radius: 8px; display: inline-block; text-align: left; font-size: 13px; color: #d1d4dc; line-height: 1.6; max-width: 850px;">
          <div style="margin-bottom: 10px; border-bottom: 1px dashed rgba(243, 186, 47, 0.2); padding-bottom: 10px;">
            <span style="color: #f3ba2f; font-weight: bold;">ğŸ’¡ ì œì‘ ì˜ë„:</span>
            ì„ ë¬¼ íˆ¬ìì˜ ìœ„í—˜ì„±ì„ ì•Œë©´ì„œë„ ì—°ìŠµí•  ê³³ì´ ë§ˆë•…ì¹˜ ì•Šì•˜ë˜ ë¶„ë“¤ì„ ìœ„í•´ ë§Œë“¤ì—ˆìŠµë‹ˆë‹¤. <br>
            ì‹¤ì „ íˆ¬ì ì „, ì´ê³³ì—ì„œ <b>ì¶©ë¶„í•œ ì—°ìŠµê³¼ ì „ëµ ê²€ì¦</b>ì„ í†µí•´ ì†Œì¤‘í•œ ìì‚°ì„ ì§€í‚¤ì‹œê¸¸ ë°”ëë‹ˆë‹¤.
          </div>

          <span style="color: #f3ba2f; font-weight: bold;">[ê²Œì„ ê·œì¹™]</span>
          ì‹œë“œ <b>$30,000</b> ì œê³µ | ê°€ê²© ì…ë ¥ ì‹œ <b>ì§€ì •ê°€</b>, ë¹„ìš°ë©´ <b>ì‹œì¥ê°€</b> |
          <span style="color: #cf304a;">ë¹¨ê°„ì„ (LIQ) í„°ì¹˜ ì‹œ ì¦‰ì‹œ ì²­ì‚°</span><br>
          <span style="color: #848e9c; font-size: 11px;">â€» ë¸Œë¼ìš°ì €ë¥¼ ë°”ê¾¸ê±°ë‚˜ ì¿ í‚¤ë¥¼ ì‚­ì œí•˜ë©´ ë°ì´í„°ê°€ ì´ˆê¸°í™”ë˜ë‹ˆ ì£¼ì˜í•˜ì„¸ìš”!</span>
        </div>
      </div>

      <div class="main-container">
        <div class="chart-section">
          <div id="tg-tv-main"></div>
          <div id="tg-sub-chart"></div>
        </div>

        <div class="control-section">
          <div class="box orderbook">
            <div id="tg-asks" style="color: #cf304a;"></div>
            <div id="tg-mid-price" style="font-size: 22px; font-weight: bold; margin: 10px 0; color: #f3ba2f; text-align: center;">$0.00</div>
            <div id="tg-bids" style="color: #02c076;"></div>
          </div>

          <div class="trading">
            <div style="background: #1e2329; padding: 12px; border-radius: 6px; display: flex; justify-content: space-between; align-items: center; border: 1px solid #333;">
              <div>
                <div style="font-size: 9px; color: #848e9c;">AVAILABLE CREDITS</div>
                <div id="tg-equity" style="font-size: 20px; font-weight: 900; color: #f3ba2f;">$30,000.00</div>
              </div>
              <button class="btn-refill" onclick="tgRefill()">REFILL âš¡</button>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
              <input type="number" id="tg-amt" placeholder="ë‹¬ëŸ¬ ì…ë ¥">
              <input type="number" id="tg-lev" placeholder="ë ˆë²„ë¦¬ì§€ ì…ë ¥(1~âˆ)">
            </div>

            <input type="number" id="tg-limit" placeholder="LIMIT PRICE (MARKET IF EMPTY)" style="width: 94%;">

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
              <button class="btn-long" onclick="checkUserBeforeGame('long')">LONG(Add)</button>
              <button class="btn-short" onclick="checkUserBeforeGame('short')">SHORT(Add)</button>
            </div>
          </div>

          <div class="box status" style="flex: 1; background: #131722; position: relative; min-width: 320px; height: 380px; display: flex; flex-direction: column; overflow: hidden;">
            <div id="tg-no-pos" style="text-align: center; padding: 20px 0; color: #3d4550; font-size: 12px;">NO ACTIVE POSITION</div>

            <div id="tg-pos-active" style="display: none; flex-shrink: 0;">
              <div style="display: flex; justify-content: space-between; align-items: center;">
                <span id="tg-side-badge" style="padding: 2px 8px; border-radius: 3px; font-weight:bold; font-size: 12px; color:#fff;"></span>
                <div style="text-align: right;">
                  <div class="pos-label">Unrealized P&L</div>
                  <div id="tg-pnl-val" style="font-size: 14px; font-weight: bold;"></div>
                </div>
              </div>

              <div id="tg-roe" style="font-size: 17px; font-weight: 500; text-align: center; margin: 2px 0;">0.00%</div>

              <div class="pos-grid">
                <div>
                  <div class="pos-label">Qty (BTC)</div>
                  <div id="tg-pos-qty" class="pos-value">0.000</div>
                </div>
                <div style="text-align: right;">
                  <div class="pos-label">Value (USDT)</div>
                  <div id="tg-pos-value" class="pos-value">$0.00</div>
                </div>
                <div>
                  <div class="pos-label">Avg. Entry</div>
                  <div id="tg-pos-entry" class="pos-value">$0.00</div>
                </div>
                <div style="text-align: right;">
                  <div class="pos-label">Liq. Price</div>
                  <div id="tg-pos-liq" class="pos-value" style="color: #cf304a;">$0.00</div>
                </div>
              </div>

              <button class="btn-exit" onclick="tgExit()">MARKET EXIT (Full)</button>
            </div>

            <div style="margin-top: 15px; border-top: 1px solid #2b3139; padding-top: 10px; display: flex; flex-direction: column; flex: 1; min-height: 0;">
              <div style="font-size: 10px; color: #848e9c; font-weight: bold; margin-bottom: 5px; flex-shrink: 0;">PENDING ORDERS (SCROLL)</div>
              <div id="tg-order-list" style="flex: 1; overflow-y: auto; background: #050505; border: 1px solid #1a1a1a;"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- âœ… ì¸ì¦ ê²Œì´íŠ¸ -->
      <div id="entrance-gate" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(11, 14, 17, 0.98); z-index:10000; flex-direction:column; align-items:center; justify-content:center; color:#f3ba2f; font-family:sans-serif;">
        <div style="background:#181a20; padding:40px; border-radius:20px; border:2px solid #f3ba2f; text-align:center; width:340px; box-shadow: 0 10px 50px rgba(0,0,0,0.8); position: relative;">
          <span onclick="closeGate()" style="position:absolute; right:20px; top:15px; cursor:pointer; font-size:28px; color:#848e9c;">&times;</span>

          <img src="https://cryptologos.cc/logos/bitcoin-btc-logo.png?v=025" style="width:50px; margin-bottom:15px;">
          <h2 style="margin:0 0 10px 0; font-size:24px;">ğŸ® ê²Œì„ ì°¸ì—¬ ì¸ì¦</h2>
          <p style="color:#848e9c; font-size:14px; margin-bottom:25px;">ì´ë©”ì¼ì„ í•œ ë²ˆë§Œ ë“±ë¡í•˜ì‹œë©´<br>
            <b>[ë¹„íŠ¸ì½”ì¸ ê²Œì„]</b>ê³¼ <b>[ê°€ê²© ì˜ˆì¸¡ í™•ì¸]</b>ì„<br>
            ëª¨ë‘ ììœ ë¡­ê²Œ ì´ìš©í•˜ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤!</p>

          <input type="text" id="db-name" placeholder="ì„±í•¨" style="padding:12px; width:100%; border-radius:8px; border:1px solid #444; background:#2b3139; color:white; margin-bottom:15px; box-sizing:border-box; outline:none;">
          <input type="email" id="db-email" placeholder="ì´ë©”ì¼ ì£¼ì†Œ" style="padding:12px; width:100%; border-radius:8px; border:1px solid #444; background:#2b3139; color:white; margin-bottom:25px; box-sizing:border-box; outline:none;">

          <button onclick="submitToSheet()" id="db-btn" style="padding:15px; width:100%; background:#f3ba2f; border:none; border-radius:8px; color:#000; font-weight:bold; cursor:pointer; font-size:18px;">ì¸ì¦í•˜ê³  ë°°íŒ…í•˜ê¸°</button>

          <p onclick="closeGate()" style="margin-top:20px; text-decoration:underline; cursor:pointer; color:#848e9c; font-size:13px;">ê·¸ëƒ¥ êµ¬ê²½ë§Œ í• ë˜ìš” (ì·¨ì†Œ)</p>
        </div>
      </div>
      <!-- ====== ê²Œì„ HTML ë ====== -->

    </div>
  </div>

  <script>
    // âœ… ìŠ¤í¬ë¡¤ ì—†ëŠ” ë·°ì–´: í™”ë©´ì— ë”± ë§ê²Œ ì¶•ì†Œ(ê°€ë¡œ/ì„¸ë¡œ ëª¨ë‘ ê³ ë ¤)
    let raf = 0;

    function fitToScreen(){
      const pcw = 1600;
      const pch = 940;

      const vw = Math.max(document.documentElement.clientWidth, window.innerWidth || 0);
      const vh = Math.max(document.documentElement.clientHeight, window.innerHeight || 0);

      const safeW = vw - 10;
      const safeH = vh - 70; // HUD ì—¬ìœ 

      const s = Math.min(1, safeW / pcw, safeH / pch);
      document.documentElement.style.setProperty('--scale', String(s));

      // ì„¸ë¡œ & ì¢ìœ¼ë©´ ì•ˆë‚´
      const hint = document.getElementById('rotateHint');
      if (hint) {
        const shouldHint = (vw < 520 && vw < vh);
        hint.style.display = shouldHint ? 'flex' : 'none';
      }
    }

    function scheduleFit(){
      cancelAnimationFrame(raf);
      raf = requestAnimationFrame(fitToScreen);
    }

    window.addEventListener('resize', scheduleFit, { passive: true });
    window.addEventListener('orientationchange', scheduleFit, { passive: true });
    document.addEventListener('DOMContentLoaded', fitToScreen);
  </script>

  <script>
    /* ====== ì¸ì¦ ê²Œì´íŠ¸ + ê²Œì„ ë²„íŠ¼ ì—°ê²° ====== */
    (function() {
      let selectedType = "";

      window.closeGate = function() {
        const gate = document.getElementById('entrance-gate');
        if (gate) gate.style.display = 'none';
      };

      window.checkUserBeforeGame = function(type) {
        selectedType = type;

        if (localStorage.getItem('btc_user_done')) {
          if (typeof tgPlace === "function") tgPlace(type);
        } else {
          const gate = document.getElementById('entrance-gate');
          if (gate) gate.style.display = 'flex';
        }
      };

      window.submitToSheet = async function() {
        const name = document.getElementById('db-name').value.trim();
        const email = document.getElementById('db-email').value.trim();
        const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbwgkTuEi-ajNA32Aoatssy5OctS87M0iqfxGJK15_1vKlet7f4A8qB3fkYOL3uq3RJiQw/exec";

        if (!name || !email.includes('@')) {
          alert("ì •ë³´ë¥¼ ì˜¬ë°”ë¥´ê²Œ ì…ë ¥í•´ì£¼ì„¸ìš”.");
          return;
        }

        const btn = document.getElementById('db-btn');
        btn.disabled = true;
        btn.innerText = "ì¸ì¦ ì¤‘...";

        try {
          const formData = new URLSearchParams();
          formData.append("name", name);
          formData.append("email", email);
          formData.append("status", "í†µí•©ì¸ì¦ì™„ë£Œ");
          formData.append("date", new Date().toLocaleString());

          await fetch(WEB_APP_URL, {
            method: 'POST',
            mode: 'no-cors',
            body: formData
          });

          localStorage.setItem('btc_user_done', 'true');
          localStorage.setItem('registeredName', name);
          localStorage.setItem('registeredEmail', email);

          closeGate();
          alert("ì¸ì¦ ì™„ë£Œ! ì´ì œ ê²Œì„/ì˜ˆì¸¡ì„ ììœ ë¡­ê²Œ ì´ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");

          if (selectedType && typeof tgPlace === "function") {
            tgPlace(selectedType);
          }
        } catch (e) {
          console.error("ì¸ì¦ ì‹¤íŒ¨:", e);
          closeGate();
        } finally {
          btn.disabled = false;
          btn.innerText = "ì¸ì¦í•˜ê³  ë°°íŒ…í•˜ê¸°";
        }
      };
    })();
  </script>

  <script>
    /* ====== ê²Œì„ JS ====== */
    (function() {
      const STORAGE_KEY = 'bull_vs_bear_arena_v15_pro';
      let saved = JSON.parse(localStorage.getItem(STORAGE_KEY)) || {};

      let cash = Number(saved.cash !== undefined ? saved.cash : 30000);
      let pos = saved.pos || null;
      let orders = saved.orders || [];
      let btc = 0, candleSeries, lastCandle, entryLine, liqLine, orderLines = {};

      // TradingView
      new TradingView.widget({
        autosize: true,
        symbol: "BYBIT:BTCUSDT.P",
        interval: "1",
        theme: "dark",
        container_id: "tg-tv-main",
        locale: "kr"
      });

      // Lightweight Charts
      const chart = LightweightCharts.createChart(document.getElementById('tg-sub-chart'), {
        layout: { backgroundColor: '#131722', textColor: '#d1d4dc' },
        grid: { vertLines: { color: '#1e2329' }, horzLines: { color: '#1e2329' } },
        timeScale: { timeVisible: true, borderColor: '#2b3139' }
      });
      candleSeries = chart.addCandlestickSeries({
        upColor: '#02c076',
        downColor: '#cf304a',
        borderVisible: false,
        wickUpColor: '#02c076',
        wickDownColor: '#cf304a'
      });

      function save() { localStorage.setItem(STORAGE_KEY, JSON.stringify({ cash, pos, orders })); }

      window.tgRefill = () => {
        if (confirm("Reset account to $30,000?")) {
          cash = 30000; pos = null; orders = []; save(); location.reload();
        }
      };

      const ws = new WebSocket('wss://stream.bybit.com/v5/public/linear');
      ws.onopen = () => ws.send(JSON.stringify({ op: "subscribe", args: ["tickers.BTCUSDT"] }));
      ws.onmessage = (e) => {
        const d = JSON.parse(e.data);
        if (d.data && d.data.lastPrice) {
          btc = parseFloat(d.data.lastPrice);
          const mid = document.getElementById('tg-mid-price');
          if (mid) mid.innerText = "$" + btc.toLocaleString();

          const min = Math.floor(Date.now() / 60000) * 60;
          if (!lastCandle || lastCandle.time !== min) lastCandle = { time: min, open: btc, high: btc, low: btc, close: btc };
          else {
            lastCandle.high = Math.max(lastCandle.high, btc);
            lastCandle.low = Math.min(lastCandle.low, btc);
            lastCandle.close = btc;
          }
          candleSeries.update(lastCandle);

          checkLiquidation(); checkOrders(); render(); updateOrderBook();
        }
      };

      window.tgPlace = (side) => {
        const marginAmt = Number(document.getElementById('tg-amt').value);
        const lp = Number(document.getElementById('tg-limit').value);
        const lev = Number(document.getElementById('tg-lev').value);

        if (marginAmt <= 0) return alert("ê¸ˆì•¡ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!");
        if (lev <= 0) return alert("ë ˆë²„ë¦¬ì§€ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”!");
        if (cash < marginAmt && (!pos || pos.side !== side)) return alert("Not enough Available Credit!");

        if (!lp) {
          executeTrade(side, btc, marginAmt, lev);
        } else {
          orders.push({ id: Date.now(), side, target: lp, amt: marginAmt, lev });
          updateOrderLines();
          save();
        }
        document.getElementById('tg-limit').value = "";
      };

      function executeTrade(side, price, marginAmt, lev) {
        if (pos && pos.side !== side) tgExit();

        if (cash >= marginAmt) {
          cash -= marginAmt;
          if (pos && pos.side === side) {
            const currentQty = (pos.amt * pos.lev) / pos.entry;
            const newQty = (marginAmt * lev) / price;
            pos.entry = ((pos.entry * currentQty) + (price * newQty)) / (currentQty + newQty);
            pos.amt += marginAmt;
          } else {
            pos = { side, entry: price, amt: marginAmt, lev };
          }
          updateLines(); render(); save();
        }
      }

      function checkOrders() {
        orders.forEach((o, i) => {
          let hit = (o.side === 'long' && btc <= o.target) || (o.side === 'short' && btc >= o.target);
          if (hit) {
            if (pos && pos.side !== o.side) {
              const closeAmt = Math.min(pos.amt, o.amt);
              const diff = (o.target - pos.entry) / pos.entry * (pos.side === 'short' ? -1 : 1);
              const pnl = closeAmt * diff * pos.lev;

              cash += (closeAmt + pnl);
              pos.amt -= closeAmt;

              if (pos.amt < 1) pos = null;
              alert(`Partial Close Filled at $${o.target.toLocaleString()}`);
            } else {
              executeTrade(o.side, o.target, o.amt, o.lev);
            }
            orders.splice(i, 1);
            updateOrderLines(); updateLines(); render(); save();
          }
        });
      }

      window.tgCancel = (id) => {
        orders = orders.filter(o => o.id !== id);
        updateOrderLines();
        save();
      };

      window.tgExit = () => {
        if (!pos) return;
        const diff = (btc - pos.entry) / pos.entry * (pos.side === 'short' ? -1 : 1);
        const pnl = pos.amt * diff * pos.lev;
        cash += (pos.amt + pnl);
        pos = null;
        updateLines(); render(); save();
      };

      function checkLiquidation() {
        if (!pos) return;
        if ((pos.side === 'long' && btc <= pos.liqPrice) || (pos.side === 'short' && btc >= pos.liqPrice)) {
          pos = null; cash = Math.max(0, cash); save(); updateLines(); render();
          alert("LIQUIDATED - Margin Lost");
        }
      }

      function updateLines() {
        if (entryLine) candleSeries.removePriceLine(entryLine);
        if (liqLine) candleSeries.removePriceLine(liqLine);
        if (pos) {
          const liq = pos.side === 'long'
            ? pos.entry * (1 - (0.95/pos.lev))
            : pos.entry * (1 + (0.95/pos.lev));
          pos.liqPrice = liq;
          entryLine = candleSeries.createPriceLine({ price: pos.entry, color: '#02c076', lineWidth: 2, title: 'ENTRY' });
          liqLine = candleSeries.createPriceLine({ price: liq, color: '#cf304a', lineWidth: 2, title: 'LIQ' });
        }
      }

      function updateOrderLines() {
        for (let id in orderLines) candleSeries.removePriceLine(orderLines[id]);
        orderLines = {};
        let html = '';
        orders.sort((a,b) => b.target - a.target).forEach(o => {
          orderLines[o.id] = candleSeries.createPriceLine({ price: o.target, color: '#f3ba2f', lineStyle: 2, title: 'LIMIT' });
          html += `<div class="order-item"><span style="color:${o.side==='long'?'#02c076':'#cf304a'}">${o.side.toUpperCase()} $${o.target.toLocaleString()}</span><span>$${o.amt.toLocaleString()} <b class="cancel-btn" onclick="tgCancel(${o.id})">âœ–</b></span></div>`;
        });
        document.getElementById('tg-order-list').innerHTML = html || '<div style="color:#444;text-align:center;font-size:11px;">No pending orders</div>';
      }

      function updateOrderBook() {
        let a = '', b = '';
        for(let i=11; i>0; i--) a += `<div style="display:flex; justify-content:space-between; opacity:0.6; font-size:11px"><span>${(btc+i*1.2).toFixed(1)}</span><span>${(Math.random()*0.3).toFixed(2)}</span></div>`;
        for(let i=1; i<=11; i++) b += `<div style="display:flex; justify-content:space-between; opacity:0.6; font-size:11px"><span>${(btc-i*1.2).toFixed(1)}</span><span>${(Math.random()*0.3).toFixed(2)}</span></div>`;
        document.getElementById('tg-asks').innerHTML = a;
        document.getElementById('tg-bids').innerHTML = b;
      }

      function render() {
        document.getElementById('tg-equity').innerText = "$" + Math.max(0, cash).toLocaleString(undefined, {minimumFractionDigits:2});
        if (pos) {
          document.getElementById('tg-pos-active').style.display = "block";
          document.getElementById('tg-no-pos').style.display = "none";
          const diff = (btc - pos.entry) / pos.entry * (pos.side === 'short' ? -1 : 1);
          const pnl = pos.amt * diff * pos.lev;
          const roe = diff * pos.lev * 100;
          const qty = (pos.amt * pos.lev) / pos.entry;

          document.getElementById('tg-roe').innerText = (roe>=0?"+":"")+roe.toFixed(2) + "%";
          document.getElementById('tg-roe').style.color = roe>=0?"#02c076":"#cf304a";
          document.getElementById('tg-pnl-val').innerText = (pnl>=0?"+$":"-$")+Math.abs(pnl).toLocaleString(undefined, {minimumFractionDigits:2});
          document.getElementById('tg-pnl-val').style.color = pnl>=0?"#02c076":"#cf304a";
          document.getElementById('tg-side-badge').innerText = pos.side.toUpperCase()+" "+pos.lev+"x";
          document.getElementById('tg-side-badge').style.background = pos.side==='long'?"#02c076":"#cf304a";

          document.getElementById('tg-pos-qty').innerText = qty.toFixed(3);
          document.getElementById('tg-pos-value').innerText = "$" + (pos.amt * pos.lev + pnl).toLocaleString(undefined, {maximumFractionDigits:2});
          document.getElementById('tg-pos-entry').innerText = "$" + pos.entry.toLocaleString();
          document.getElementById('tg-pos-liq').innerText = "$" + pos.liqPrice.toLocaleString(undefined, {maximumFractionDigits:1});
        } else {
          document.getElementById('tg-pos-active').style.display = "none";
          document.getElementById('tg-no-pos').style.display = "block";
        }
      }

      setTimeout(() => { updateLines(); updateOrderLines(); }, 1500);
    })();
  </script>

</body>
</html>

