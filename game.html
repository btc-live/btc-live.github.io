<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Bull vs Bear : Arena Pro V15 (Mobile)</title>

  <!-- ë¼ì´ë¸ŒëŸ¬ë¦¬ -->
  <script src="https://unpkg.com/lightweight-charts@3.8.0/dist/lightweight-charts.standalone.production.js"></script>
  <script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>

  <style>
    html, body{
      height: 100%;
      margin: 0;
      background:#0b0e11;
      color:#fff;
      font-family: sans-serif;
      overscroll-behavior-y: none; /* Android/Chrome pull-to-refresh ì™„í™” */
    }

    /* âœ… ìŠ¤í¬ë¡¤ì€ ì´ ì»¨í…Œì´ë„ˆì—ì„œë§Œ */
    #page-scroll{
      height: 100vh;
      overflow-y: auto;
      overflow-x: hidden;
      -webkit-overflow-scrolling: touch;
      overscroll-behavior-y: none;
      padding: 10px;
      box-sizing: border-box;
    }

    /* ìƒë‹¨ ë„¤ë¹„ */
    .topbar{
      display:flex;
      justify-content: space-between;
      align-items:center;
      gap: 10px;
      margin-bottom: 10px;
    }
    .topbar a{
      color:#f3ba2f;
      text-decoration:none;
      font-weight:900;
      padding: 8px 10px;
      border-radius: 10px;
      border: 1px solid rgba(243,186,47,0.35);
      background: rgba(24,26,32,0.75);
    }
    .topbar .pill{
      color:#d1d4dc;
      font-weight: 700;
      font-size: 12px;
      padding: 8px 10px;
      border-radius: 10px;
      border: 1px solid rgba(209,212,220,0.18);
      background: rgba(24,26,32,0.55);
    }

    /* ===== ê¸°ì¡´ ê²Œì„ ìŠ¤íƒ€ì¼(í•„ìš”í•œ ë§Œí¼ ìœ ì§€) ===== */
    .game-header { text-align: center; margin-bottom: 10px; }
    .game-header h1 { color: #f3ba2f; margin: 0; font-size: 26px; text-shadow: 2px 2px #cf304a; letter-spacing: 1px; }

    .main-container {
      width: 100%;
      max-width: 1600px;
      margin: 0 auto;
      background: #0b0e11;
      border: 1px solid #f3ba2f;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 20px 50px rgba(0,0,0,0.8);
    }

    /* âœ… ëª¨ë°”ì¼ì€ ì„¸ë¡œ ìŠ¤íƒ */
    .chart-section{
      display:flex;
      flex-direction: column;
      border-bottom: 2px solid #2b3139;
    }

    #tg-tv-main{
      background:#131722;
      border-bottom: 1px solid #2b3139;
      height: 360px;
    }
    #tg-sub-chart{
      background:#131722;
      height: 260px;
      position: relative;
    }

    .control-section{
      display:flex;
      flex-direction: column; /* í•µì‹¬ */
      gap: 12px;
      padding: 12px;
      background:#181a20;
    }

    .box { background: #0b0e11; border-radius: 8px; border: 1px solid #2b3139; padding: 15px; }

    /* âœ… í˜¸ê°€ì°½(ë¹¨ê°•/ì´ˆë¡) */
    .orderbook{
      font-family: monospace;
    }
    .order-item { display: flex; justify-content: space-between; font-size: 11px; padding: 6px 5px; border-bottom: 1px solid #222; }
    .cancel-btn { color: #848e9c; cursor: pointer; }

    /* âœ… íŠ¸ë ˆì´ë”© ì…ë ¥/ë²„íŠ¼ */
    .trading { display: flex; flex-direction: column; gap: 12px; }
    input{
      background:#1e2329;
      border:1px solid #333;
      color:#fff;
      padding: 12px;
      border-radius: 6px;
      width: 100%;
      box-sizing: border-box;
      font-size: 15px;
    }

    button { cursor:pointer; border:none; border-radius: 6px; font-weight: 900; transition: 0.2s; }
    button:hover { opacity: 0.9; }

    .btn-long { background:#02c076; color:#fff; padding: 16px; font-size: 18px; }
    .btn-short{ background:#cf304a; color:#fff; padding: 16px; font-size: 18px; }
    .btn-exit { background:#fff; color:#000; padding: 14px; width: 100%; margin-top: 10px; font-size: 15px; }
    .btn-refill { background: linear-gradient(180deg, #f3ba2f 0%, #d9a522 100%); color: #000; padding: 10px 14px; font-size: 12px; }

    /* âœ… status(í¬ì§€ì…˜/ì£¼ë¬¸) */
    .status{
      background:#131722;
      border: 1px solid #2b3139;
      border-radius: 8px;
      padding: 12px;
      overflow: hidden;
    }
    .pos-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 8px; border-top: 1px solid #2b3139; padding-top: 8px; }
    .pos-label { font-size: 10px; color: #848e9c; margin-bottom: 2px; }
    .pos-value { font-size: 13px; font-weight: 900; color: #eee; }

    /* âœ… í•µì‹¬: ëª¨ë°”ì¼ì—ì„œ ìˆœì„œ = í˜¸ê°€ì°½ì„ ë¡±/ìˆ ê·¼ì²˜(=trading ìœ„) */
    .orderbook{ order: 1; } /* í˜¸ê°€ì°½ */
    .trading { order: 2; }  /* ì…ë ¥/ë¡±ìˆ */
    .status  { order: 3; }  /* í¬ì§€ì…˜/ì£¼ë¬¸ */

    /* ì¸ì¦ ê²Œì´íŠ¸ */
    #entrance-gate{
      display:none; position:fixed; top:0; left:0; width:100%; height:100%;
      background:rgba(11, 14, 17, 0.98); z-index:10000;
      flex-direction:column; align-items:center; justify-content:center; color:#f3ba2f;
    }
  </style>
</head>

<body>
  <div id="page-scroll">
    <div class="topbar">
      <a href="index.html">â† ëŒì•„ê°€ê¸°</a>
      <div class="pill">ëª¨ë°”ì¼ ì „ìš© ì„¸ë¡œ ë ˆì´ì•„ì›ƒ</div>
    </div>

    <div class="game-header" style="margin-bottom: 12px;">
      <h1>
        <span style="color:#f3ba2f;">BULL vs BEAR : ARENA</span><br>
        <span style="font-size:25px; color:#d1d4dc; font-weight:700; margin-left:8px;">ê°€ìƒ íŠ¸ë ˆì´ë”© ê²Œì„</span>
      </h1>

      <div style="background: rgba(243, 186, 47, 0.1); border: 1px solid rgba(243, 186, 47, 0.3); padding: 12px; border-radius: 10px; text-align:left; font-size: 12px; color: #d1d4dc; line-height: 1.55;">
        <div style="margin-bottom: 10px; border-bottom: 1px dashed rgba(243, 186, 47, 0.2); padding-bottom: 10px;">
          <b style="color:#f3ba2f;">ğŸ’¡ ì œì‘ ì˜ë„:</b> ì‹¤ì „ íˆ¬ì ì „, ì¶©ë¶„í•œ ì—°ìŠµê³¼ ì „ëµ ê²€ì¦ì„ ìœ„í•´ ì œì‘
        </div>
        <b style="color:#f3ba2f;">[ê²Œì„ ê·œì¹™]</b>
        ì‹œë“œ <b>$30,000</b> ì œê³µ | ê°€ê²© ì…ë ¥ ì‹œ <b>ì§€ì •ê°€</b>, ë¹„ìš°ë©´ <b>ì‹œì¥ê°€</b> |
        <span style="color:#cf304a;">ë¹¨ê°„ì„ (LIQ) í„°ì¹˜ ì‹œ ì¦‰ì‹œ ì²­ì‚°</span><br>
        <span style="color:#848e9c; font-size: 11px;">â€» ë¸Œë¼ìš°ì €/ì¿ í‚¤ ë³€ê²½ ì‹œ ë°ì´í„° ì´ˆê¸°í™”</span>
      </div>
    </div>

    <div class="main-container">
      <div class="chart-section">
        <div id="tg-tv-main"></div>
        <div id="tg-sub-chart"></div>
      </div>

      <div class="control-section">

        <!-- âœ… 1) í˜¸ê°€ì°½(ë§¨ ìœ„/ë¡±ìˆ ê·¼ì²˜) -->
        <div class="box orderbook">
          <div id="tg-asks" style="color:#cf304a;"></div>
          <div id="tg-mid-price" style="font-size: 22px; font-weight: 900; margin: 10px 0; color: #f3ba2f; text-align: center;">$0.00</div>
          <div id="tg-bids" style="color:#02c076;"></div>
        </div>

        <!-- âœ… 2) ë¦¬í•„/ì…ë ¥/ë¡±ìˆ -->
        <div class="trading">
          <div style="background: #1e2329; padding: 12px; border-radius: 10px; display: flex; justify-content: space-between; align-items: center; border: 1px solid #333;">
            <div>
              <div style="font-size: 10px; color: #848e9c; font-weight:900;">AVAILABLE CREDITS</div>
              <div id="tg-equity" style="font-size: 20px; font-weight: 900; color: #f3ba2f;">$30,000.00</div>
            </div>
            <button class="btn-refill" onclick="tgRefill()">REFILL âš¡</button>
          </div>

          <input type="number" id="tg-amt" placeholder="ë‹¬ëŸ¬ ì…ë ¥">
          <input type="number" id="tg-lev" placeholder="ë ˆë²„ë¦¬ì§€ ì…ë ¥(1~âˆ)">
          <input type="number" id="tg-limit" placeholder="LIMIT PRICE (MARKET IF EMPTY)">

          <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 10px;">
            <button class="btn-long" onclick="checkUserBeforeGame('long')">LONG(Add)</button>
            <button class="btn-short" onclick="checkUserBeforeGame('short')">SHORT(Add)</button>
          </div>
        </div>

        <!-- âœ… 3) í¬ì§€ì…˜/ì£¼ë¬¸ -->
        <div class="status">
          <div id="tg-no-pos" style="text-align:center; padding: 12px 0; color:#3d4550; font-size: 12px; font-weight:900;">NO ACTIVE POSITION</div>

          <div id="tg-pos-active" style="display:none;">
            <div style="display:flex; justify-content:space-between; align-items:center;">
              <span id="tg-side-badge" style="padding: 2px 8px; border-radius: 3px; font-weight:900; font-size: 12px; color:#fff;"></span>
              <div style="text-align:right;">
                <div class="pos-label">Unrealized P&L</div>
                <div id="tg-pnl-val" style="font-size: 14px; font-weight: 900;"></div>
              </div>
            </div>

            <div id="tg-roe" style="font-size: 18px; font-weight: 900; text-align:center; margin: 6px 0;">0.00%</div>

            <div class="pos-grid">
              <div>
                <div class="pos-label">Qty (BTC)</div>
                <div id="tg-pos-qty" class="pos-value">0.000</div>
              </div>
              <div style="text-align:right;">
                <div class="pos-label">Value (USDT)</div>
                <div id="tg-pos-value" class="pos-value">$0.00</div>
              </div>
              <div>
                <div class="pos-label">Avg. Entry</div>
                <div id="tg-pos-entry" class="pos-value">$0.00</div>
              </div>
              <div style="text-align:right;">
                <div class="pos-label">Liq. Price</div>
                <div id="tg-pos-liq" class="pos-value" style="color:#cf304a;">$0.00</div>
              </div>
            </div>

            <button class="btn-exit" onclick="tgExit()">MARKET EXIT (Full)</button>
          </div>

          <div style="margin-top: 12px; border-top: 1px solid #2b3139; padding-top: 10px;">
            <div style="font-size: 11px; color: #848e9c; font-weight: 900; margin-bottom: 6px;">PENDING ORDERS</div>
            <div id="tg-order-list" style="max-height: 320px; overflow-y:auto; background:#050505; border:1px solid #1a1a1a;"></div>
          </div>
        </div>

      </div>
    </div>
  </div>

  <!-- âœ… ì¸ì¦ ê²Œì´íŠ¸ -->
  <div id="entrance-gate">
    <div style="background:#181a20; padding:34px; border-radius:20px; border:2px solid #f3ba2f; text-align:center; width:320px; box-shadow: 0 10px 50px rgba(0,0,0,0.8); position: relative;">
      <span onclick="closeGate()" style="position:absolute; right:18px; top:12px; cursor:pointer; font-size:28px; color:#848e9c;">&times;</span>
      <img src="https://cryptologos.cc/logos/bitcoin-btc-logo.png?v=025" style="width:46px; margin-bottom:12px;">
      <h2 style="margin:0 0 8px 0; font-size:22px;">ğŸ® ê²Œì„ ì°¸ì—¬ ì¸ì¦</h2>
      <p style="color:#848e9c; font-size:13px; margin-bottom:18px;">ì´ë©”ì¼ì„ í•œ ë²ˆë§Œ ë“±ë¡í•˜ì‹œë©´<br><b>[ë¹„íŠ¸ì½”ì¸ ê²Œì„]</b>ê³¼ <b>[ê°€ê²© ì˜ˆì¸¡ í™•ì¸]</b>ì„<br>ëª¨ë‘ ì´ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>

      <input type="text" id="db-name" placeholder="ì„±í•¨" style="margin-bottom:10px;">
      <input type="email" id="db-email" placeholder="ì´ë©”ì¼ ì£¼ì†Œ" style="margin-bottom:16px;">

      <button onclick="submitToSheet()" id="db-btn" style="padding:14px; width:100%; background:#f3ba2f; border:none; border-radius:10px; color:#000; font-weight:900; cursor:pointer; font-size:16px;">ì¸ì¦í•˜ê³  ë°°íŒ…í•˜ê¸°</button>
      <p onclick="closeGate()" style="margin-top:16px; text-decoration:underline; cursor:pointer; color:#848e9c; font-size:13px;">ê·¸ëƒ¥ êµ¬ê²½ë§Œ í• ë˜ìš” (ì·¨ì†Œ)</p>
    </div>
  </div>

  <script>
    /* iOSê¹Œì§€ pull-to-refresh ì™„í™” (ì»¨í…Œì´ë„ˆ ë§¨ ìœ„ì—ì„œ ì•„ë˜ë¡œ ë‹¹ê¸¸ ë•Œë§Œ ë°©ì§€) */
    (function blockPullToRefresh(){
      const scroller = document.getElementById('page-scroll');
      if (!scroller) return;
      let startY = 0;

      scroller.addEventListener('touchstart', (e) => {
        if (!e.touches || e.touches.length !== 1) return;
        startY = e.touches[0].clientY;
      }, { passive: true });

      scroller.addEventListener('touchmove', (e) => {
        if (!e.touches || e.touches.length !== 1) return;
        const y = e.touches[0].clientY;
        const pullingDown = (y - startY) > 0;
        if (scroller.scrollTop === 0 && pullingDown) e.preventDefault();
      }, { passive: false });
    })();
  </script>

  <script>
    /* TradingView ìœ„ì ¯ */
    new TradingView.widget({
      autosize: true,
      symbol: "BYBIT:BTCUSDT.P",
      interval: "1",
      theme: "dark",
      container_id: "tg-tv-main",
      locale: "kr"
    });
  </script>

  <script>
    /* ì¸ì¦ ê²Œì´íŠ¸ ë¡œì§ */
    (function() {
      let selectedType = "";

      window.closeGate = function() {
        const gate = document.getElementById('entrance-gate');
        if (gate) gate.style.display = 'none';
      };

      window.checkUserBeforeGame = function(type) {
        selectedType = type;

        if (localStorage.getItem('btc_user_done')) {
          if (typeof tgPlace === "function") tgPlace(type);
        } else {
          const gate = document.getElementById('entrance-gate');
          if (gate) gate.style.display = 'flex';
        }
      };

      window.submitToSheet = async function() {
        const name = document.getElementById('db-name').value.trim();
        const email = document.getElementById('db-email').value.trim();
        const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbwgkTuEi-ajNA32Aoatssy5OctS87M0iqfxGJK15_1vKlet7f4A8qB3fkYOL3uq3RJiQw/exec";

        if (!name || !email.includes('@')) {
          alert("ì •ë³´ë¥¼ ì˜¬ë°”ë¥´ê²Œ ì…ë ¥í•´ì£¼ì„¸ìš”.");
          return;
        }

        const btn = document.getElementById('db-btn');
        btn.disabled = true;
        btn.innerText = "ì¸ì¦ ì¤‘...";

        try {
          const formData = new URLSearchParams();
          formData.append("name", name);
          formData.append("email", email);
          formData.append("status", "í†µí•©ì¸ì¦ì™„ë£Œ");
          formData.append("date", new Date().toLocaleString());

          await fetch(WEB_APP_URL, { method: 'POST', mode: 'no-cors', body: formData });

          localStorage.setItem('btc_user_done', 'true');
          localStorage.setItem('registeredName', name);
          localStorage.setItem('registeredEmail', email);

          closeGate();
          alert("ì¸ì¦ ì™„ë£Œ! ì´ì œ ê²Œì„/ì˜ˆì¸¡ì„ ììœ ë¡­ê²Œ ì´ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");

          if (selectedType && typeof tgPlace === "function") tgPlace(selectedType);
        } catch (e) {
          console.error("ì¸ì¦ ì‹¤íŒ¨:", e);
          closeGate();
        } finally {
          btn.disabled = false;
          btn.innerText = "ì¸ì¦í•˜ê³  ë°°íŒ…í•˜ê¸°";
        }
      };
    })();
  </script>

  <script>
    /* ê²Œì„ JS (ë„¤ ê¸°ì¡´ ë¡œì§ ìœ ì§€) */
    (function() {
      const STORAGE_KEY = 'bull_vs_bear_arena_v15_pro';
      let saved = JSON.parse(localStorage.getItem(STORAGE_KEY)) || {};

      let cash = Number(saved.cash !== undefined ? saved.cash : 30000);
      let pos = saved.pos || null;
      let orders = saved.orders || [];
      let btc = 0, candleSeries, lastCandle, entryLine, liqLine, orderLines = {};
      let chart;

      // Lightweight Charts
      chart = LightweightCharts.createChart(document.getElementById('tg-sub-chart'), {
        layout: { backgroundColor: '#131722', textColor: '#d1d4dc' },
        grid: { vertLines: { color: '#1e2329' }, horzLines: { color: '#1e2329' } },
        timeScale: { timeVisible: true, borderColor: '#2b3139' }
      });

      candleSeries = chart.addCandlestickSeries({
        upColor: '#02c076',
        downColor: '#cf304a',
        borderVisible: false,
        wickUpColor: '#02c076',
        wickDownColor: '#cf304a'
      });

      function save() { localStorage.setItem(STORAGE_KEY, JSON.stringify({ cash, pos, orders })); }

      // ë¦¬ì‚¬ì´ì¦ˆ ì‹œ ì°¨íŠ¸ë§Œ ì•ˆì „í•˜ê²Œ ë¦¬ì‚¬ì´ì¦ˆ(ë¬´í•œë£¨í”„ ì—†ìŒ)
      let raf = 0;
      function resizeSubChart(){
        cancelAnimationFrame(raf);
        raf = requestAnimationFrame(() => {
          const el = document.getElementById('tg-sub-chart');
          if (!el || !chart) return;
          const r = el.getBoundingClientRect();
          chart.resize(Math.floor(r.width), Math.floor(r.height));
        });
      }
      window.addEventListener('resize', () => setTimeout(resizeSubChart, 50), { passive: true });
      window.addEventListener('orientationchange', () => setTimeout(resizeSubChart, 120), { passive: true });
      setTimeout(resizeSubChart, 500);

      window.tgRefill = () => {
        if (confirm("Reset account to $30,000?")) {
          cash = 30000; pos = null; orders = []; save(); location.reload();
        }
      };

      const ws = new WebSocket('wss://stream.bybit.com/v5/public/linear');
      ws.onopen = () => ws.send(JSON.stringify({ op: "subscribe", args: ["tickers.BTCUSDT"] }));
      ws.onmessage = (e) => {
        const d = JSON.parse(e.data);
        if (d.data && d.data.lastPrice) {
          btc = parseFloat(d.data.lastPrice);
          document.getElementById('tg-mid-price').innerText = "$" + btc.toLocaleString();

          const min = Math.floor(Date.now() / 60000) * 60;
          if (!lastCandle || lastCandle.time !== min) lastCandle = { time: min, open: btc, high: btc, low: btc, close: btc };
          else {
            lastCandle.high = Math.max(lastCandle.high, btc);
            lastCandle.low = Math.min(lastCandle.low, btc);
            lastCandle.close = btc;
          }
          candleSeries.update(lastCandle);

          checkLiquidation(); checkOrders(); render(); updateOrderBook();
        }
      };

      window.tgPlace = (side) => {
        const marginAmt = Number(document.getElementById('tg-amt').value);
        const lp = Number(document.getElementById('tg-limit').value);
        const lev = Number(document.getElementById('tg-lev').value);

        if (marginAmt <= 0) return alert("ê¸ˆì•¡ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!");
        if (lev <= 0) return alert("ë ˆë²„ë¦¬ì§€ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”!");
        if (cash < marginAmt && (!pos || pos.side !== side)) return alert("Not enough Available Credit!");

        if (!lp) executeTrade(side, btc, marginAmt, lev);
        else {
          orders.push({ id: Date.now(), side, target: lp, amt: marginAmt, lev });
          updateOrderLines(); save();
        }
        document.getElementById('tg-limit').value = "";
      };

      function executeTrade(side, price, marginAmt, lev) {
        if (pos && pos.side !== side) tgExit();
        if (cash >= marginAmt) {
          cash -= marginAmt;
          if (pos && pos.side === side) {
            const currentQty = (pos.amt * pos.lev) / pos.entry;
            const newQty = (marginAmt * lev) / price;
            pos.entry = ((pos.entry * currentQty) + (price * newQty)) / (currentQty + newQty);
            pos.amt += marginAmt;
          } else pos = { side, entry: price, amt: marginAmt, lev };
          updateLines(); render(); save();
        }
      }

      function checkOrders() {
        orders.forEach((o, i) => {
          let hit = (o.side === 'long' && btc <= o.target) || (o.side === 'short' && btc >= o.target);
          if (hit) {
            if (pos && pos.side !== o.side) {
              const closeAmt = Math.min(pos.amt, o.amt);
              const diff = (o.target - pos.entry) / pos.entry * (pos.side === 'short' ? -1 : 1);
              const pnl = closeAmt * diff * pos.lev;

              cash += (closeAmt + pnl);
              pos.amt -= closeAmt;

              if (pos.amt < 1) pos = null;
              alert(`Partial Close Filled at $${o.target.toLocaleString()}`);
            } else executeTrade(o.side, o.target, o.amt, o.lev);

            orders.splice(i, 1);
            updateOrderLines(); updateLines(); render(); save();
          }
        });
      }

      window.tgCancel = (id) => { orders = orders.filter(o => o.id !== id); updateOrderLines(); save(); };

      window.tgExit = () => {
        if (!pos) return;
        const diff = (btc - pos.entry) / pos.entry * (pos.side === 'short' ? -1 : 1);
        const pnl = pos.amt * diff * pos.lev;
        cash += (pos.amt + pnl);
        pos = null;
        updateLines(); render(); save();
      };

      function checkLiquidation() {
        if (!pos) return;
        if ((pos.side === 'long' && btc <= pos.liqPrice) || (pos.side === 'short' && btc >= pos.liqPrice)) {
          pos = null; cash = Math.max(0, cash); save(); updateLines(); render();
          alert("LIQUIDATED - Margin Lost");
        }
      }

      function updateLines() {
        if (entryLine) candleSeries.removePriceLine(entryLine);
        if (liqLine) candleSeries.removePriceLine(liqLine);
        if (pos) {
          const liq = pos.side === 'long' ? pos.entry * (1 - (0.95/pos.lev)) : pos.entry * (1 + (0.95/pos.lev));
          pos.liqPrice = liq;
          entryLine = candleSeries.createPriceLine({ price: pos.entry, color: '#02c076', lineWidth: 2, title: 'ENTRY' });
          liqLine = candleSeries.createPriceLine({ price: liq, color: '#cf304a', lineWidth: 2, title: 'LIQ' });
        }
      }

      function updateOrderLines() {
        for (let id in orderLines) candleSeries.removePriceLine(orderLines[id]);
        orderLines = {}; let html = '';
        orders.sort((a,b) => b.target - a.target).forEach(o => {
          orderLines[o.id] = candleSeries.createPriceLine({ price: o.target, color: '#f3ba2f', lineStyle: 2, title: 'LIMIT' });
          html += `<div class="order-item"><span style="color:${o.side==='long'?'#02c076':'#cf304a'}">${o.side.toUpperCase()} $${o.target.toLocaleString()}</span><span>$${o.amt.toLocaleString()} <b class="cancel-btn" onclick="tgCancel(${o.id})">âœ–</b></span></div>`;
        });
        document.getElementById('tg-order-list').innerHTML = html || '<div style="color:#444;text-align:center;font-size:11px; padding:10px;">No pending orders</div>';
      }

      function updateOrderBook() {
        let a = '', b = '';
        for(let i=11; i>0; i--) a += `<div style="display:flex; justify-content:space-between; opacity:0.6; font-size:11px"><span>${(btc+i*1.2).toFixed(1)}</span><span>${(Math.random()*0.3).toFixed(2)}</span></div>`;
        for(let i=1; i<=11; i++) b += `<div style="display:flex; justify-content:space-between; opacity:0.6; font-size:11px"><span>${(btc-i*1.2).toFixed(1)}</span><span>${(Math.random()*0.3).toFixed(2)}</span></div>`;
        document.getElementById('tg-asks').innerHTML = a;
        document.getElementById('tg-bids').innerHTML = b;
      }

      function render() {
        document.getElementById('tg-equity').innerText = "$" + Math.max(0, cash).toLocaleString(undefined, {minimumFractionDigits:2});
        if (pos) {
          document.getElementById('tg-pos-active').style.display = "block";
          document.getElementById('tg-no-pos').style.display = "none";
          const diff = (btc - pos.entry) / pos.entry * (pos.side === 'short' ? -1 : 1);
          const pnl = pos.amt * diff * pos.lev;
          const roe = diff * pos.lev * 100;
          const qty = (pos.amt * pos.lev) / pos.entry;

          document.getElementById('tg-roe').innerText = (roe>=0?"+":"")+roe.toFixed(2) + "%";
          document.getElementById('tg-roe').style.color = roe>=0?"#02c076":"#cf304a";
          document.getElementById('tg-pnl-val').innerText = (pnl>=0?"+$":"-$")+Math.abs(pnl).toLocaleString(undefined, {minimumFractionDigits:2});
          document.getElementById('tg-pnl-val').style.color = pnl>=0?"#02c076":"#cf304a";
          document.getElementById('tg-side-badge').innerText = pos.side.toUpperCase()+" "+pos.lev+"x";
          document.getElementById('tg-side-badge').style.background = pos.side==='long'?"#02c076":"#cf304a";

          document.getElementById('tg-pos-qty').innerText = qty.toFixed(3);
          document.getElementById('tg-pos-value').innerText = "$" + (pos.amt * pos.lev + pnl).toLocaleString(undefined, {maximumFractionDigits:2});
          document.getElementById('tg-pos-entry').innerText = "$" + pos.entry.toLocaleString();
          document.getElementById('tg-pos-liq').innerText = "$" + pos.liqPrice.toLocaleString(undefined, {maximumFractionDigits:1});
        } else {
          document.getElementById('tg-pos-active').style.display = "none";
          document.getElementById('tg-no-pos').style.display = "block";
        }
      }

      setTimeout(() => { updateLines(); updateOrderLines(); }, 1500);
    })();
  </script>

</body>
</html>


