<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>Game2 â€“ Office Hero Run (Q ì„œë¥˜ / Space ì í”„)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no" />
  <style>
    html,body{margin:0;height:100%;overflow:hidden;font-family:system-ui,-apple-system,BlinkMacSystemFont,sans-serif;background:#87ceeb;}
    canvas{display:block; background:#000;}

    /* âœ… ëª¨ë°”ì¼ì—ì„œ í™”ë©´ ì˜ë¦¼ ë°©ì§€ + ì•ˆì „ì˜ì—­(safe-area) ëŒ€ì‘ */
    body{
      padding-top: env(safe-area-inset-top);
      padding-bottom: env(safe-area-inset-bottom);
      padding-left: env(safe-area-inset-left);
      padding-right: env(safe-area-inset-right);
    }
    canvas#game{
      position: fixed;
      inset: 0;
      width: 100vw;
      height: 100vh;
      touch-action: none; /* ëª¨ë°”ì¼ ìŠ¤í¬ë¡¤/ì¤Œ ë°©ì§€ */
    }

    .hud{
      position:fixed; top:12px; left:12px; z-index:10;
      background:rgba(0,0,0,0.35); color:#fff; padding:10px 12px;
      border-radius:14px; backdrop-filter: blur(6px);
      font-weight:900; font-size:14px; line-height:1.25;
      border:1px solid rgba(255,255,255,0.18);
      user-select:none;
    }
        .btn-restart{
      position:fixed; top:12px; right:12px; z-index:10;
      background:rgba(255,255,255,0.92); color:#000;
      border:none; border-radius:14px; padding:10px 12px;
      font-weight:950; cursor:pointer;
      box-shadow:0 10px 30px rgba(0,0,0,0.18);
    }
    .btn-restart:active{transform:translateY(1px);}
  
    .season-overlay{
      position:fixed; inset:0; z-index:50;
      display:none; align-items:center; justify-content:center;
      background:rgba(0,0,0,0.6);
      backdrop-filter: blur(6px);
      text-align:center;
      padding: 24px;
    }
    .season-card{
      max-width: 720px;
      background: rgba(24,26,32,0.92);
      border: 2px solid rgba(243,186,47,0.55);
      border-radius: 22px;
      padding: 22px 20px;
      box-shadow: 0 20px 70px rgba(0,0,0,0.55);
      color:#fff;
    }
    .season-title{font-size:26px; font-weight:950; color:#f3ba2f; margin:0;}
    .season-sub{margin-top:10px; color:#d1d4dc; font-weight:800; line-height:1.55; font-size:14px;}
    .season-btn{
      margin-top:14px;
      background:#fff; color:#000; border:none;
      border-radius:14px; padding:12px 16px;
      font-weight:950; cursor:pointer;
    }

    /* =============================
       ğŸ“± Mobile Controls (í‚¤ë³´ë“œ ì—†ì´ ì¡°ì‘)
       - ì‘ì€ í™”ë©´(ëª¨ë°”ì¼/íƒœë¸”ë¦¿)ì—ì„œë§Œ í‘œì‹œ
       - ìš”ì²­: í‚¤ í¬ê¸° 45% ì¤„ì„(= ì•½ 55% í¬ê¸°)
       - ë°°ì¹˜: ğŸ“„(ì„œë¥˜) = ì™¼ìª½ ë, ë°©í–¥/ì í”„ = ì˜¤ë¥¸ìª½ ë
       ============================= */
    #mobileControls{
      position: fixed;
      left: calc(env(safe-area-inset-left) + 16px);
      right: calc(env(safe-area-inset-right) + 16px);
      bottom: calc(env(safe-area-inset-bottom) + 10px);
      z-index: 30;
      display: none;
      align-items: flex-end;
      justify-content: space-between;
      user-select: none;
      -webkit-user-select: none;
      touch-action: none;
      pointer-events: auto;
    }
    #mobileControls button{
      width: 38px;             /* âœ… 45% ì •ë„ ì¶•ì†Œ */
      height: 38px;
      border-radius: 9px;
      border: 1px solid rgba(255,255,255,0.22);
      background: rgba(0,0,0,0.42);
      color: #fff;
      font-weight: 950;
      font-size: 13px;
      backdrop-filter: blur(6px);
      box-shadow: 0 10px 26px rgba(0,0,0,0.22);
      padding: 0;
    }
    #mobileControls button:active{ transform: translateY(1px); }

    /* ê³µê²© ë²„íŠ¼(ì„œë¥˜) - ì™¼ìª½ ë */
    #mobileControls .mc-atk{
      width: 44px;
      height: 44px;
      font-size: 15px;
      border-radius: 10px;
      border-color: rgba(243,186,47,0.55);
      box-shadow: 0 14px 34px rgba(0,0,0,0.28);
    }

    /* ë°©í–¥í‚¤(ì˜¤ë¥¸ìª½ ë): ì í”„ ìœ„ + ì¢Œ/ìš° ì•„ë˜ */
    #mobileControls .mc-dpad{
      display:flex;
      flex-direction: column;
      align-items: center;
      gap: 6px;
    }
    #mobileControls .mc-lr{
      display:flex;
      gap: 6px;
    }
    #mobileControls .mc-up{
      width: 38px;
      height: 38px;
      border-radius: 9px;
    }

    /* ì„¸ë¡œ(í¬íŠ¸ë ˆì´íŠ¸) ì•ˆë‚´ ì˜¤ë²„ë ˆì´ */
    .rotate-overlay{
      position: fixed;
      inset: 0;
      z-index: 60;
      display: none;
      align-items: center;
      justify-content: center;
      background: rgba(0,0,0,0.72);
      backdrop-filter: blur(8px);
      padding: 20px;
      text-align: center;
    }
    .rotate-card{
      max-width: 520px;
      background: rgba(24,26,32,0.94);
      border: 2px solid rgba(243,186,47,0.55);
      border-radius: 20px;
      padding: 20px 18px;
      box-shadow: 0 20px 70px rgba(0,0,0,0.55);
      color:#fff;
    }

    @media (max-width: 980px){
      #mobileControls{ display: flex; }
    }

    /* =============================
       â“˜ Help button + panel (ê¸°ë³¸ ìˆ¨ê¹€)
       ============================= */
    #helpBtn{
      position: fixed;
      top: calc(env(safe-area-inset-top) + 8px);
      right: calc(env(safe-area-inset-right) + 10px);
      z-index: 40;
      width: 28px;
      height: 28px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.22);
      background: rgba(0,0,0,0.38);
      color: #fff;
      font-weight: 950;
      font-size: 16px;
      line-height: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0;
      cursor: pointer;
      user-select: none;
      -webkit-user-select: none;
      touch-action: none;
      backdrop-filter: blur(6px);
    }
    #helpPanel{
      position: fixed;
      top: calc(env(safe-area-inset-top) + 44px);
      left: 50%;
      transform: translateX(-50%);
      z-index: 40;
      width: min(360px, 86vw);
      background: rgba(24,26,32,0.92);
      border: 1px solid rgba(255,255,255,0.18);
      border-radius: 14px;
      box-shadow: 0 18px 55px rgba(0,0,0,0.45);
      padding: 10px 12px;
      color: #fff;
      display: none; /* ê¸°ë³¸ ìˆ¨ê¹€ */
      pointer-events: auto;
      backdrop-filter: blur(10px);
    }
    #helpPanel .hp-title{
      font-weight: 950;
      font-size: 12px;
      letter-spacing: 0.2px;
      opacity: 0.95;
    }
    #helpPanel .hp-body{
      margin-top: 6px;
      font-size: 11px;
      line-height: 1.25;
      font-weight: 800;
      opacity: 0.92;
    }

</style>
</head>
<body>

<canvas id="game"></canvas>

<!-- ğŸ“± Mobile Controls: í‚¤ë³´ë“œ ì—†ì–´ë„ í”Œë ˆì´ ê°€ëŠ¥ -->
<div id="mobileControls" aria-label="mobile controls">
  <!-- order: (ì„œë¥˜) (ì™¼ìª½) (ì í”„: ë°©í–¥í‚¤ ìœ„) (ì˜¤ë¥¸ìª½) -->
  <button id="btnAtk" type="button" class="mc-atk" aria-label="attack">ğŸ“„</button>

  <div class="mc-dpad" aria-label="dpad">
    <button id="btnJump" type="button" class="mc-up" aria-label="jump">â¬†</button>
    <div class="mc-lr">
      <button id="btnLeft"  type="button" aria-label="left">â—€</button>
      <button id="btnRight" type="button" aria-label="right">â–¶</button>
    </div>
  </div>
</div>

<!-- ğŸ“± Portrait(ì„¸ë¡œ)ì¼ ë•Œ ê°€ë¡œ ì „í™˜ ì•ˆë‚´ -->
<div id="rotateOverlay" class="rotate-overlay">
  <div class="rotate-card">
    <div style="font-weight:950; font-size:20px;">ê°€ë¡œ ëª¨ë“œë¡œ ëŒë ¤ì£¼ì„¸ìš”</div>
    <div style="margin-top:10px; color:rgba(255,255,255,0.88); font-weight:800; line-height:1.45;">
      ì´ ê²Œì„ì€ ëª¨ë°”ì¼ì—ì„œ <b>ê°€ë¡œ í™”ë©´</b>ì— ìµœì í™”ë˜ì–´ ìˆì–´ìš”.<br/>
      íœ´ëŒ€í°ì„ ì˜†ìœ¼ë¡œ ëŒë¦¬ë©´ ìë™ìœ¼ë¡œ ì‹œì‘ë©ë‹ˆë‹¤.
    </div>
    <div style="margin-top:14px; font-weight:900; opacity:0.9;">â†» Rotate</div>
  </div>
</div>

<div class="season-overlay" id="seasonOverlay">
  <div class="season-card">
    <h2 class="season-title">ğŸ ì‹œì¦Œ 1 ì™„ë£Œ!</h2>
    <div class="season-sub">
      <b>100ë‹¨ê³„</b>ë¥¼ í´ë¦¬ì–´í–ˆìŠµë‹ˆë‹¤.<br/>
      ë‹¤ìŒ ì‹œì¦Œ ì—…ë°ì´íŠ¸ë¥¼ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš” ğŸ™<br/><br/>
      (Restartë¥¼ ëˆ„ë¥´ë©´ 1ë‹¨ê³„ë¶€í„° ë‹¤ì‹œ ì‹œì‘í•©ë‹ˆë‹¤.)
    </div>
    <button class="season-btn" onclick="location.reload()">ğŸ”„ 1ë‹¨ê³„ë¶€í„° ë‹¤ì‹œ</button>
  </div>
</div>
<div class="hud" id="hud">
  <div>ğŸšï¸ ë‹¨ê³„: <span id="levelText">1</span> / 100</div>
  <div>â¤ï¸ ì—ë„ˆì§€: <span id="energyText">8</span></div>
  <div>ğŸª™ ì‚¬í† ì‹œ: <span id="scoreText">0</span></div>
</div>

<button class="btn-restart" onclick="location.reload()">ğŸ”„ Restart</button>

<script>
(() => {
  // =============================
  // ìº”ë²„ìŠ¤
  // =============================
  const canvas = document.getElementById("game");
  const ctx = canvas.getContext("2d");

  // roundRect í´ë¦¬í•„(êµ¬í˜• ë¸Œë¼ìš°ì €)
  if (!CanvasRenderingContext2D.prototype.roundRect) {
    CanvasRenderingContext2D.prototype.roundRect = function(x, y, w, h, r) {
      r = Math.min(r, w/2, h/2);
      this.beginPath();
      this.moveTo(x+r, y);
      this.arcTo(x+w, y, x+w, y+h, r);
      this.arcTo(x+w, y+h, x, y+h, r);
      this.arcTo(x, y+h, x, y, r);
      this.arcTo(x, y, x+w, y, r);
      this.closePath();
      return this;
    };
  }

  
  function resize(){
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
  }
  window.addEventListener("resize", resize);
  resize();

  // =============================
  // ğŸ“± ëª¨ë°”ì¼ì€ ê°€ë¡œ(landscape) ê¶Œì¥/ê°•ì œ íë¦„
  //  - ë¸Œë¼ìš°ì €ê°€ ìë™ íšŒì „ì„ 'ê°•ì œ'í•˜ëŠ” ê±´ ì œí•œì´ ìˆì–´ì„œ,
  //    ì„¸ë¡œ(í¬íŠ¸ë ˆì´íŠ¸)ì¼ ë•ŒëŠ” ì˜¤ë²„ë ˆì´ë¥¼ ë„ìš°ê³  ê²Œì„ ì§„í–‰ì„ ë©ˆì¶¥ë‹ˆë‹¤.
  // =============================
  const rotateOverlay = document.getElementById("rotateOverlay");
  function isSmallScreen(){ return window.matchMedia("(max-width: 980px)").matches; }
  function isPortrait(){ return window.innerHeight > window.innerWidth; }

  function updateRotateOverlay(){
    const needRotate = isSmallScreen() && isPortrait();
    if (rotateOverlay){
      rotateOverlay.style.display = needRotate ? "flex" : "none";
    }
    return !needRotate;
  }

  // ì²« ì‹¤í–‰ + í™”ë©´ íšŒì „/ë¦¬ì‚¬ì´ì¦ˆì— ëŒ€ì‘
  updateRotateOverlay();
  window.addEventListener("orientationchange", updateRotateOverlay);
  window.addEventListener("resize", updateRotateOverlay);

  // ê°€ëŠ¥í•˜ë©´(ì§€ì› ë¸Œë¼ìš°ì €) ê°€ë¡œ ì ê¸ˆ ì‹œë„: ì‹¤íŒ¨í•´ë„ ë¬´ì‹œ
  function tryLockLandscape(){
    try{
      if (screen && screen.orientation && screen.orientation.lock){
        screen.orientation.lock("landscape").catch(()=>{});
      }
    }catch(e){}
  }
  // ì‚¬ìš©ì ì œìŠ¤ì²˜ ë•Œ í•œë²ˆ ë” ì‹œë„(ëª¨ë°”ì¼ì—ì„œ ì„±ê³µ í™•ë¥ â†‘)
  window.addEventListener("pointerdown", tryLockLandscape, { once:true, passive:true });

  const groundH = 90;
  function groundY(){ return canvas.height - groundH; }

  // =============================
  // ì´ë¯¸ì§€ ë¡œë“œ
  // =============================
  const playerImg = new Image();
  playerImg.src = "character.png";

  const enemySrcs = ["enemy1.png","enemy2.png","enemy3.png","enemy4.png","enemy5.png"];
  const enemyImgs = enemySrcs.map(src => {
    const im = new Image();
    im.src = src;
    return im;
  });

  
  // =============================
  // ë°°ê²½ ì´ë¯¸ì§€(3ìŠ¤í…Œì´ì§€)
  // =============================
  const bgImgs = {
    city: new Image(),
    rural: new Image(),
    space: new Image(),
  };
  bgImgs.city.src  = "bg_city.png";
  bgImgs.rural.src = "bg_rural.png";
  bgImgs.space.src = "bg_space.png";

// =============================
// í”„ë¡œì‹œì €ëŸ´(ê·¸ë ¤ì§€ëŠ”) ë°°ê²½ + íŒ¨ëŸ´ë™ìŠ¤(ì…ì²´ê°)
//  - ì´ë¯¸ì§€ ì—†ì–´ë„ ë™ì‘
//  - ì‹œê°„ì´ ì§€ë‚˜ë©´ 'ë„ì‹œ ë‚®â†’ë…¸ì„â†’ë°¤'ì²˜ëŸ¼ ê³„ì† ë³€í•¨
// =============================
function clamp01(v){ return Math.max(0, Math.min(1, v)); }
function lerp(a,b,t){ return a + (b-a)*t; }
function mixColor(c1,c2,t){
  // c: [r,g,b]
  return [
    Math.round(lerp(c1[0],c2[0],t)),
    Math.round(lerp(c1[1],c2[1],t)),
    Math.round(lerp(c1[2],c2[2],t)),
  ];
}
function rgb(c){ return `rgb(${c[0]},${c[1]},${c[2]})`; }

// ê°„ë‹¨ í•´ì‹œ(í•­ìƒ ê°™ì€ ëœë¤ ëŠë‚Œ)
function hash01(n){
  // 0~1
  const x = Math.sin(n * 999.123 + 0.123) * 43758.5453;
  return x - Math.floor(x);
}

function drawParallaxBackground(stage, tSec){
  // stage: city / rural / space (ì ìˆ˜ ê¸°ë°˜)
  // tSec: ì´ˆ ë‹¨ìœ„ ì‹œê°„(ë°°ê²½ ë³€í™”ìš©)

  // --- 1) í•˜ëŠ˜ ê·¸ë¼ë°ì´ì…˜ (ë„ì‹œëŠ” ì‹œê°„ì— ë”°ë¼ ë³€í•¨) ---
  let topA, botA, topB, botB, cycle = 0;

  if (stage === "city"){
    // 0~1 ì£¼ê¸°: ë‚®(0) â†’ ë…¸ì„(0.5) â†’ ë°¤(1)
    cycle = (tSec / 18) % 1; // 18ì´ˆì— í•œ ë²ˆ ì²œì²œíˆ ë³€í™”
    // ë‚® â†’ ë…¸ì„
    const dayTop=[135,206,235], dayBot=[210,240,255];
    const eveTop=[255,170,120], eveBot=[255,220,170];
    const nightTop=[16,22,40],  nightBot=[40,55,90];

    if (cycle < 0.55){
      const tt = clamp01(cycle/0.55);
      topA = mixColor(dayTop, eveTop, tt);
      botA = mixColor(dayBot, eveBot, tt);
    }else{
      const tt = clamp01((cycle-0.55)/0.45);
      topA = mixColor(eveTop, nightTop, tt);
      botA = mixColor(eveBot, nightBot, tt);
    }
  } else if (stage === "rural"){
    topA=[120,200,255]; botA=[220,255,235];
  } else { // space
    topA=[6,10,22]; botA=[25,30,50];
  }

  const g = ctx.createLinearGradient(0, 0, 0, canvas.height);
  g.addColorStop(0, rgb(topA));
  g.addColorStop(1, rgb(botA));
  ctx.fillStyle = g;
  ctx.fillRect(0, 0, canvas.width, canvas.height);

  // --- 2) íƒœì–‘/ë‹¬ ---
  if (stage === "city"){
    const x = canvas.width*0.78;
    const y = canvas.height*0.18;
    if (cycle < 0.78){
      // í•´
      ctx.globalAlpha = 0.55;
      ctx.fillStyle = "rgba(255,240,160,1)";
      ctx.beginPath(); ctx.arc(x, y, 28, 0, Math.PI*2); ctx.fill();
      ctx.globalAlpha = 1;
    }else{
      // ë‹¬
      ctx.globalAlpha = 0.55;
      ctx.fillStyle = "rgba(235,240,255,1)";
      ctx.beginPath(); ctx.arc(x, y, 22, 0, Math.PI*2); ctx.fill();
      // ë‹¬ í¬ë ˆì„¼íŠ¸ ëŠë‚Œ
      ctx.fillStyle = rgb(topA);
      ctx.beginPath(); ctx.arc(x+8, y-4, 20, 0, Math.PI*2); ctx.fill();
      ctx.globalAlpha = 1;
    }
  }

  // --- 3) êµ¬ë¦„(ê°€ì¥ ëŠë¦¬ê²Œ) ---
  if (stage !== "space"){
    const cloudSpeed = scrollSpeed * 0.12;
    const off = -((t * cloudSpeed) % (canvas.width + 260));
    for (let i=0;i<6;i++){
      const cx = off + i*260 + 120;
      const cy = 70 + (i%3)*28;
      ctx.globalAlpha = 0.18;
      ctx.fillStyle = "#fff";
      ctx.beginPath();
      ctx.arc(cx, cy, 22, 0, Math.PI*2);
      ctx.arc(cx+26, cy+6, 18, 0, Math.PI*2);
      ctx.arc(cx-26, cy+8, 16, 0, Math.PI*2);
      ctx.fill();
      ctx.globalAlpha = 1;
    }
  }

  // --- 4) ë¨¼ ë°°ê²½(ìŠ¤ì¹´ì´ë¼ì¸/ì‚°) : ì•„ì£¼ ëŠë¦¬ê²Œ ---
  const farY = stage==="space" ? canvas.height*0.55 : canvas.height*0.58;
  const farSpeed = scrollSpeed * 0.18;
  const segW1 = 70;

  const farBase = (stage==="rural") ? "rgba(60,130,90,0.45)" :
                  (stage==="space") ? "rgba(120,140,180,0.18)" :
                  "rgba(20,30,50,0.25)";
  ctx.fillStyle = farBase;

  const start1 = Math.floor(((t*farSpeed) / segW1));
  const offset1 = -((t*farSpeed) % segW1);

  for (let i=-2;i<Math.ceil(canvas.width/segW1)+4;i++){
    const k = start1 + i;
    const r = hash01(k*3.1 + (stage==="rural"?10: (stage==="space"?20:0)));
    const h = 40 + r*90;
    const x = offset1 + i*segW1;
    ctx.fillRect(x, farY - h, segW1, h);
  }

  // --- 5) ì¤‘ê°„ ë°°ê²½(ê±´ë¬¼/ë‚˜ë¬´) : ì¡°ê¸ˆ ë¹ ë¥´ê²Œ(ì…ì²´ê°) ---
  const midY = stage==="space" ? canvas.height*0.66 : canvas.height*0.72;
  const midSpeed = scrollSpeed * 0.35;
  const segW2 = 56;

  let midCol;
  if (stage==="rural") midCol="rgba(40,105,70,0.65)";
  else if (stage==="space") midCol="rgba(140,160,210,0.22)";
  else{
    // ë„ì‹œëŠ” ì‹œê°„ì— ë”°ë¼ ìƒ‰ ì¡°ê¸ˆ ë³€í•˜ê²Œ
    midCol = (cycle < 0.6) ? "rgba(30,45,70,0.45)" : "rgba(18,22,35,0.55)";
  }
  ctx.fillStyle = midCol;

  const start2 = Math.floor(((t*midSpeed) / segW2));
  const offset2 = -((t*midSpeed) % segW2);

  for (let i=-2;i<Math.ceil(canvas.width/segW2)+4;i++){
    const k = start2 + i;
    const r = hash01(k*7.7 + (stage==="rural"?30:(stage==="space"?40:0)));
    const h = 70 + r*140;
    const x = offset2 + i*segW2;

    // ruralì´ë©´ 'ë‚˜ë¬´' ì‹¤ë£¨ì—£ ëŠë‚Œ
    if (stage==="rural"){
      ctx.beginPath();
      ctx.roundRect(x+10, midY-h*0.35, 12, h*0.35, 6);
      ctx.fill();
      ctx.beginPath();
      ctx.arc(x+16, midY-h*0.45, 26, 0, Math.PI*2);
      ctx.globalAlpha = 0.55;
      ctx.fill();
      ctx.globalAlpha = 1;
    } else {
      // city/space: ê±´ë¬¼
      ctx.fillRect(x, midY - h, segW2, h);
      // ì°½ë¬¸(ì•„ì£¼ ì•½í•˜ê²Œ)
      if (stage==="city" && cycle > 0.7){
        ctx.globalAlpha = 0.12;
        ctx.fillStyle = "rgba(255,220,120,1)";
        for (let w=10; w<segW2-10; w+=12){
          for (let yy=midY-h+12; yy<midY-12; yy+=18){
            if (hash01(k*13 + w + yy) > 0.7) ctx.fillRect(x+w, yy, 6, 10);
          }
        }
        ctx.globalAlpha = 1;
        ctx.fillStyle = midCol;
      }
    }
  }
}

// =============================
// ë„ë¡œ(ì•„ìŠ¤íŒ”íŠ¸) + ë³´ë„ë¸”ëŸ­(ê·¸ë¦¼ìœ¼ë¡œ ì§ì ‘ ê·¸ë¦¬ê¸°)
// =============================
function drawRoadAndSidewalk(stage){
  const gy = groundY();
  const sidewalkH = 22;
  const roadH = groundH - sidewalkH;

  // ë³´ë„(íƒ€ì¼)
  ctx.fillStyle = "rgba(200,205,210,0.92)";
  ctx.fillRect(0, gy, canvas.width, sidewalkH);

  // ë³´ë„ íƒ€ì¼ ë¼ì¸
  ctx.strokeStyle = "rgba(0,0,0,0.18)";
  ctx.lineWidth = 1;
  const tileW = 34, tileH = 11;
  for (let y=gy; y<gy+sidewalkH; y+=tileH){
    ctx.beginPath();
    ctx.moveTo(0, y);
    ctx.lineTo(canvas.width, y);
    ctx.stroke();
  }
  for (let x=0; x<canvas.width; x+=tileW){
    ctx.beginPath();
    ctx.moveTo(x, gy);
    ctx.lineTo(x, gy+sidewalkH);
    ctx.stroke();
  }

  // ì—°ì„(ê²½ê³„ì„ )
  ctx.fillStyle = "rgba(0,0,0,0.25)";
  ctx.fillRect(0, gy+sidewalkH-2, canvas.width, 2);

  // ë„ë¡œ(ì•„ìŠ¤íŒ”íŠ¸)
  ctx.fillStyle = (stage==="space") ? "#1c1f28" : "#2a2f33";
  ctx.fillRect(0, gy+sidewalkH, canvas.width, roadH);

  // ë„ë¡œ í…ìŠ¤ì²˜(ì•Œê°±ì´ ëŠë‚Œ)
  ctx.globalAlpha = 0.08;
  ctx.fillStyle = "#fff";
  for (let i=0;i<220;i++){
    const x = (hash01(i*9.1 + t)*canvas.width) | 0;
    const y = (gy+sidewalkH + hash01(i*3.3 + t*2)*roadH) | 0;
    ctx.fillRect(x, y, 2, 1);
  }
  ctx.globalAlpha = 1;

  // ì°¨ì„ (ì ì„ ) â€” ì‹œê°„ì´ ì§€ë‚˜ë©´ ì›€ì§ì—¬ì„œ â€œë‹¬ë¦¬ëŠ” ëŠë‚Œâ€
  const laneY = gy + sidewalkH + roadH*0.52;
  const dashW = 44, gap = 28;
  const speed = scrollSpeed * 1.0;
  const offset = -((t*speed) % (dashW+gap));

  ctx.fillStyle = "rgba(243,186,47,0.9)";
  for (let x = offset; x < canvas.width + dashW; x += (dashW+gap)){
    ctx.fillRect(x, laneY, dashW, 4);
  }

  // ê°€ì¥ìë¦¬ ë¼ì¸
  ctx.fillStyle = "rgba(255,255,255,0.22)";
  ctx.fillRect(0, gy+sidewalkH+8, canvas.width, 2);
  ctx.fillRect(0, gy+sidewalkH+roadH-10, canvas.width, 2);
}


// =============================
  // ìƒíƒœ
  // =============================
  const hudEnergy = document.getElementById("energyText");
  const hudScore = document.getElementById("scoreText");

  let score = 0;
let energy = 8;


// =============================
// ë‚œì´ë„(ì‹œì¦Œ1): 1ë‹¨ê³„ ~ 100ë‹¨ê³„
//  - ê° ë‹¨ê³„ëŠ” "ì •í•´ì§„ ì‹œê°„"ì„ ë²„í‹°ë©´ ë‹¤ìŒ ë‹¨ê³„ë¡œ ë„˜ì–´ê°‘ë‹ˆë‹¤.
//  - ë§¤ ë‹¨ê³„ ì‹œì‘ ì‹œ 2ì´ˆê°„ ì ê¹ ë©ˆì¶”ê³ , ì¤‘ì•™ì— "Në‹¨ê³„ ì‹œì‘" ë©˜íŠ¸ê°€ ë‚˜ì™”ë‹¤ê°€ ì‚¬ë¼ì§‘ë‹ˆë‹¤.
//  - 100ë‹¨ê³„ ì™„ë£Œ ì‹œ "ë‹¤ìŒ ì‹œì¦Œì„ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”" ì•ˆë‚´(ì‹œì¦Œ ì¢…ë£Œ).
// =============================
const SEASON_MAX = 100;

const hudLevel = document.getElementById("levelText");
let level = 1;

// ë‹¨ê³„ íƒ€ì´ë¨¸
let levelStartedAt = performance.now();
let levelDurationSec = 60;

// ë‹¨ê³„ ì „í™˜ ì—°ì¶œ(ì¼ì‹œì •ì§€/ë©˜íŠ¸)
let levelPauseUntil = 0;      // ì´ ì‹œê°„ ì „ê¹Œì§€ update()ëŠ” ë©ˆì¶¤
let showLevelTextUntil = 0;   // ì´ ì‹œê°„ ì „ê¹Œì§€ "Në‹¨ê³„ ì‹œì‘" ë©˜íŠ¸ í‘œì‹œ

let seasonComplete = false;

// ìœ í‹¸
function clamp(v, a, b){ return Math.max(a, Math.min(b, v)); }
function lerp01(a, b, t){ return a + (b - a) * t; }

// âœ… ìš”êµ¬ì‚¬í•­: 1ë‹¨ê³„ëŠ” 40~90ì´ˆ(ëœë¤), ì´í›„ ë‹¨ê³„ëŠ” ì ì  ì§§ì•„ì§, 100ë‹¨ê³„ëŠ” ë§¤ìš° ì§§ê²Œ
function getLevelDurationSec(lv){
  // âœ… ìš”êµ¬ì‚¬í•­:
  //  - 1ë‹¨ê³„: 40ì´ˆ ê³ ì •
  //  - ëª¨ë“  ë‹¨ê³„: 60ì´ˆ(1ë¶„) ì´ë‚´
  if (lv === 1) return 40;
  return 60;
}

// âœ… ìš”êµ¬ì‚¬í•­: 1ë‹¨ê³„ ì—ë„ˆì§€ 8, ì´í›„ ë‹¨ê³„ë§ˆë‹¤ +1
function getLevelEnergy(lv){
  return 8 + (lv - 1);
}


// ë‹¨ê³„ ì‹œì‘(2ì´ˆ ì •ì§€ + ë©˜íŠ¸ í‘œì‹œ)
function startLevel(lv){
  level = clamp(lv, 1, SEASON_MAX);

  // âœ… ë‹¨ê³„ ì‹œì‘ ì‹œ ì—ë„ˆì§€(ì²´ë ¥) ì„¤ì •
  energy = getLevelEnergy(level);
  if (hudEnergy) hudEnergy.textContent = String(energy);
  levelDurationSec = getLevelDurationSec(level);
  levelStartedAt = performance.now();

  const now = performance.now();
  levelPauseUntil = now + 2000;     // 2ì´ˆ ë©ˆì¶¤
  showLevelTextUntil = now + 1600;  // ë©˜íŠ¸ëŠ” 1.6ì´ˆ ì •ë„ë§Œ

  if (hudLevel) hudLevel.textContent = String(level);
}

// ë‹¨ê³„ -> ë‚œì´ë„ íŒŒë¼ë¯¸í„°(0~1)
function levelT(){ return (level - 1) / (SEASON_MAX - 1); }

function getScrollSpeed(){
  // ë‚œì´ë„(ì´ë™ ì†ë„): 1ë‹¨ê³„ëŠ” ì•„ì£¼ ì²œì²œíˆ, 100ë‹¨ê³„ëŠ” ë¹ ë¥´ê²Œ
  // 3.6 -> 8.2 (ì ì§„ì ìœ¼ë¡œ ì¦ê°€)
  return lerp01(3.6, 8.2, levelT());
}
function getSpawnGap(){
  // ì  ìŠ¤í° ê°„ê²©(ms): ì´ˆë°˜ì€ ë„ë„, í›„ë°˜ìœ¼ë¡œ ê°ˆìˆ˜ë¡ ì´˜ì´˜
  // 2400~3400 -> 520~980
  const min = lerp01(2400, 520, levelT());
  const max = lerp01(3400, 980, levelT());
  return { min, max };
}
function getShotGap(){
  // ì  ê³µê²© ê°„ê²©(ms): ì´ˆë°˜ì€ ë§¤ìš° ëŠë¦¬ê²Œ, í›„ë°˜ì€ ë¹ ë¥´ê²Œ
  // 2600~3600 -> 650~1150
  const min = lerp01(2600, 650, levelT());
  const max = lerp01(3600, 1150, levelT());
  return { min, max };
}
function getEnemyShotSpeed(){
  // íˆ¬ì‚¬ì²´ ì†ë„(px/frame): ì´ˆë°˜ì€ ëŠë¦¬ê²Œ, í›„ë°˜ì€ ë¹ ë¥´ê²Œ
  // 8.5 -> 18.5
  return lerp01(8.5, 18.5, levelT());
}


  // ìë™ ëŸ¬ë„ˆ (í”Œë ˆì´ì–´ëŠ” ê±°ì˜ ì œìë¦¬, ì›”ë“œê°€ ì›€ì§ì´ëŠ” ëŠë‚Œ)
  let scrollSpeed = 4;

  const player = {
    x: 140,
    y: 0,
    w: 72,
    h: 108,
    vx: 0,
    vy: 0,
    onGround: false,
    invuln: 0,     // ë¬´ì  í”„ë ˆì„
    face: 1
  };
  player.y = groundY() - player.h;

  const papers = []; // {x,y,w,h,vx,life}
  const enemies = []; // {x,y,w,h,img,hp,nextShotAt}
  const enemyShots = []; // {x,y,w,h,vx,life}
  const coins = []; // {x,y,r,vy,life}
  const energyDrops = []; // {x,y,r,vy,life}
  const deathFx = []; // {x,y,w,h,img,vy,rot,vr,alpha,life,mode}
  const particles = []; // {x,y,vx,vy,r,life,alpha}

  // ì…ë ¥: Space ì í”„, Q ì„œë¥˜
  const keys = {};

  // =============================
  // ğŸ“± ëª¨ë°”ì¼ ë²„íŠ¼(í‚¤ë³´ë“œ ëŒ€ì²´)
  //  - ì¢Œ/ìš°: ëˆ„ë¥´ëŠ” ë™ì•ˆ ì´ë™
  //  - ì í”„/ê³µê²©: íƒ­(í´ë¦­)
  // =============================
  function bindHold(btn, downFn, upFn){
    if (!btn) return;
    const down = (e)=>{ try{ e.preventDefault(); }catch(_){} downFn && downFn(); };
    const up   = (e)=>{ try{ e.preventDefault(); }catch(_){} upFn && upFn(); };
    btn.addEventListener("pointerdown", down);
    btn.addEventListener("pointerup", up);
    btn.addEventListener("pointercancel", up);
    btn.addEventListener("pointerleave", up);
  }

  const btnLeft  = document.getElementById("btnLeft");
  const btnRight = document.getElementById("btnRight");
  const btnJump  = document.getElementById("btnJump");
  const btnAtk   = document.getElementById("btnAtk");

  // =============================
  // â“˜ Help í† ê¸€ (DOM ë¡œë“œ í›„ ë°”ì¸ë”©)
  // =============================
  window.addEventListener("DOMContentLoaded", () => {
    const helpBtn = document.getElementById("helpBtn");
    const helpPanel = document.getElementById("helpPanel");
    let helpOpen = false;

    function setHelp(open){
      helpOpen = !!open;
      if (!helpPanel) return;
      helpPanel.style.display = helpOpen ? "block" : "none";
      helpPanel.setAttribute("aria-hidden", helpOpen ? "false" : "true");
    }

    if (helpBtn){
      helpBtn.addEventListener("pointerdown", (e)=>{
        try{ e.preventDefault(); }catch(_){}
        setHelp(!helpOpen);
      });
    }

    // íŒ¨ë„ ë°”ê¹¥ í´ë¦­í•˜ë©´ ë‹«ê¸°
    window.addEventListener("pointerdown", (e)=>{
      if (!helpOpen) return;
      const t = e.target;
      if (helpBtn && (t === helpBtn || helpBtn.contains(t))) return;
      if (helpPanel && (t === helpPanel || helpPanel.contains(t))) return;
      setHelp(false);
    }, { passive:true });
  });

  // ì¢Œ/ìš° í™€ë“œ
  bindHold(btnLeft,  ()=>{ keys["ArrowLeft"]  = true;  keys["ArrowRight"] = false; }, ()=>{ keys["ArrowLeft"]  = false; });
  bindHold(btnRight, ()=>{ keys["ArrowRight"] = true;  keys["ArrowLeft"]  = false; }, ()=>{ keys["ArrowRight"] = false; });

  // ì í”„/ê³µê²© íƒ­
  if (btnJump){
    btnJump.addEventListener("pointerdown", (e)=>{ try{ e.preventDefault(); }catch(_){} tryJump(); });
  }
  if (btnAtk){
    btnAtk.addEventListener("pointerdown", (e)=>{ try{ e.preventDefault(); }catch(_){} tryThrowPaper(); });
  }

  window.addEventListener("keydown", (e) => {
    keys[e.code] = true;

    // ìŠ¤í¬ë¡¤ ë°©ì§€(ìŠ¤í˜ì´ìŠ¤)
    if (e.code === "Space") e.preventDefault();

    // ì í”„: Space
    if (e.code === "Space") tryJump();

    // ì„œë¥˜: KeyQ
    if (e.code === "KeyQ") tryThrowPaper();
  }, { passive:false });

  window.addEventListener("keyup", (e) => {
    keys[e.code] = false;
  });

  function tryJump(){
    if (!alive()) return;
    if (player.onGround){
      player.vy = -16;
      player.onGround = false;
    }
  }

  let lastThrowAt = 0;
  const THROW_COOLDOWN = 220; // ms

  function tryThrowPaper(){
    if (!alive()) return;
    const now = performance.now();
    if (now - lastThrowAt < THROW_COOLDOWN) return;
    lastThrowAt = now;

    // ì„œë¥˜ ìƒì„± (í”Œë ˆì´ì–´ê°€ ë°”ë¼ë³´ëŠ” ë°©í–¥ìœ¼ë¡œ)
    const w = 26, h = 16;

    // face: ì˜¤ë¥¸ìª½=1, ì™¼ìª½=-1
    const dir = (player.face === -1 ? -1 : 1);

    // ì‹œì‘ ìœ„ì¹˜: ë°©í–¥ì— ë”°ë¼ ëª¸ ì•ìª½ì—ì„œ ë‚˜ì˜¤ê²Œ
    const x = (dir === 1) ? (player.x + player.w - 4) : (player.x - w + 4);
    const y = player.y + player.h * 0.45;

    // ì†ë„ë„ ë°©í–¥ ë°˜ì˜
    papers.push({ x, y, w, h, vx: 12 * dir, life: 90 });
  }

  function alive(){ return energy > 0; }

  // =============================
  // ìŠ¤í°(ì )
  // =============================
  let nextSpawn = 0;

  function spawnEnemy(){
    const idx = Math.floor(Math.random() * enemyImgs.length);
    const img = enemyImgs[idx];

    const baseW = 92, baseH = 92;
    const scale = 0.95 + Math.random() * 0.25;
    const w = Math.round(baseW * scale);
    const h = Math.round(baseH * scale);

    // ì¢Œ/ìš° ëœë¤ ë“±ì¥
    // side = -1 : left -> right
    // side =  1 : right -> left
    const side = (Math.random() < 0.5) ? 1 : -1;

    const spawnX = (side === 1)
      ? (canvas.width + 80 + Math.random() * 220)
      : (-80 - Math.random() * 220);

    enemies.push({
      x: spawnX,
      y: groundY() - h,
      w, h,
      img,
      hp: 1,

      side,
      vy: 0,
      onGround: true,

      nextShotAt: performance.now() + (() => { const g = getShotGap(); return g.min + Math.random()*(g.max-g.min); })(),
      nextJumpAt: performance.now() + (900 + Math.random()*1400)
    });
  }

  // =============================
  // ì¶©ëŒ(AABB)
  // =============================

  // =============================
  // ì´í™íŠ¸: í­íŒŒ íŒŒí‹°í´ + ì  ë‚ ì•„ê°€ê¸°(í˜ì´ë“œ)
  // =============================
  function spawnExplosion(cx, cy){
    // ì‘ì€ í­ë°œ íŒŒí‹°í´ 14~22ê°œ
    const count = 14 + Math.floor(Math.random()*9);
    for (let i=0;i<count;i++){
      const ang = Math.random()*Math.PI*2;
      const spd = 2.5 + Math.random()*5.2;
      particles.push({
        x: cx + (Math.random()*8 - 4),
        y: cy + (Math.random()*8 - 4),
        vx: Math.cos(ang)*spd,
        vy: Math.sin(ang)*spd - (1.2 + Math.random()*1.6),
        r: 2 + Math.random()*3.2,
        life: 26 + Math.floor(Math.random()*18), // í”„ë ˆì„
        alpha: 1
      });
    }
  }

  function spawnEnemyDeathEffect(e){
    // 50%: í­íŒŒ / 50%: í•˜ëŠ˜ë¡œ ë‚ ì•„ê°
    const mode = (Math.random() < 0.5) ? "boom" : "fly";

    const cx = e.x + e.w*0.5;
    const cy = e.y + e.h*0.45;

    if (mode === "boom"){
      spawnExplosion(cx, cy);
      // í­íŒŒ ëŠë‚Œìœ¼ë¡œ ì ë„ ì‚´ì§ ìœ„ë¡œ íŠ•ê¸°ë©° ì‚¬ë¼ì§€ê¸°
      deathFx.push({
        x: e.x, y: e.y, w: e.w, h: e.h, img: e.img,
        vy: -(6 + Math.random()*4),
        rot: 0,
        vr: (Math.random()*0.24 + 0.12) * (Math.random()<0.5?-1:1),
        alpha: 1,
        life: 28,
        mode
      });
    } else {
      // í•˜ëŠ˜ë¡œ ë‚ ì•„ê°€ë©° íšŒì „/í˜ì´ë“œ
      deathFx.push({
        x: e.x, y: e.y, w: e.w, h: e.h, img: e.img,
        vy: -(10 + Math.random()*6),
        rot: 0,
        vr: (Math.random()*0.20 + 0.10) * (Math.random()<0.5?-1:1),
        alpha: 1,
        life: 46,
        mode
      });
    }
  }
  function aabb(a,b){
    return a.x < b.x + b.w &&
           a.x + a.w > b.x &&
           a.y < b.y + b.h &&
           a.y + a.h > b.y;
  }

  // =============================
  // ì—…ë°ì´íŠ¸
  // =============================
  function update(){
    const now = performance.now();

    // ëª¨ë°”ì¼ ì„¸ë¡œ ëª¨ë“œë©´ ì§„í–‰ ì¤‘ì§€(ê°€ë¡œë¡œ ëŒë¦¬ë©´ ìë™ ì¬ê°œ)
    if (!updateRotateOverlay()) return;

    // ì‹œì¦Œ í´ë¦¬ì–´ë©´ ë” ì´ìƒ ì§„í–‰/ìŠ¤í° ì—†ìŒ
    if (seasonComplete) return;

    // âœ… ë‹¨ê³„ ì‹œì‘ ì—°ì¶œ: 2ì´ˆ ë™ì•ˆ ê²Œì„ì„ ì ê¹ ë©ˆì¶¤
    if (now < levelPauseUntil) return;

    // âœ… ë‹¨ê³„ ì‹œê°„ ì¢…ë£Œ â†’ ë‹¤ìŒ ë‹¨ê³„ë¡œ
    const elapsedSec = (now - levelStartedAt) / 1000;
    if (elapsedSec >= levelDurationSec){
      if (level < SEASON_MAX){
        startLevel(level + 1);
      } else {
        seasonComplete = true;
        try{ document.getElementById("seasonOverlay").style.display = "flex"; }catch(e){}
      }
      return;
    }


    // =============================
    // ì´í™íŠ¸ ì—…ë°ì´íŠ¸(íŒŒí‹°í´/ì£½ìŒ ì—°ì¶œ)
    // =============================
    for (let i = particles.length - 1; i >= 0; i--){
      const p = particles[i];
      p.vy += 0.28;
      p.x += p.vx;
      p.y += p.vy;
      p.life--;
      p.alpha = Math.max(0, p.life / 36);
      // ì•½ê°„ ê°ì†
      p.vx *= 0.96;
      p.vy *= 0.98;
      if (p.life <= 0) particles.splice(i,1);
    }

    for (let i = deathFx.length - 1; i >= 0; i--){
      const d = deathFx[i];
      d.vy += 0.30;
      d.y += d.vy;
      d.rot += d.vr;
      d.life--;
      d.alpha = Math.max(0, d.life / (d.mode === "fly" ? 46 : 28));
      if (d.life <= 0) deathFx.splice(i,1);
    }

    // HUD(í˜¹ì‹œë¼ë„)
    if (hudLevel) hudLevel.textContent = String(level);

    // ë‹¨ê³„ì— ë”°ë¼ ì›”ë“œ ì†ë„ ì ìš©

    scrollSpeed = getScrollSpeed();
    // =============================
    // ì¢Œ / ìš° ì´ë™ (â† â†’ ë˜ëŠ” A / D)
    // =============================
    const MOVE_SPEED = 6;
    if (keys["ArrowLeft"] || keys["KeyA"]) {
      player.vx = -MOVE_SPEED;
      player.face = -1;
    } else if (keys["ArrowRight"] || keys["KeyD"]) {
      player.vx = MOVE_SPEED;
      player.face = 1;
    } else {
      player.vx = 0;
    }
    player.x += player.vx;
    // í™”ë©´ ë°–ìœ¼ë¡œ ëª» ë‚˜ê°€ê²Œ
    player.x = Math.max(0, Math.min(canvas.width - player.w, player.x));

    // ì¤‘ë ¥
    player.vy += 0.85;
    player.y += player.vy;

    // ë°”ë‹¥
    const gy = groundY();
    if (player.y + player.h >= gy){
      player.y = gy - player.h;
      player.vy = 0;
      player.onGround = true;
    }

    if (player.invuln > 0) player.invuln--;

    // ì„œë¥˜ ì´ë™
    for (let i = papers.length - 1; i >= 0; i--){
      const p = papers[i];
      p.x += p.vx;
      p.life--;

      // í™”ë©´ ë°– / ìˆ˜ëª… ë (ì¢Œ/ìš° ëª¨ë‘ ëŒ€ì‘)
      if (p.x > canvas.width + 200 || (p.x + p.w) < -200 || p.life <= 0){
        papers.splice(i,1);
      }
    }

    
    // ì  íˆ¬ì‚¬ì²´(ì´ì•Œ/ëŒ) ì´ë™
    for (let i = enemyShots.length - 1; i >= 0; i--){
      const s = enemyShots[i];
      s.x += s.vx;
      s.life--;

      // í”Œë ˆì´ì–´ì™€ ì¶©ëŒ -> ì—ë„ˆì§€ ê°ì†Œ
      if (alive() && player.invuln === 0 && aabb(player, s)){
        energy = Math.max(0, energy - 1);
        player.invuln = 70; // ì•½ 1ì´ˆ ë¬´ì 
        // ì‚´ì§ íŠ•ê¸°ê¸°
        player.vy = -10;
        player.onGround = false;
        enemyShots.splice(i,1);
        continue;
      }

      // í™”ë©´ ë°– / ìˆ˜ëª… ë
      if ((s.vx < 0 && (s.x + s.w) < -160) || (s.vx > 0 && s.x > canvas.width + 160) || s.life <= 0){
        enemyShots.splice(i,1);
      }
    }

// ì  ìŠ¤í° íƒ€ì´ë° (ë‹¨ê³„ê°€ ì˜¬ë¼ê°ˆìˆ˜ë¡ ë” ìì£¼)
    if (performance.now() > nextSpawn && alive()){
      spawnEnemy();
      const g = getSpawnGap();
      nextSpawn = performance.now() + (g.min + Math.random() * (g.max - g.min));
    }

    // ì  ì´ë™
    for (let i = enemies.length - 1; i >= 0; i--){
      const e = enemies[i];

      // ì¢Œ/ìš° ëª¨ë‘ì—ì„œ ì´ë™
      // e.side = 1  -> ì˜¤ë¥¸ìª½ì—ì„œ ì™¼ìª½ìœ¼ë¡œ(ê¸°ì¡´ì²˜ëŸ¼)
      // e.side = -1 -> ì™¼ìª½ì—ì„œ ì˜¤ë¥¸ìª½ìœ¼ë¡œ
      e.x -= scrollSpeed * e.side;

      // ëœë¤ ì í”„(ì •ì  ëŠë‚Œ ì œê±°) - ë‹¨ê³„ê°€ ì˜¬ë¼ê°ˆìˆ˜ë¡ ì¡°ê¸ˆ ë” ìì£¼
      const nowT = performance.now();
      const jt = levelT(); // 0~1
      const jumpChance = 0.10 + jt * 0.18; // 10% ~ 28%
      if (e.onGround && nowT > (e.nextJumpAt || 0) && Math.random() < jumpChance){
        e.vy = -(10 + Math.random() * 5); // ì í”„ ë†’ì´
        e.onGround = false;
        e.nextJumpAt = nowT + (650 + Math.random()*1400); // ë‹¤ìŒ ì í”„ íƒ€ì´ë°
      }

      // ì¤‘ë ¥
      e.vy += 0.85;
      e.y += e.vy;

      // ë°”ë‹¥ ì²˜ë¦¬
      const gy2 = groundY();
      if (e.y + e.h >= gy2){
        e.y = gy2 - e.h;
        e.vy = 0;
        e.onGround = true;
      }

      // ì ì´ ì¼ì • ê°„ê²©ìœ¼ë¡œ í•œ ë°œì”© ë˜ì§(íˆ¬ì‚¬ì²´)
      const nowT2 = performance.now();
      if (alive() && nowT2 > e.nextShotAt && e.x < canvas.width - 120 && e.x > -40){
        const bw = 18, bh = 10;
        const bx = (e.side === 1) ? (e.x - 8) : (e.x + e.w - 10);
        const by = e.y + e.h * 0.55;
        enemyShots.push({
          x: bx, y: by, w: bw, h: bh,
          vx: -(scrollSpeed + getEnemyShotSpeed()) * e.side,
          life: 240
        });
        const g = getShotGap();
        e.nextShotAt = nowT2 + (g.min + Math.random()*(g.max-g.min));
      }

      // í”Œë ˆì´ì–´ì™€ ì¶©ëŒ -> ì—ë„ˆì§€ ê°ì†Œ
      if (alive() && player.invuln === 0 && aabb(player, e)){
        energy = Math.max(0, energy - 1);
        player.invuln = 70; // ì•½ 1ì´ˆ ë¬´ì 
        player.vy = -10;
        player.onGround = false;
      }

      // ì„œë¥˜ì™€ ì¶©ëŒ -> ì  ì œê±° + ì‚¬í† ì‹œ ì½”ì¸ ìƒì„± (+ 10% í™•ë¥  ì—ë„ˆì§€ ë“œë)
      let killed = false;
      for (let j = papers.length - 1; j >= 0; j--){
        const p = papers[j];
        if (aabb(p, e)){
          // âœ… ì£½ëŠ” ì—°ì¶œ(í­íŒŒ or í•˜ëŠ˜ë¡œ ë‚ ì•„ê°)
          spawnEnemyDeathEffect(e);

          // ì œê±°
          enemies.splice(i,1);
          papers.splice(j,1);
          killed = true;

          // âœ… ê¸°ë³¸ ë³´ìƒ: ì‚¬í† ì‹œ 1ê°œ
          coins.push({
            x: e.x + e.w * 0.5,
            y: e.y + e.h * 0.35,
            r: 12,
            vy: -6,
            life: 600
          });

          // âœ… ì¶”ê°€ ë³´ìƒ: 10% í™•ë¥ ë¡œ ì—ë„ˆì§€(í•˜íŠ¸) 1ê°œ ë“œë
          if (Math.random() < 0.10){
            energyDrops.push({
              x: e.x + e.w * 0.5 + (Math.random()*18 - 9),
              y: e.y + e.h * 0.22,
              r: 14,
              vy: -7,
              life: 600
            });
          }
          break;
        }
      }
      if (killed) continue;

      // í™”ë©´ ë°–(ë°©í–¥ë³„ ì œê±°)
      if ((e.side === 1 && (e.x + e.w) < -120) || (e.side === -1 && e.x > canvas.width + 120)){
        enemies.splice(i,1);
      }
    }

    // ì½”ì¸ ë¬¼ë¦¬/íšë“
    for (let i = coins.length - 1; i >= 0; i--){
      const c = coins[i];
      c.vy += 0.45;
      c.y += c.vy;
      c.life--;

      // ë°”ë‹¥ íŠ•ê¹€(í•œ ë²ˆ ëŠë‚Œ)
      const floor = groundY() - 10;
      if (c.y > floor){
        c.y = floor;
        c.vy *= -0.35;
        if (Math.abs(c.vy) < 0.8) c.vy = 0;
      }

      // í”Œë ˆì´ì–´ íšë“ (ì›í˜•-ì‚¬ê°í˜• ê°„ë‹¨ íŒì •)
      const px = player.x + player.w/2;
      const py = player.y + player.h/2;
      const dx = Math.abs(c.x - px);
      const dy = Math.abs(c.y - py);
      if (dx < (player.w/2 + c.r) && dy < (player.h/2 + c.r)){
        score += 1;
        coins.splice(i,1);
        continue;
      }

      // ì˜¤ë˜ë˜ë©´ ì‚¬ë¼ì§
      if (c.life <= 0) coins.splice(i,1);
    }
    // ì—ë„ˆì§€ ë“œë ë¬¼ë¦¬/íšë“ (10% í™•ë¥  ë“œë)
    for (let i = energyDrops.length - 1; i >= 0; i--){
      const h = energyDrops[i];
      h.vy += 0.45;
      h.y += h.vy;
      h.life--;

      // ë°”ë‹¥ íŠ•ê¹€
      const floor = groundY() - 12;
      if (h.y > floor){
        h.y = floor;
        h.vy *= -0.35;
        if (Math.abs(h.vy) < 0.8) h.vy = 0;
      }

      // í”Œë ˆì´ì–´ íšë“
      const px = player.x + player.w/2;
      const py = player.y + player.h/2;
      const dx = Math.abs(h.x - px);
      const dy = Math.abs(h.y - py);
      if (dx < (player.w/2 + h.r) && dy < (player.h/2 + h.r)){
        // ì—ë„ˆì§€ +1 (ìµœëŒ€ì¹˜ëŠ” í˜„ì¬ ë‹¨ê³„ ê¸°ë³¸ ì—ë„ˆì§€ë¡œ ìº¡)
        const cap = getLevelEnergy(level);
        energy = Math.min(cap, energy + 1);
        energyDrops.splice(i,1);
        continue;
      }

      if (h.life <= 0) energyDrops.splice(i,1);
    }


    // HUD
    hudEnergy.textContent = String(energy);
    hudScore.textContent = String(score);
  }

  // =============================
  // ë Œë”
  // =============================
  let t = 0;
  function draw(){
    ctx.clearRect(0,0,canvas.width,canvas.height);

    // =============================
// ë°°ê²½(ì…ì²´ê° íŒ¨ëŸ´ë™ìŠ¤) + ë„ë¡œ/ë³´ë„
// =============================
const stage = (score >= 50) ? "space" : (score >= 20 ? "rural" : "city");
const tSec = performance.now() / 1000;

// (1) ë°°ê²½: ì§ì ‘ ê·¸ë ¤ì„œ ê³„ì† ë³€í™”/ìŠ¤í¬ë¡¤
drawParallaxBackground(stage, tSec);

// (2) ë„ë¡œ/ë³´ë„: ì§ì ‘ ê·¸ë ¤ì„œ 'ê²Œì„ ì™„ì„± ëŠë‚Œ'
drawRoadAndSidewalk(stage);

    // í”Œë ˆì´ì–´ ê·¸ë¦¼ì
    ctx.globalAlpha = 0.25;
    ctx.fillStyle = "#000";
    ctx.beginPath();
    ctx.ellipse(player.x + player.w/2, groundY()+8, 26, 9, 0, 0, Math.PI*2);
    ctx.fill();
    ctx.globalAlpha = 1;

    // í”Œë ˆì´ì–´ (í”¼ê²© ì‹œ ê¹œë¹¡) + ì‚´ì•„ì›€ì§ì„(ìˆ¨ì‰¬ê¸°/ëŸ°ë°”ìš´ìŠ¤/ì í”„ ìŠ¤ì¿¼ì‹œ)
    const blink = (player.invuln > 0) && ((player.invuln % 10) < 5);

    const now = performance.now();
    const breathe = Math.sin(now * 0.005) * 2.5; // ê°€ë§Œíˆ ìˆì–´ë„ ìˆ¨ì‰¬ëŠ” ëŠë‚Œ
    const runBob  = (player.onGround && player.vx !== 0) ? Math.sin(now * 0.02) * 4 : 0;

    // ì í”„ ì¤‘ì´ë©´ ì„¸ë¡œë¡œ ëŠ˜ë¦¬ê³ , ê°€ë¡œë¡œ ì‚´ì§ ì¤„ì´ê¸°(ìŠ¤ì¿¼ì‹œ/ìŠ¤íŠ¸ë ˆì¹˜)
    let scaleX = 1, scaleY = 1;
    if (!player.onGround) { scaleX = 0.95; scaleY = 1.06; }
    else if (player.vx !== 0) { scaleX = 1.02; scaleY = 0.98; }

    // íˆ¬ëª…ë„(í”¼ê²© ê¹œë¹¡)
    if (blink) ctx.globalAlpha = 0.35;

    // ê°€ìš´ë° ê¸°ì¤€ìœ¼ë¡œ ìŠ¤ì¼€ì¼ ì ìš©
    ctx.save();
    const cx = player.x + player.w/2;
    const cy = player.y + player.h/2 + breathe + runBob;

    // ë°©í–¥(ì¢Œ/ìš°)ë„ ë°˜ì˜
    ctx.translate(cx, cy);
    ctx.scale(scaleX * player.face, scaleY);
    ctx.drawImage(playerImg, -player.w/2, -player.h/2, player.w, player.h);
    ctx.restore();

    ctx.globalAlpha = 1;

    // ì„œë¥˜(íˆ¬ì‚¬ì²´)
    for (const p of papers){
      // ì¢…ì´ ë°”íƒ•
      ctx.fillStyle = "#fff";
      ctx.strokeStyle = "rgba(0,0,0,0.35)";
      ctx.lineWidth = 2;
      ctx.beginPath();
      ctx.roundRect(p.x, p.y, p.w, p.h, 4);
      ctx.fill();
      ctx.stroke();

      // í…ìŠ¤íŠ¸ ì¤„(ëŠë‚Œë§Œ)
      ctx.strokeStyle = "rgba(0,0,0,0.2)";
      ctx.lineWidth = 1;
      ctx.beginPath();
      ctx.moveTo(p.x+5, p.y+6); ctx.lineTo(p.x+p.w-5, p.y+6);
      ctx.moveTo(p.x+5, p.y+10); ctx.lineTo(p.x+p.w-10, p.y+10);
      ctx.stroke();
    }

    // ì  íˆ¬ì‚¬ì²´(ì´ì•Œ/ëŒ)
    for (const s of enemyShots){
      ctx.fillStyle = "rgba(255,255,255,0.92)";
      ctx.strokeStyle = "rgba(0,0,0,0.35)";
      ctx.lineWidth = 2;
      ctx.beginPath();
      ctx.roundRect(s.x, s.y, s.w, s.h, 6);
      ctx.fill();
      ctx.stroke();

      ctx.fillStyle = "rgba(207,48,74,0.9)";
      ctx.beginPath();
      ctx.arc(s.x + s.w - 4, s.y + s.h/2, 3, 0, Math.PI*2);
      ctx.fill();
    }


    // ì 
    for (const e of enemies){
      // ê·¸ë¦¼ì
      ctx.globalAlpha = 0.18;
      ctx.fillStyle = "#000";
      ctx.beginPath();
      ctx.ellipse(e.x + e.w/2, groundY()+8, 22, 7, 0, 0, Math.PI*2);
      ctx.fill();
      ctx.globalAlpha = 1;

      // ì´ë¯¸ì§€
      ctx.drawImage(e.img, e.x, e.y, e.w, e.h);
    }


    // ğŸ’¥ í­ë°œ íŒŒí‹°í´
    for (const p of particles){
      ctx.globalAlpha = Math.max(0, p.alpha);
      ctx.fillStyle = "rgba(255,220,120,0.95)";
      ctx.beginPath();
      ctx.arc(p.x, p.y, p.r, 0, Math.PI*2);
      ctx.fill();
    }
    ctx.globalAlpha = 1;

    // ğŸŒ€ ì  ì£½ìŒ ì—°ì¶œ(ë‚ ì•„ê°€ë©°/í­íŒŒ í›„ í˜ì´ë“œ)
    for (const d of deathFx){
      ctx.save();
      ctx.globalAlpha = Math.max(0, d.alpha);

      const cx = d.x + d.w/2;
      const cy = d.y + d.h/2;

      ctx.translate(cx, cy);
      ctx.rotate(d.rot);
      ctx.drawImage(d.img, -d.w/2, -d.h/2, d.w, d.h);

      ctx.restore();
    }
    ctx.globalAlpha = 1;

    // ì—ë„ˆì§€(í•˜íŠ¸) ë“œë
    for (const h of energyDrops){
      // í•˜íŠ¸ ë°°ê²½
      ctx.beginPath();
      ctx.arc(h.x, h.y, h.r, 0, Math.PI*2);
      ctx.fillStyle = "rgba(255,255,255,0.92)";
      ctx.fill();
      ctx.strokeStyle = "rgba(0,0,0,0.25)";
      ctx.lineWidth = 3;
      ctx.stroke();

      // â™¥ ì•„ì´ì½˜
      ctx.fillStyle = "rgba(207,48,74,0.92)";
      ctx.font = "900 16px system-ui, sans-serif";
      ctx.textAlign = "center";
      ctx.textBaseline = "middle";
      ctx.fillText("â™¥", h.x, h.y+0.5);
    }

    // ì½”ì¸(ì‚¬í† ì‹œ)
    for (const c of coins){
      // ì½”ì¸
      ctx.beginPath();
      ctx.arc(c.x, c.y, c.r, 0, Math.PI*2);
      ctx.fillStyle = "#f3ba2f";
      ctx.fill();

      // í…Œë‘ë¦¬
      ctx.strokeStyle = "rgba(0,0,0,0.25)";
      ctx.lineWidth = 3;
      ctx.stroke();

      // â‚¿
      ctx.fillStyle = "rgba(0,0,0,0.65)";
      ctx.font = "900 14px system-ui, sans-serif";
      ctx.textAlign = "center";
      ctx.textBaseline = "middle";
      ctx.fillText("â‚¿", c.x, c.y+0.5);
    }

    
    // ë‹¨ê³„ ì‹œì‘ ë©˜íŠ¸(ì ê¹ í‘œì‹œ)
    const _nowLv = performance.now();
    if (!seasonComplete && alive() && _nowLv < showLevelTextUntil){
      ctx.save();
      ctx.fillStyle = "rgba(0,0,0,0.35)";
      ctx.fillRect(0,0,canvas.width,canvas.height);

      ctx.fillStyle = "#fff";
      ctx.textAlign = "center";
      ctx.textBaseline = "middle";
      ctx.font = "900 44px system-ui, -apple-system, Segoe UI, Roboto, sans-serif";
      ctx.fillText(`${level}ë‹¨ê³„ ì‹œì‘`, canvas.width/2, canvas.height/2);

      ctx.restore();
    }

// ê²Œì„ì˜¤ë²„
    if (!alive()){
      ctx.save();
      ctx.fillStyle = "rgba(0,0,0,0.55)";
      ctx.fillRect(0,0,canvas.width,canvas.height);

      ctx.fillStyle = "#fff";
      ctx.font = "900 44px system-ui, sans-serif";
      ctx.textAlign = "center";
      ctx.textBaseline = "middle";
      ctx.fillText("GAME OVER", canvas.width/2, canvas.height/2 - 20);

      ctx.font = "900 18px system-ui, sans-serif";
      ctx.fillText("ì‚¬í† ì‹œ: " + score + "  |  Restart ë²„íŠ¼ì„ ëˆ„ë¥´ì„¸ìš”", canvas.width/2, canvas.height/2 + 28);
      ctx.restore();
    }
  }

  // =============================
  // ë£¨í”„
  // =============================
  function loop(){
    t += 1;
    if (alive()) update(); // ê²Œì„ì˜¤ë²„ë©´ ë©ˆì¶¤(ê·¸ë¦¬ê¸°ëŠ” ê³„ì†)
    draw();
    requestAnimationFrame(loop);
  }

    // ì‹œì‘: 1ë‹¨ê³„
  startLevel(1);

  loop();
})();
</script>


<!-- â“˜ Help (ê¸°ë³¸ ìˆ¨ê¹€, ë²„íŠ¼ìœ¼ë¡œ í† ê¸€) -->
<button id="helpBtn" type="button" aria-label="help">â“˜</button>
<div id="helpPanel" role="dialog" aria-label="help panel" aria-hidden="true">
  <div class="hp-title">Quick Help</div>
  <div class="hp-body">
    <div><b>PC</b> : â† â†’ ì´ë™ Â· Space ì í”„ Â· Q ì„œë¥˜</div>
    <div style="margin-top:4px;"><b>Mobile</b> : ğŸ“„ ì„œë¥˜ Â· â—€ ì´ë™ Â· â¬† ì í”„ Â· â–¶ ì´ë™</div>
    <div style="margin-top:6px; opacity:0.9;">Tip: ì ì„ ì„œë¥˜ë¡œ ì¡ìœ¼ë©´ ğŸª™ ì‚¬í† ì‹œ ë“œë (10% â™¥ ì—ë„ˆì§€)</div>
  </div>
</div>

</body>
</html>
