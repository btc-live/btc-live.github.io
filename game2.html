<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>Game2 â€“ Office Hero Run (Q ì„œë¥˜ / Space ì í”„)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
  <script>

// =============================
// Desktop-only: place Help below HUD
// =============================
(function(){
  function placeDesktop(){
    if (window.matchMedia("(max-width: 900px)").matches) return;
    const hud = document.getElementById("hud");
    const helpBtn = document.getElementById("helpBtn");
    const helpPanel = document.getElementById("helpPanel");
    if (!hud || !helpBtn || !helpPanel) return;

    const r = hud.getBoundingClientRect();
    // âœ… HUD ì•„ë˜ë¡œ ì¶©ë¶„íˆ ì—¬ìœ ë¥¼ ë‘¬ì„œ ì ˆëŒ€ ê°€ë¦¬ì§€ ì•Šê²Œ
    const top = Math.round(r.bottom + 18);
    helpBtn.style.setProperty('top', top + 'px', 'important');
    helpPanel.style.setProperty('top', (top + 44) + 'px', 'important');
  }
  window.addEventListener("load", ()=>{ placeDesktop(); setTimeout(placeDesktop, 300); setTimeout(placeDesktop, 1200); });
  window.addEventListener("DOMContentLoaded", ()=>{ setTimeout(placeDesktop, 50); });
  window.addEventListener("resize", ()=>{ setTimeout(placeDesktop, 80); });
})();


  // âœ… Device hint for CSS targeting (Android only)
  (function(){
    try{
      var ua = navigator.userAgent || "";
      if (/Android/i.test(ua)) document.documentElement.classList.add("android");
    }catch(_){ }
  })();
</script>
<style>
    html{background:#000;}
    html,body{margin:0;height:100%;overflow:hidden;font-family:system-ui,-apple-system,BlinkMacSystemFont,sans-serif;background:#000;}
    
    /* âœ… Mobile stability: prevent scroll/zoom/back-swipe and text selection */
    html, body{
      overscroll-behavior: none;
      touch-action: none;
      -webkit-user-select: none;
      user-select: none;
      -webkit-tap-highlight-color: transparent;
    }
    #mobileControls, #mobileControls *{
      touch-action: none;
    }

canvas{display:block; background:#000;}

    /* âœ… ëª¨ë°”ì¼ì—ì„œ í™”ë©´ ì˜ë¦¼ ë°©ì§€ + ì•ˆì „ì˜ì—­(safe-area) ëŒ€ì‘ */
    body{
      padding-top: env(safe-area-inset-top);
      padding-bottom: env(safe-area-inset-bottom);
      padding-left: env(safe-area-inset-left);
      padding-right: env(safe-area-inset-right);
    }
    canvas#game{
      position: fixed;
      inset: 0;
      width: 100vw;
      height: 100vh;
      touch-action: none; /* ëª¨ë°”ì¼ ìŠ¤í¬ë¡¤/ì¤Œ ë°©ì§€ */
    }

    .hud{
      position:fixed; top:12px; left:12px; z-index:10;
      background:rgba(0,0,0,0.35); color:#fff; padding:10px 12px;
      border-radius:14px; backdrop-filter: blur(6px);
      font-weight:900; font-size:14px; line-height:1.25;
      border:1px solid rgba(255,255,255,0.18);
      user-select:none;
    }

    /* Mobile: make HUD (scoreboard) smaller so it doesn't cover the screen */
    @media (pointer: coarse) and (max-width: 1366px){
      .hud{
        top:6px !important;
        left:6px !important;
        padding:6px 7px !important;
        border-radius:12px !important;
        font-size:11px !important;
        line-height:1.18 !important;
        max-width: min(260px, 68vw) !important;
      }
      .hud button{
        font-size:10px !important;
        padding:3px 6px !important;
        border-radius:9px !important;
      }
    }

        .btn-restart{
      position:fixed; top:12px; right:12px; z-index:10;
      background:rgba(255,255,255,0.92); color:#000;
      border:none; border-radius:14px; padding:10px 12px;
      font-weight:950; cursor:pointer;
      box-shadow:0 10px 30px rgba(0,0,0,0.18);
    }
    .btn-restart:active{transform:translateY(1px);}

    


.btn-exit{
  position:fixed; top:108px; right:12px; z-index:10;
  background:rgba(255,255,255,0.92); color:#000;
  border:none; border-radius:14px; padding:10px 12px;
  font-weight:950; cursor:pointer;
  box-shadow:0 10px 30px rgba(0,0,0,0.18);
}
.btn-exit:active{transform:translateY(1px);}

.btn-save{
  position:fixed; top:156px; right:12px; z-index:10;
  background:rgba(243,186,47,0.92); color:#111;
  border:none; border-radius:14px; padding:10px 12px;
  font-weight:950; cursor:pointer;
  box-shadow:0 10px 30px rgba(0,0,0,0.18);
}
.btn-save:active{transform:translateY(1px);}

.btn-pause{
      position:fixed; top:60px; right:12px; z-index:10;
      background:rgba(0,0,0,0.55); color:#fff;
      border:1px solid rgba(255,255,255,0.22);
      border-radius:14px; padding:10px 12px;
      font-weight:950; cursor:pointer;
      backdrop-filter: blur(6px);
      box-shadow:0 10px 30px rgba(0,0,0,0.18);
    }
    .btn-pause:active{transform:translateY(1px);}

    /* =============================
       âœ… Right-side UI buttons: unified style (COMPACT -35%)
       ============================= */
    .btn-restart,
    .btn-pause,
    .btn-exit,
    .btn-save,
    #btnSound{
      /* layout */
      min-width: 86px;
      text-align: left;
      display: inline-flex;
      align-items: center;
      justify-content: flex-start;
      gap: 5px;

      /* look */
      border-radius: 9px;
      padding: 6px 8px;
      font-weight: 900;
      font-size: 9px;
      letter-spacing: 0.15px;

      background: rgba(0,0,0,0.55);
      color: #fff;
      border: 1px solid rgba(255,255,255,0.22);
      backdrop-filter: blur(8px);
      box-shadow: 0 6px 18px rgba(0,0,0,0.16);

      cursor: pointer;
      -webkit-tap-highlight-color: transparent;
      user-select: none;
    }
    .btn-restart:active,
    .btn-pause:active,
    .btn-exit:active,
    .btn-save:active,
    #btnSound:active{
      transform: translateY(1px);
    }

    .btn-save{
      background: rgba(243,186,47,0.92);
      color: #111;
      border-color: rgba(0,0,0,0.12);
    }
    .btn-restart{
      background: rgba(255,255,255,0.92);
      color: #111;
      border-color: rgba(0,0,0,0.10);
    }

    /* keep Sound button consistent (it had inline styles) */
    #btnSound{
      z-index: 10; /* same as others */
    }

  
    .season-overlay{
      position:fixed; inset:0; z-index:50;
      display:none; align-items:center; justify-content:center;
      background:rgba(0,0,0,0.6);
      backdrop-filter: blur(6px);
      text-align:center;
      padding: 24px;
    }
    .season-card{
      max-width: 720px;
      background: rgba(24,26,32,0.92);
      border: 2px solid rgba(243,186,47,0.55);
      border-radius: 22px;
      padding: 22px 20px;
      box-shadow: 0 20px 70px rgba(0,0,0,0.55);
      color:#fff;
    }
    .season-title{font-size:26px; font-weight:950; color:#f3ba2f; margin:0;}
    .season-sub{margin-top:10px; color:#d1d4dc; font-weight:800; line-height:1.55; font-size:14px;}
    .season-btn{
      margin-top:14px;
      background:#fff; color:#000; border:none;
      border-radius:14px; padding:12px 16px;
      font-weight:950; cursor:pointer;
    }

    /* =============================
       ğŸ“± Mobile Controls (í‚¤ë³´ë“œ ì—†ì´ ì¡°ì‘)
       - ì‘ì€ í™”ë©´(ëª¨ë°”ì¼/íƒœë¸”ë¦¿)ì—ì„œë§Œ í‘œì‹œ
       - ìš”ì²­: í‚¤ í¬ê¸° 45% ì¤„ì„(= ì•½ 55% í¬ê¸°)
       - ë°°ì¹˜: ğŸ“„(ì„œë¥˜) = ì™¼ìª½ ë, ë°©í–¥/ì í”„ = ì˜¤ë¥¸ìª½ ë
       ============================= */
    #mobileControls{
      position: fixed;
      left: calc(env(safe-area-inset-left) + 32px);
      right: calc(env(safe-area-inset-right) + 32px);
      bottom: calc(env(safe-area-inset-bottom) + 10px);
      z-index: 30;
      display: none;
      align-items: flex-end;
      justify-content: space-between;
      user-select: none;
      -webkit-user-select: none;
      touch-action: none;
      pointer-events: auto;
    }
    #mobileControls button{
      width: 49px;             /* âœ… 45% ì •ë„ ì¶•ì†Œ */
      height: 49px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.22);
      background: rgba(0,0,0,0.42);
      color: #fff;
      font-weight: 950;
      font-size: 17px;
      backdrop-filter: blur(6px);
      box-shadow: 0 10px 26px rgba(0,0,0,0.22);
      padding: 0;
    }
    #mobileControls button:active{ transform: translateY(1px); }

    /* ê³µê²© ë²„íŠ¼(ì„œë¥˜) - ì™¼ìª½ ë */
    #mobileControls .mc-atk{
      width: 57px;
      height: 57px;
      font-size: 20px;
      border-radius: 13px;
      border-color: rgba(243,186,47,0.55);
      box-shadow: 0 14px 34px rgba(0,0,0,0.28);
    }

    /* âœ… D-pad ìŠ¤ì™€ì´í”„ìš© íˆíŠ¸ë°•ìŠ¤ í™•ëŒ€(ì•±ê²Œì„ ëŠë‚Œ) */
    #mobileControls .mc-left{
      padding: 8px 10px;
      border-radius: 16px;
    }
    /* ë°©í–¥í‚¤(ì˜¤ë¥¸ìª½ ë): ì í”„ ìœ„ + ì¢Œ/ìš° ì•„ë˜ */
    #mobileControls .mc-dpad{
      display:flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
    }
    #mobileControls .mc-lr{
      display:flex;
      gap: 8px;
    }
    #mobileControls .mc-up{
      width: 49px;
      height: 49px;
      border-radius: 12px;
    }

    /* ì„¸ë¡œ(í¬íŠ¸ë ˆì´íŠ¸) ì•ˆë‚´ ì˜¤ë²„ë ˆì´ */
    .rotate-overlay{
      position: fixed;
      inset: 0;
      z-index: 60;
      display: none;
      align-items: center;
      justify-content: center;
      background: rgba(0,0,0,0.72);
      backdrop-filter: blur(8px);
      padding: 20px;
      text-align: center;
    }
    .rotate-card{
      max-width: 520px;
      background: rgba(24,26,32,0.94);
      border: 2px solid rgba(243,186,47,0.55);
      border-radius: 20px;
      padding: 20px 18px;
      box-shadow: 0 20px 70px rgba(0,0,0,0.55);
      color:#fff;
    }

    @media (max-width: 980px){
      #mobileControls{ display: flex; }
    }

    /* =============================
       â“˜ Help button + panel (ê¸°ë³¸ ìˆ¨ê¹€)
       ============================= */
    #helpBtn{
      position: fixed;
      /* âœ… Restart(ìš°ì¸¡)ì™€ ê²¹ì¹˜ì§€ ì•Šê²Œ: ì™¼ìª½ + HUD ì•„ë˜ë¡œ ì´ë™ */
      top: calc(env(safe-area-inset-top) + 78px);
      left: calc(env(safe-area-inset-left) + 12px);
      right: auto;
      z-index: 40;
      width: 28px;
      height: 28px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.22);
      background: rgba(0,0,0,0.38);
      color: #fff;
      font-weight: 950;
      font-size: 16px;
      line-height: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0;
      cursor: pointer;
      user-select: none;
      -webkit-user-select: none;
      touch-action: none;
      backdrop-filter: blur(6px);
    }
    #helpPanel{
      position: fixed;
      /* âœ… helpBtn ë°”ë¡œ ì•„ë˜(ì™¼ìª½)ì— ëœ¨ê²Œ */
      top: calc(env(safe-area-inset-top) + 110px);
      left: calc(env(safe-area-inset-left) + 12px);
      transform: none;
      z-index: 40;
      width: min(360px, 86vw);
      background: rgba(24,26,32,0.92);
      border: 1px solid rgba(255,255,255,0.18);
      border-radius: 14px;
      box-shadow: 0 18px 55px rgba(0,0,0,0.45);
      padding: 10px 12px;
      color: #fff;
      display: none; /* ê¸°ë³¸ ìˆ¨ê¹€ */
      pointer-events: auto;
      backdrop-filter: blur(10px);
    }
    #helpPanel .hp-title{
      font-weight: 950;
      font-size: 12px;
      letter-spacing: 0.2px;
      opacity: 0.95;
    }
    #helpPanel .hp-body{
      margin-top: 6px;
      font-size: 11px;
      line-height: 1.25;
      font-weight: 800;
      opacity: 0.92;
    }


    /* âœ… Viewport height stability (mobile only) */
    :root{ --vh: 1vh; }

    /* Desktop: keep classic behavior */
    @media (min-width: 901px){
      body, html { height: 100vh; }
      canvas { height: 100vh; }
    }

    /* Mobile: use stable vh variable (prevents address-bar resize jumps) */
    @media (max-width: 900px){
      body, html { height: calc(var(--vh) * 100); }
      canvas { height: calc(var(--vh) * 100); }
    }


    /* âœ… Fullscreen overlay + exit button */
    #fsOverlay{
      position:fixed; inset:0;
      background:rgba(0,0,0,0.75);
      z-index:9999;
      display:flex; align-items:center; justify-content:center;
      padding:18px;
    }
    #fsOverlay .fs-card{
      width:min(420px, 92vw);
      background:#111;
      border:1px solid rgba(255,255,255,0.15);
      border-radius:16px;
      padding:16px;
      box-shadow:0 10px 40px rgba(0,0,0,0.45);
      color:#fff;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
      text-align:center;
    }
    #fsOverlay .fs-title{ font-weight:900; font-size:18px; margin-bottom:6px; }
    #fsOverlay .fs-desc{ opacity:0.9; font-size:13px; margin-bottom:12px; line-height:1.35; }
    #fsOverlay .fs-hint{ opacity:0.75; font-size:11px; margin-top:10px; line-height:1.35; }
    #btnEnterFS{
      width:100%;
      padding:12px 14px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,0.18);
      background:#f3ba2f;
      color:#111;
      font-weight:900;
      font-size:14px;
      cursor:pointer;
    }
    #btnExitFS{
      pointer-events:auto;

      position:fixed;
      top: calc(env(safe-area-inset-top) + 10px);
      right: calc(env(safe-area-inset-right) + 10px);
      z-index:9998;
      width:44px;
      height:44px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,0.18);
      background:rgba(0,0,0,0.55);
      color:#fff;
      font-size:20px;
      display:none; /* only shown in fullscreen on mobile */
      -webkit-tap-highlight-color: transparent;
      touch-action:none;
    }


    
    /* =============================
       ğŸ¤– Android/Galaxy fix: Exit (â¤«) overlaps Restart in fullscreen
       - Move â¤« to top-left on Android so Restart stays tappable
       ============================= */
    html.android #btnExitFS{
      left: calc(env(safe-area-inset-left) + 10px);
      right: auto;
    }
/* =============================
       ğŸ“± Mobile: shrink right-side UI buttons (Restart / Pause / Main / Sound)
       ============================= */
    @media (max-width: 980px){
      .btn-restart,
      .btn-pause,
      .btn-exit,
      .btn-save,
      #btnSound{
        transform: scale(0.5);
        transform-origin: top right;
      }
    }

    

    @media (max-width: 980px){
      html.android .btn-restart{
        top: 54px; /* below the Pause button cluster, avoids accidental overlap */
      }
      html.android .btn-pause{ top: 10px; }
      html.android .btn-exit{ top: 98px; }
      html.android .btn-save{ top: 146px; }
      html.android #btnSound{ top: 194px; }
    }
/* =============================
       ğŸ“± iPad/Tablet: show on-screen controls (avoid disappearing on iPad)
       - Only for touch devices (pointer: coarse)
       ============================= */
    @media (pointer: coarse) and (max-width: 1366px){
      #mobileControls{ display: flex !important; }
    }


/* =============================
   FIX: Move Quick Help (i) below Scoreboard
   ============================= */
#btnHelp, #btnInfo, .btn-help, .btn-info {
  top: 84px !important;   /* scoreboard ì•„ë˜ë¡œ */
  right: 12px !important;
  z-index: 6 !important;  /* ì ìˆ˜íŒë³´ë‹¤ ì•„ë˜ */
}


/* =============================
   FIX v2: Move Help (â“˜) below HUD scoreboard (correct IDs)
   ============================= */
#helpBtn{
  top: calc(env(safe-area-inset-top) + 170px) !important;
  left: calc(env(safe-area-inset-left) + 12px) !important;
  right: auto !important;
  z-index: 40 !important;
}
#helpPanel{
  top: calc(env(safe-area-inset-top) + 205px) !important;
  left: calc(env(safe-area-inset-left) + 12px) !important;
  right: auto !important;
  z-index: 40 !important;
}


/* =============================
   Right stack menu (collapse)
   ============================= */
#rightMenu{
  position:fixed;
  top:12px; right:12px;
  z-index:50;
  display:flex;
  flex-direction:column;
  gap:8px;
  align-items:flex-end;
}
#menuToggle.right-menu-toggle{
  background:rgba(255,255,255,0.92);
  color:#000;
  border:none;
  border-radius:14px;
  padding:10px 12px;
  font-weight:950;
  cursor:pointer;
  box-shadow:0 10px 30px rgba(0,0,0,0.18);
}
#menuToggle.right-menu-toggle:active{ transform: translateY(1px); }

#rightMenu .right-menu-items{
  display:flex;
  flex-direction:column;
  gap:8px;
  align-items:flex-end;
  overflow:hidden;
  transition: max-height .25s ease, opacity .2s ease;
  max-height: 420px;
  opacity: 1;
}
#rightMenu.collapsed .right-menu-items{
  max-height:0;
  opacity:0;
  pointer-events:none;
}

/* override old fixed positions when buttons live in the menu */
#rightMenu .btn-restart,
#rightMenu .btn-exit,
#rightMenu .btn-save,
#rightMenu .btn-pause,
#rightMenu #btnSound{
  position:static !important;
  top:auto !important;
  right:auto !important;
}


/* =============================
   MOBILE HUD FORCE COMPACT
   (ì•„ì´í°/ì•„ì´íŒ¨ë“œ ê°€ë¡œì—ì„œ widthê°€ 900pxì„ ë„˜ëŠ” ê²½ìš°ê°€ ë§ì•„ì„œ
    max-widthë¥¼ ë„‰ë„‰íˆ + pointer:coarse(í„°ì¹˜) ì¡°ê±´ìœ¼ë¡œ ì ìš©)
   ============================= */
@media (pointer: coarse) and (max-width: 1366px){
  #hud, .hud{
    transform: scale(0.78);
    transform-origin: top left;
    max-width: min(260px, 68vw) !important;
  }
  #hud *, .hud *{
    font-size: 11px !important;
    line-height: 1.18 !important;
  }
  #hud button, .hud button{
    font-size: 10px !important;
    padding: 3px 6px !important;
    border-radius: 9px !important;
  }
}



@media (min-width: 901px){
  }


/* =============================
   âœ… FIX: HUD email row not touching the right edge
   - prevents the email mask + buttons from running into the screen edge on small widths
   ============================= */
.hud{
  max-width: calc(100vw - env(safe-area-inset-left) - env(safe-area-inset-right) - 24px) !important;
  padding-right: 14px !important;
  box-sizing: border-box !important;
}
#hud .hud-email-row{
  display:flex;
  flex-wrap:wrap;
  align-items:center;
  gap:6px;
  max-width:100%;
}
#hud #emailMask{
  display:inline-block;
  max-width: 150px;
  overflow:hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}
#hud .hud-email-row button{
  margin-left: 0 !important; /* inline margin-left overridden */
  white-space: nowrap;
}


/* =============================
   FIX v90: Top-left score+email box scale 90%
   ============================= */
#hud, .hud {
  transform: scale(1);
  transform-origin: top left;
}


/* =============================
   HUD SCALE RULES
   - Desktop: 90%
   - Mobile: 65%
   ============================= */

/* Desktop default */
#hud, .hud {
  transform: scale(0.9);
  transform-origin: top left;
}

/* Mobile override */
@media (max-width: 768px) {
  #hud, .hud {
    transform: scale(0.65) !important;
    transform-origin: top left !important;
  }
}

</style>
</head>
<body>
  <!-- ğŸ“± iOS Auto-Mute Banner (shown only on iPhone/iPad) -->
  <div id="iosMuteBanner"
       style="display:none; position:fixed;
              top:calc(env(safe-area-inset-top) + 10px);
              left:50%; transform:translateX(-50%);
              z-index:1000000;
              max-width:min(640px, 92vw);
              background:rgba(0,0,0,0.78); color:#fff;
              padding:9px 12px; border-radius:14px;
              font-size:12px; font-weight:950; line-height:1.25;
              border:1px solid rgba(255,255,255,0.18);
              -webkit-backdrop-filter: blur(8px);
              backdrop-filter: blur(8px);
              text-align:center;
              pointer-events:auto;">
    ğŸ“± iOS ê¸°ê¸°ì—ì„œëŠ” ì„±ëŠ¥ì„ ìœ„í•´ ì†Œë¦¬ê°€ ìë™ìœ¼ë¡œ êº¼ì¡ŒìŠµë‹ˆë‹¤ (ì›í•˜ë©´ Sound ë²„íŠ¼ìœ¼ë¡œ ì¼¤ ìˆ˜ ìˆì–´ìš”)
  </div>


  <!-- âœ… Mobile Fullscreen UI -->
  <div id="fsOverlay" style="display:none;">
    <div class="fs-card">
      <div class="fs-title">Mobile Fullscreen</div>
      <div class="fs-desc">Tap below to hide the address bar and play more stably.</div>
      <button id="btnEnterFS" type="button">Enter Fullscreen</button>
      <div class="fs-hint">Tip: On iPhone Safari, fullscreen may be limited. For best results, use â€œAdd to Home Screenâ€.</div>
    </div>
  </div>

  <button id="btnExitFS" type="button" title="Exit">â¤«</button>


<canvas id="game"></canvas>

<!-- ğŸ“± Mobile Controls: í‚¤ë³´ë“œ ì—†ì–´ë„ í”Œë ˆì´ ê°€ëŠ¥ -->

<div id="mobileControls" aria-label="mobile controls">
  <!-- LEFT: ì´ë™ -->
  <div class="mc-dpad mc-left" id="dpadZone">
    <div class="mc-lr">
      <button id="btnLeft"  type="button" aria-label="left">â—€</button>
      <button id="btnRight" type="button" aria-label="right">â–¶</button>
    </div>
  </div>

  <!-- RIGHT: ì í”„ + ê³µê²© -->
  <div class="mc-actions mc-right">
    <button id="btnJump" type="button" class="mc-up" aria-label="jump">â¬†</button>
    <button id="btnAtkUp" type="button" class="mc-atk" aria-label="attack-up">â¬†ğŸ“„</button>
    <button id="btnAtk"  type="button" class="mc-atk" aria-label="attack">ğŸ“„</button>
  </div>
</div>


<!-- ğŸ“± Portrait(ì„¸ë¡œ)ì¼ ë•Œ ê°€ë¡œ ì „í™˜ ì•ˆë‚´ -->
<div id="rotateOverlay" class="rotate-overlay">
  <div class="rotate-card">
    <div style="font-weight:950; font-size:20px;">ê°€ë¡œ ëª¨ë“œë¡œ ëŒë ¤ì£¼ì„¸ìš”</div>
    <div style="margin-top:10px; color:rgba(255,255,255,0.88); font-weight:800; line-height:1.45;">
      ì´ ê²Œì„ì€ ëª¨ë°”ì¼ì—ì„œ <b>ê°€ë¡œ í™”ë©´</b>ì— ìµœì í™”ë˜ì–´ ìˆì–´ìš”.<br/>
      íœ´ëŒ€í°ì„ ì˜†ìœ¼ë¡œ ëŒë¦¬ë©´ ìë™ìœ¼ë¡œ ì‹œì‘ë©ë‹ˆë‹¤.
    </div>
    <div style="margin-top:14px; font-weight:900; opacity:0.9;">â†» Rotate</div>
  </div>
</div>

<div class="season-overlay" id="seasonOverlay">
  <div class="season-card">
    <h2 class="season-title">ğŸ ì‹œì¦Œ 1 ì™„ë£Œ!</h2>
    <div class="season-sub">
      <b>100ë‹¨ê³„</b>ë¥¼ í´ë¦¬ì–´í–ˆìŠµë‹ˆë‹¤.<br/>
      ë‹¤ìŒ ì‹œì¦Œ ì—…ë°ì´íŠ¸ë¥¼ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš” ğŸ™<br/><br/>
      (Restartë¥¼ ëˆ„ë¥´ë©´ 1ë‹¨ê³„ë¶€í„° ë‹¤ì‹œ ì‹œì‘í•©ë‹ˆë‹¤.)
    </div>
    <button class="season-btn" onclick="location.reload()">ğŸ”„ 1ë‹¨ê³„ë¶€í„° ë‹¤ì‹œ</button>
  </div>
</div>

<!-- =============================
     âœ‰ï¸ Email Gate (Game2)
     - ìºì‹œê°€ ì—†ì„ ë•Œë§Œ ì…ë ¥
     - ì´ë©”ì¼ = ìœ ì €ì˜ ìœ ì¼í•œ ID
     ============================= -->
<div id="emailGate" style="position:fixed; inset:0; z-index:10000; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,0.72); backdrop-filter: blur(6px); padding:18px;">
  <div style="width:min(440px, 94vw); background:rgba(17,17,17,0.96); border:1px solid rgba(255,255,255,0.16); border-radius:18px; padding:16px; color:#fff; box-shadow:0 16px 60px rgba(0,0,0,0.55); font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;">
    <div style="font-weight:950; font-size:18px; margin-bottom:6px;">ğŸ“© ì´ë©”ì¼ ì…ë ¥</div>
    <div style="opacity:0.9; font-size:13px; line-height:1.45; margin-bottom:12px;">
      ëˆ„ì  ì‚¬í† ì‹œ ì‚¬í† ì‹œë¥¼ ì €ì¥/ë¶ˆëŸ¬ì˜¤ê¸° ìœ„í•´ ì´ë©”ì¼ì´ í•„ìš”í•©ë‹ˆë‹¤.<br/>
      (ìŠ¤íŒ¸ ë°œì†¡ìš©ì´ ì•„ë‹™ë‹ˆë‹¤. <b>ì´ë©”ì¼ = ìœ ì¼í•œ ID</b>)
    </div>
    <input id="emailInput" type="email" inputmode="email" placeholder="example@email.com"
           style="width:100%; box-sizing:border-box; padding:12px 12px; border-radius:14px; border:1px solid rgba(255,255,255,0.18); background:#0c0c0c; color:#fff; font-weight:800; font-size:14px; outline:none;" />
    <button id="emailBtn" type="button"
            style="margin-top:10px; width:100%; padding:12px 14px; border-radius:14px; border:1px solid rgba(255,255,255,0.18); background:#f3ba2f; color:#111; font-weight:950; font-size:14px; cursor:pointer;">
      ì‹œì‘í•˜ê¸°
    </button>
    <button id="emailLaterBtn" type="button"
            style="margin-top:8px; width:100%; padding:10px 14px; border-radius:14px; border:1px solid rgba(255,255,255,0.18); background:rgba(0,0,0,0.35); color:#fff; font-weight:950; font-size:13px; cursor:pointer; display:none;">
      ë‚˜ì¤‘ì— (1ë‹¨ê³„ë¡œ)
    </button>
    <div style="margin-top:10px; opacity:0.75; font-size:11px; line-height:1.45;">
      âœ… ìºì‹œ(localStorage)ê°€ ì‚´ì•„ìˆìœ¼ë©´ ë‹¤ìŒì—” ìë™ìœ¼ë¡œ ì´ë©”ì¼ì„ ì¬ì‚¬ìš©í•©ë‹ˆë‹¤.
    </div>
  </div>
</div>

<div class="hud" id="hud">
  <div>ğŸšï¸ ë‹¨ê³„: <span id="levelText">1</span> / 100</div>
  <div>â¤ï¸ ì—ë„ˆì§€: <span id="energyText">10</span></div>
  <div>ğŸª™ í˜„ì¬ ì‚¬í† ì‹œ: <span id="scoreText">0</span></div>
  <div>ğŸ† ëˆ„ì  ì‚¬í† ì‹œ: <span id="totalText">0</span></div>
  <div style="margin-top:4px; font-size:11px; font-weight:800; opacity:0.85;">ğŸ’¾ ì €ì¥: <span id="saveStatus">-</span></div>
  <div class="hud-email-row" style="margin-top:6px; font-size:11px; font-weight:800; opacity:0.92;">
    ğŸ‘¤ <span id="emailMask">-</span>
    <button id="btnChangeEmail" type="button" style="margin-left:6px; font-size:11px; font-weight:900; border-radius:10px; border:1px solid rgba(255,255,255,0.22); background:rgba(0,0,0,0.35); color:#fff; padding:4px 8px; cursor:pointer;">Change</button>
    <button id="btnReauthEmail" type="button" style="margin-left:6px; font-size:11px; font-weight:900; border-radius:10px; border:1px solid rgba(255,255,255,0.22); background:rgba(0,0,0,0.35); color:#fff; padding:4px 8px; cursor:pointer; display:none;">ì´ë©”ì¼ ì…ë ¥</button>
  </div>
  <div style="margin-top:4px; font-size:8px; font-weight:800; opacity:0.78;">
  í˜„ì¬ ì‚¬í† ì‹œëŠ” ê²Œì„ ì¢…ë£Œ ì‹œ<br>ì´ˆê¸°í™” (ëˆ„ì  ì‚¬í† ì‹œì€ ì €ì¥)
  </div>
</div>



<!-- =============================
     ğŸ”Š Audio (BGM + SFX)
     ============================= -->
<audio id="aud-bgm" preload="metadata" loop playsinline>
  <source src="bgm.m4a" type="audio/mp4">
</audio>
<audio id="aud-coin-recieved" preload="none" playsinline>
  <source src="coin-recieved.m4a" type="audio/mp4">
</audio>
<audio id="aud-dropping-a-coin" preload="none" playsinline>
  <source src="dropping-a-coin.m4a" type="audio/mp4">
</audio>
<audio id="aud-hurt-character" preload="none" playsinline>
  <source src="hurt%20-%20character.m4a" type="audio/mp4">
</audio>
<audio id="aud-hurt-enermy" preload="none" playsinline>
  <source src="hurt-enermy.m4a" type="audio/mp4">
</audio>
<audio id="aud-jump" preload="none" playsinline>
  <source src="jump.m4a" type="audio/mp4">
</audio>
<audio id="aud-shoot" preload="none" playsinline>
  <source src="shoot.m4a" type="audio/mp4">
</audio>

<div id="rightMenu" class="right-menu collapsed">
  <button id="menuToggle" type="button" class="right-menu-toggle">â˜°</button>
  <div class="right-menu-items">
    <button class="btn-restart" onclick="location.reload()">ğŸ”„ Restart</button>
    <button class="btn-pause" id="pauseBtn" type="button">â¸ Pause</button>
    <button class="btn-save" id="btnSave" type="button">ğŸ’¾ ì €ì¥</button>
    <button class="btn-exit" id="btnExitMain" type="button">ğŸ  ë©”ì¸</button>
    <button id="btnSound" type="button">ğŸ”Š Sound</button>
  </div>
</div>
<script>
  // âœ… Right menu toggle (stack menu)
  (function(){
    const menu = document.getElementById("rightMenu");
    const tgl  = document.getElementById("menuToggle");
    if(!menu || !tgl) return;

    // default: collapsed
    const saved = localStorage.getItem("g2_menu_open");
    if(saved === "1") menu.classList.remove("collapsed");

    tgl.addEventListener("click", () => {
      menu.classList.toggle("collapsed");
      localStorage.setItem("g2_menu_open", menu.classList.contains("collapsed") ? "0" : "1");
    });
  })();


  // âœ… Mobile viewport-height stabilizer (prevents "zoom/crop" when touching address bar)
  (function(){
    const mq = window.matchMedia ? window.matchMedia("(max-width: 900px)") : null;
    function setVH(force){
      const isMobile = mq ? mq.matches : (window.innerWidth <= 900);
      if (!isMobile) return; // desktop untouched
      const h = (window.visualViewport && window.visualViewport.height) ? window.visualViewport.height : window.innerHeight;
      const vh = (h * 0.01);
      // ignore tiny jitter unless forced
      const prev = parseFloat(getComputedStyle(document.documentElement).getPropertyValue("--vh")) || 0;
      if (!force && prev && Math.abs(vh - prev) < 0.5) return;
      document.documentElement.style.setProperty("--vh", vh + "px");
    }
    let t = null;
    function schedule(force=false){
      clearTimeout(t);
      t = setTimeout(()=> setVH(force), 120);
    }
    // initial
    setVH(true);
    window.addEventListener("resize", ()=>schedule(false), {passive:true});
    if (window.visualViewport){
      window.visualViewport.addEventListener("resize", ()=>schedule(false), {passive:true});
      window.visualViewport.addEventListener("scroll", ()=>schedule(false), {passive:true});
    }
  })();

  // âœ… Fullscreen helper (mobile stability)
  (function(){
const isMobile = () => (window.matchMedia && window.matchMedia("(max-width: 900px)").matches) || (window.innerWidth <= 900);

    function isStandalone(){
      // iOS Safari A2HS: navigator.standalone === true
      // PWA: display-mode standalone
      return (window.navigator && window.navigator.standalone === true) ||
             (window.matchMedia && window.matchMedia('(display-mode: standalone)').matches);
    }
    const overlay = document.getElementById("fsOverlay");
    const btnEnter = document.getElementById("btnEnterFS");
    const btnExit  = document.getElementById("btnExitFS");

    function inFullscreen(){
      return !!(document.fullscreenElement || document.webkitFullscreenElement);
    }
    async function enterFS(){
      try{
        const el = document.documentElement;
        const req = el.requestFullscreen || el.webkitRequestFullscreen;
        if (req) await req.call(el);
        // Try to lock orientation (may fail silently)
        try{
          if (screen.orientation && screen.orientation.lock) await screen.orientation.lock("landscape");
        }catch(_){}
      }catch(_){}
      syncFSUI();
    }
    function goExit(){
      // âœ… 'ë‚˜ê°€ê¸°' ë™ì‘: ê°€ëŠ¥í•œ ê²½ìš° ë’¤ë¡œê°€ê¸°, ì•„ë‹ˆë©´ index.htmlë¡œ ì´ë™
      try{
        if (history.length > 1) { history.back(); return; }
      }catch(_){}
      try{
        if (document.referrer && document.referrer.length > 0) { location.href = document.referrer; return; }
      }catch(_){}
      location.href = "index.html";
    }

    async function exitFS(){
      try{
        const ex = document.exitFullscreen || document.webkitExitFullscreen;
        if (ex) await ex.call(document);
      }catch(_){}
      // Unlock orientation best-effort
      try{ if (screen.orientation && screen.orientation.unlock) screen.orientation.unlock(); }catch(_){}
      syncFSUI();
    }

    function syncFSUI(){
      const mobile = isMobile();
      const fs = inFullscreen();
      const standalone = isStandalone();

      if (!overlay || !btnExit) return;

      // âœ… í™ˆí™”ë©´ ì•±(A2HS/standalone)ì—ì„œëŠ” Fullscreen ë²„íŠ¼ì´ ë™ì‘í•˜ì§€ ì•ŠëŠ” ê²Œ ì •ìƒ
      //    -> Enter Fullscreen ì•ˆë‚´ëŠ” ìˆ¨ê¸°ê³ , â¤« ë‚˜ê°€ê¸°ë§Œ í•­ìƒ ë…¸ì¶œ
      if (mobile && standalone){
        overlay.style.display = "none";
        btnExit.style.display = "block";
        return;
      }

      // ì¼ë°˜ ëª¨ë°”ì¼ ë¸Œë¼ìš°ì € íƒ­: fullscreen ì§„ì… ì „ì—” ì•ˆë‚´, ì§„ì… í›„ì—” exitë§Œ
      overlay.style.display = (mobile && !fs) ? "flex" : "none";
      btnExit.style.display = (mobile && fs) ? "block" : "none";
    }

    if (btnEnter){
      const _enter = (e)=>{ try{ e.preventDefault(); e.stopPropagation(); }catch(_){} enterFS(); };
      btnEnter.addEventListener("click", _enter, {passive:false});
      btnEnter.addEventListener("pointerdown", _enter, {passive:false});
      btnEnter.addEventListener("touchstart", _enter, {passive:false});
    }
    if (btnExit){
      const _exit = (e)=>{ 
        try{ e.preventDefault(); e.stopPropagation(); }catch(_){}
        if (inFullscreen()) exitFS(); else goExit();
      };
      btnExit.addEventListener("click", _exit, {passive:false});
      btnExit.addEventListener("pointerdown", _exit, {passive:false});
      btnExit.addEventListener("touchstart", _exit, {passive:false});
    }
document.addEventListener("fullscreenchange", syncFSUI);
    document.addEventListener("webkitfullscreenchange", syncFSUI);
    window.addEventListener("resize", syncFSUI, {passive:true});

    // initial
    setTimeout(syncFSUI, 50);
  })();
;



// =============================
// ğŸ  Exit to Main (no confirm)
// =============================
function exitGame(){
  // iOS standaloneì—ì„œëŠ” window.close/history.backì´ ê±°ì˜ ë§‰í˜€ìˆì–´ì„œ
  // ê°€ì¥ ì•ˆì „í•œ ë°©ë²• = ëª…ì‹œì ì¸ í˜ì´ì§€ ì´ë™
  location.href = "index.html";
}

(function(){
  const btn = document.getElementById("btnExitMain");
  if (!btn) return;

  const handler = (e)=>{
    try{ e.preventDefault(); e.stopPropagation(); }catch(_){}
    // âœ… ì‚¬ìš©ì ìš”ì²­: confirm ì œê±°, ê·¸ëƒ¥ ë©”ì¸ìœ¼ë¡œ ì´ë™
    exitGame();
  };

  btn.addEventListener("click", handler, {passive:false});
  btn.addEventListener("pointerdown", handler, {passive:false});
  btn.addEventListener("touchstart", handler, {passive:false});
})();
// âœ… íƒ­/ë¸Œë¼ìš°ì € ë‹«ê¸° ì‹œ: ë¸Œë¼ìš°ì € ê¸°ë³¸ ê²½ê³ (ì»¤ìŠ¤í…€ ë¬¸êµ¬ ë¶ˆê°€) + best-effort ìë™ ì €ì¥
window.addEventListener("beforeunload", (e)=>{
  try{
    if (!window.__TG_SUPPRESS_EXIT_SAVE && typeof _dirty !== "undefined" && _dirty){
      // ì»¤ìŠ¤í…€ ë©”ì‹œì§€ëŠ” ìµœì‹  ë¸Œë¼ìš°ì €ì—ì„œ ë¬´ì‹œë©ë‹ˆë‹¤. (ê¸°ë³¸ ê²½ê³ ë§Œ í‘œì‹œ)
      tgGame2BeaconSave("beforeunload");
      e.preventDefault();
      e.returnValue = "";
      return "";
    }
  }catch(_){ }
});



// =============================
// FIX v2: Auto-place Help button below HUD (scoreboard)
// =============================
(function(){
  function place(){
    const hud = document.getElementById("hud");
    const helpBtn = document.getElementById("helpBtn");
    const helpPanel = document.getElementById("helpPanel");
    if (!hud || !helpBtn || !helpPanel) return;

    const r = hud.getBoundingClientRect();
    const top = Math.round(r.bottom + 10); // HUD ì•„ë˜ 10px
    helpBtn.style.top = top + "px";
    helpPanel.style.top = (top + 32) + "px"; // ë²„íŠ¼ ì•„ë˜ë¡œ
  }
  // DOM ì¤€ë¹„ë˜ë©´ 1íšŒ + ë¦¬ì‚¬ì´ì¦ˆ/íšŒì „ ë•Œ ê°±ì‹ 
  window.addEventListener("load", place);
  window.addEventListener("resize", ()=>{ clearTimeout(window.__tgHelpPlaceT); window.__tgHelpPlaceT=setTimeout(place, 80); }, {passive:true});
  window.addEventListener("orientationchange", ()=>{ setTimeout(place, 120); }, {passive:true});
})();


// =============================
// ğŸ’¾ Manual Save Button
// =============================
(function(){
  const b = document.getElementById("btnSave");
  if (!b) return;

  let lastTapAt = 0;
  async function onTap(e){
    // iOS/ëª¨ë°”ì¼ì—ì„œ touch+pointer+click ì¤‘ë³µ ë°©ì§€
    const now = (performance && performance.now) ? performance.now() : Date.now();
    if (now - lastTapAt < 450) return;
    lastTapAt = now;

    try{ e.preventDefault(); e.stopPropagation(); }catch(_){}
    try{
      if (typeof window.tgGame2ManualSave === "function"){
        const ok = await window.tgGame2ManualSave();
        if (ok) alert("ì €ì¥ ì™„ë£Œ!");
        else alert("ì €ì¥ ì‹¤íŒ¨(ë„¤íŠ¸ì›Œí¬/ê¶Œí•œ ë¬¸ì œ). ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
      }else{
        alert("ì €ì¥ ê¸°ëŠ¥ì´ ì•„ì§ ì¤€ë¹„ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ê²Œì„ì´ ì‹œì‘ëœ ë’¤ ë‹¤ì‹œ ëˆŒëŸ¬ì£¼ì„¸ìš”.");
      }
    }catch(_){
      alert("ì €ì¥ ì‹¤íŒ¨. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
    }
  }

  b.addEventListener("pointerdown", onTap, {passive:false});
  b.addEventListener("touchstart", onTap, {passive:false});
})();


(() => {
  // =============================
  // ìº”ë²„ìŠ¤
  // =============================
  const canvas = document.getElementById("game");
  const ctx = canvas.getContext("2d");

  // âœ… Performance: low-power mode on mobile/touch devices
  const LOW_POWER = (window.matchMedia && window.matchMedia("(pointer:coarse)").matches) || (window.innerWidth <= 980);
  // âœ… iPad (including iPadOS Safari reporting as Mac) detection
  const IS_IPAD = (function(){
    try{
      const ua = navigator.userAgent || "";
      const plat = navigator.platform || "";
      // iPadOS 13+ sometimes reports as Mac; use touch points heuristic
      const isIpadUa = /iPad/i.test(ua) || /iPad/i.test(plat);
      const isIpadOs = (plat === "MacIntel" && navigator.maxTouchPoints && navigator.maxTouchPoints > 1);
      return !!(isIpadUa || isIpadOs);
    }catch(_){ return false; }
  })();

  // âœ… Extra-smooth mode for iPad (slightly more aggressive than generic LOW_POWER)
  const LOW_POWER_STRICT = LOW_POWER || IS_IPAD;
  // reduce background/particles a bit more on very small screens
  const BG_SCALE = LOW_POWER_STRICT ? 0.50 : 1.0;
  // =============================
  // ğŸ”Š Audio Engine
  // =============================
  const TG_AUDIO = (() => {
    const el = {
      bgm: document.getElementById("aud-bgm"),
      coinRecieved: document.getElementById("aud-coin-recieved"),
      dropCoin: document.getElementById("aud-dropping-a-coin"),
      hurtCharacter: document.getElementById("aud-hurt-character"),
      hurtEnemy: document.getElementById("aud-hurt-enermy"),
      jump: document.getElementById("aud-jump"),
      shoot: document.getElementById("aud-shoot"),
    };

    let unlocked = false;
    let muted = false;

    // âœ… ê¸°ë³¸ ë³¼ë¥¨(ì›í•˜ë©´ ì—¬ê¸°ë§Œ ë°”ê¾¸ë©´ ë¨)
    const vol = {
      bgm: 0.22,
      coinRecieved: 0.85,
      dropCoin: 0.55,
      hurtCharacter: 0.85,
      hurtEnemy: 0.75,
      jump: 0.55,
      shoot: 0.55,
    };

    // ê°™ì€ ì†Œë¦¬ê°€ ë„ˆë¬´ ì—°ì†ìœ¼ë¡œ ìš¸ë¦´ ë•Œ ì°¢ì–´ì§€ëŠ” ê±¸ ë°©ì§€(ê°„ë‹¨ ì¿¨ë‹¤ìš´)
    const lastAt = Object.create(null);
    function canPlay(key, ms){
      const now = performance.now();
      const prev = lastAt[key] || 0;
      if (now - prev < ms) return false;
      lastAt[key] = now;
      return true;
    }

    function applyVolumes(){
      for (const [k,a] of Object.entries(el)){
        if (!a) continue;
        a.volume = muted ? 0 : (vol[k] ?? 0.6);
      }
    }

    function safePlay(a){
      if (!a) return;
      try{
        // âœ… ê°„ë‹¨í•œ SFX ìŠ¤ë¡œí‹€(ë„ˆë¬´ ì—°ì†ìœ¼ë¡œ ìš¸ë¦¬ë©´ ëª¨ë°”ì¼ì—ì„œ ëŠê¹€)
        const now = performance.now ? performance.now() : Date.now();
        const last = a._tg_lastPlayTs || 0;
        if (now - last < 60) return; // 60ms ì´ë‚´ ì¤‘ë³µ ì¬ìƒ ë°©ì§€
        a._tg_lastPlayTs = now;

        // preload="none"ì¼ ìˆ˜ ìˆìœ¼ë‹ˆ í•„ìš” ì‹œ ë¡œë“œ
        if (a.readyState === 0) {
          try{ a.load(); }catch(_){}
        }

        // readyStateê°€ ë‚®ì„ ë•ŒëŠ” ë˜ê°ê¸°(seek)ê°€ ì˜¤íˆë ¤ ë¶€ë‹´ -> ê·¸ëƒ¥ play ì‹œë„
        if (a.readyState < 2){
          const p0 = a.play();
          if (p0 && typeof p0.catch === "function") p0.catch(()=>{});
          return;
        }

        // ì¬ìƒ ì¤‘ì´ë©´ pause í›„ ë¦¬ì…‹
        if (!a.paused) {
          a.pause();
        }
        a.currentTime = 0;

        const p = a.play();
        if (p && typeof p.catch === "function") p.catch(()=>{});
      }catch(_){}
    }

    function startBgm(){
      if (!el.bgm || muted) return;
      try{ if (!el.bgm.paused) return; }catch(_){}
      safePlay(el.bgm);
    }

    function pauseBgm(){
      try{ el.bgm && el.bgm.pause(); }catch(_){}
    }

    // âœ… iOS/ëª¨ë°”ì¼ ì •ì±… í•´ì œ: ì²« ì œìŠ¤ì²˜ ë•Œ unlock
    function unlock(){
      if (unlocked) return;
      unlocked = true;

      // âœ… ëª¨ë°”ì¼(íŠ¹íˆ iOS)ì—ì„œ ì—¬ëŸ¬ ì˜¤ë””ì˜¤ë¥¼ í•œêº¼ë²ˆì— play/pause í•˜ë©´ ìˆœê°„ ë ‰ì´ ìƒê¸¸ ìˆ˜ ìˆìŒ
      // => BGM 1ê°œë§Œ ì •ì±… í•´ì œìš©ìœ¼ë¡œ í•œë²ˆ ê±´ë“œë¦¬ê¸°
      try{
        const a = el.bgm;
        if (a){
          const prevVol = a.volume;
          a.volume = 0;
          const p = a.play();
          if (p && typeof p.catch === "function") p.catch(()=>{});
          a.pause();
          a.currentTime = 0;
          a.volume = prevVol;
        }
      }catch(_){}

      applyVolumes();
      startBgm();
    }

    function sfx(name, opt={}){
      if (!unlocked || muted) return;
      const a = el[name];
      if (!a) return;

      // ê¸°ë³¸ ì¿¨ë‹¤ìš´(ms)
      const cd = opt.cooldownMs ?? (
        name === "shoot" ? 90 :
        name === "jump" ? 110 :
        name === "coinRecieved" ? 80 :
        name === "dropCoin" ? 120 :
        name === "hurtCharacter" ? 160 :
        name === "hurtEnemy" ? 120 :
        80
      );
      if (!canPlay(name, cd)) return;

      const prev = a.volume;
      if (typeof opt.volume === "number"){
        a.volume = muted ? 0 : Math.max(0, Math.min(1, opt.volume));
      }
      safePlay(a);
      if (typeof opt.volume === "number") a.volume = prev;
    }

    function setMuted(v){
      muted = !!v;
      applyVolumes();

      if (muted){
        // âœ… ì™„ì „ ìŒì†Œê±°: BGM ì •ì§€ + ëª¨ë“  íš¨ê³¼ìŒë„ ì •ì§€/ë¦¬ì…‹
        pauseBgm();
        try{
          Object.values(el).forEach(a=>{
            if (!a) return;
            a.pause();
            a.currentTime = 0;
          });
        }catch(_){}
      }else{
        // âœ… ìŒì†Œê±° í•´ì œ: ë³¼ë¥¨ ë³µêµ¬ + (unlock ëœ ìƒíƒœë©´) BGM ì¬ê°œ
        applyVolumes();
        if (unlocked) startBgm();
      }
    }

    function toggle(){
      setMuted(!muted);
      return muted;
    }

    // ì²« ì‚¬ìš©ì ì œìŠ¤ì²˜ì—ì„œ unlock
    const unlockOnce = () => unlock();
    window.addEventListener("pointerdown", unlockOnce, {once:true, passive:true});
    window.addEventListener("touchstart", unlockOnce, {once:true, passive:true});
    window.addEventListener("keydown", unlockOnce, {once:true, passive:true});

    return { sfx, toggle, unlock, startBgm, pauseBgm, isMuted: ()=>muted };
  })();

  // =============================
  // ğŸ“± iOS Auto-Mute (iPhone / iPad)
  //  - iOS Safari/iPadOSì—ì„œ ì˜¤ë””ì˜¤ë¡œ ë ‰ì´ ìƒê¸¸ ìˆ˜ ìˆì–´ì„œ ê¸°ë³¸ì€ ìë™ ìŒì†Œê±°
  //  - Android / PCëŠ” ê¸°ì¡´ ê·¸ëŒ€ë¡œ
  //  - ìœ ì €ê°€ ì›í•˜ë©´ ğŸ”Š Sound ë²„íŠ¼ìœ¼ë¡œ ì–¸ì œë“ ì§€ í•´ì œ ê°€ëŠ¥
  // =============================
  (function(){
    try{
      const ua = navigator.userAgent || "";
      const plat = navigator.platform || "";
      // iPadOS 13+ ëŠ” MacIntel ë¡œ ì°íˆëŠ” ê²½ìš°ê°€ ìˆì–´ í„°ì¹˜í¬ì¸íŠ¸ë¡œ ë³´ì •
      const isIOS =
        /iPhone|iPad|iPod/i.test(ua) ||
        (plat === "MacIntel" && navigator.maxTouchPoints && navigator.maxTouchPoints > 1);

      if (!isIOS) return;

      // âœ… ìë™ ìŒì†Œê±° (ì´ë¯¸ muteë©´ ê·¸ëŒ€ë¡œ)
      if (!TG_AUDIO.isMuted()) TG_AUDIO.toggle();

      // âœ… ìƒë‹¨ ì•ˆë‚´ ë©”ì‹œì§€ (3ì´ˆ í›„ ìë™ ì œê±°)
            // âœ… ìƒë‹¨ ì•ˆë‚´ ë°°ë„ˆ í‘œì‹œ (HTMLì— ìˆëŠ” #iosMuteBanner ì‚¬ìš©)
      const banner = document.getElementById("iosMuteBanner");
      if (banner){
        banner.style.display = "block";
        // íƒ­í•˜ë©´ ë‹«ê¸°
        const close = ()=>{ try{ banner.style.display = "none"; }catch(_){} };
        banner.addEventListener("pointerdown", close, {once:true, passive:true});
        banner.addEventListener("touchstart", close, {once:true, passive:true});
        // 6ì´ˆ í›„ ìë™ ë‹«ê¸°
        setTimeout(close, 6000);
      }    }catch(_){}
  })();


  // ğŸ”Š Sound button (once) â€” âœ… ëª¨ë°”ì¼ì—ì„œ 'touch+pointer+click' ì¤‘ë³µ í† ê¸€ ë°©ì§€
  (function(){
    const b = document.getElementById("btnSound");
    if (!b) return;

    const sync = ()=>{ b.textContent = TG_AUDIO.isMuted() ? "ğŸ”‡ Muted" : "ğŸ”Š Sound"; };

    let lastTapAt = 0;
    function onTap(e){
      // ê°™ì€ íƒ­ì´ touchstart/pointerdown/clickë¡œ 2~3ë²ˆ ë“¤ì–´ì˜¤ëŠ” ê²½ìš°ê°€ ë§ì•„ì„œ í•œë²ˆë§Œ ì²˜ë¦¬
      const now = performance.now();
      if (now - lastTapAt < 450) return;
      lastTapAt = now;

      try{ e.preventDefault(); e.stopPropagation(); }catch(_){}
      TG_AUDIO.unlock();   // iOS ì •ì±… í•´ì œ + BGM ì‹œì‘(í•„ìš” ì‹œ)
      TG_AUDIO.toggle();   // mute/unmute
      sync();
    }

    // âœ… í•˜ë‚˜ë§Œ ê±¸ì: pointerdown(ëŒ€ë¶€ë¶„ í™˜ê²½ ì»¤ë²„)
    b.addEventListener("pointerdown", onTap, {passive:false});
    // ë³´ì¡°(êµ¬í˜• iOS): touchstartë§Œ ì§€ì›í•  ë•Œë¥¼ ëŒ€ë¹„í•´ ì¶”ê°€
    b.addEventListener("touchstart", onTap, {passive:false});

    sync();
  })();
;


  // =============================
  // â¸ï¸ Pause / Resume (ì‚¬ìš©ì ë²„íŠ¼)
  // =============================
  let userPaused = false;
  function setPause(paused){
    userPaused = !!paused;
    const btn = document.getElementById("pauseBtn");
    if (btn){
      btn.textContent = userPaused ? "â–¶ Resume" : "â¸ Pause";
    }
  }
  function togglePause(){
    // ì‹œì¦Œ ì™„ë£Œ ì˜¤ë²„ë ˆì´ê°€ ë– ìˆìœ¼ë©´ êµ³ì´ í† ê¸€í•˜ì§€ ì•Šê²Œ
    if (typeof seasonComplete === 'boolean' && seasonComplete) return;
    setPause(!userPaused);
  }
  window.togglePause = togglePause;

  // =============================
  // ğŸ“± ëª¨ë°”ì¼ ì˜ë¦¼ ë°©ì§€: 'ê°€ìƒ í™”ë©´(ë…¼ë¦¬ í•´ìƒë„)'ë¡œ ë Œë”ë§í•´ì„œ ìë™ ì¤Œì•„ì›ƒ
  //  - ê²Œì„ ì¢Œí‘œê³„ëŠ” VIEW_W x VIEW_H
  //  - ì‹¤ì œ í™”ë©´(canvas)ì€ ê¸°ê¸° í¬ê¸°
  //  - draw()ì—ì„œ ctx ë³€í™˜(ìŠ¤ì¼€ì¼/ì˜¤í”„ì…‹)ìœ¼ë¡œ ì „ì²´ê°€ ë³´ì´ê²Œ ì¶œë ¥
  // =============================
  const VIEW_W = 1280;
  const VIEW_H = 720;
  let viewScale = 1;
  let viewOffX = 0;
  let viewOffY = 0;
  function CW(){ return VIEW_W; }
  function CH(){ return VIEW_H; }

  // roundRect í´ë¦¬í•„(êµ¬í˜• ë¸Œë¼ìš°ì €)
  if (!CanvasRenderingContext2D.prototype.roundRect) {
    CanvasRenderingContext2D.prototype.roundRect = function(x, y, w, h, r) {
      r = Math.min(r, w/2, h/2);
      this.beginPath();
      this.moveTo(x+r, y);
      this.arcTo(x+w, y, x+w, y+h, r);
      this.arcTo(x+w, y+h, x, y+h, r);
      this.arcTo(x, y+h, x, y, r);
      this.arcTo(x, y, x+w, y, r);
      this.closePath();
      return this;
    };
  }

  
  
  function getVW(){ return (window.visualViewport && window.visualViewport.width) ? window.visualViewport.width : window.innerWidth; }
  function getVH(){ return (window.visualViewport && window.visualViewport.height) ? window.visualViewport.height : window.innerHeight; }

  function resize(){
    // ëª¨ë°”ì¼ ì£¼ì†Œì°½/íˆ´ë°” ë³€í™”ë¡œ innerHeightê°€ í”ë“¤ë¦¬ëŠ” ë¬¸ì œ ì™„í™”
    // âœ… Lower internal resolution on low-power mobile (keeps size but reduces pixel work)
const dprRaw = window.devicePixelRatio || 1;
// âœ… cap DPR on iPad to reduce GPU/CPU pixel work (keeps CSS size the same)
const dpr = Math.min(dprRaw, IS_IPAD ? 1.5 : 2.0);
// âœ… lower internal resolution a bit more on iPad (tiny quality loss, big smoothness gain)
const q = IS_IPAD ? 0.78 : (LOW_POWER ? 0.85 : 1.0);
canvas.width = Math.round(getVW() * dpr * q);
canvas.height = Math.round(getVH() * dpr * q);
canvas.style.width = Math.round(getVW()) + "px";
canvas.style.height = Math.round(getVH()) + "px";

    const sx = canvas.width  / VIEW_W;
    const sy = canvas.height / VIEW_H;
    viewScale = Math.min(sx, sy);
    viewOffX = Math.round((canvas.width  - VIEW_W * viewScale) / 2);
    viewOffY = Math.round((canvas.height - VIEW_H * viewScale) / 2);
  }

  // âœ… resize ë””ë°”ìš´ìŠ¤(ì—°ì† í˜¸ì¶œë¡œ í”ë“¤ë¦¼/ë ‰ ë°©ì§€)
  let _rzTimer = null;
  function requestResize(){
    clearTimeout(_rzTimer);
    _rzTimer = setTimeout(resize, 150);
  }

  window.addEventListener("resize", requestResize, { passive:true });
  if (window.visualViewport){
    window.visualViewport.addEventListener("resize", requestResize, { passive:true });
    window.visualViewport.addEventListener("scroll", requestResize, { passive:true });
  }
  resize();


  // =============================
  // ğŸ“± ëª¨ë°”ì¼ì€ ê°€ë¡œ(landscape) ê¶Œì¥/ê°•ì œ íë¦„
  //  - ë¸Œë¼ìš°ì €ê°€ ìë™ íšŒì „ì„ 'ê°•ì œ'í•˜ëŠ” ê±´ ì œí•œì´ ìˆì–´ì„œ,
  //    ì„¸ë¡œ(í¬íŠ¸ë ˆì´íŠ¸)ì¼ ë•ŒëŠ” ì˜¤ë²„ë ˆì´ë¥¼ ë„ìš°ê³  ê²Œì„ ì§„í–‰ì„ ë©ˆì¶¥ë‹ˆë‹¤.
  // =============================
  const rotateOverlay = document.getElementById("rotateOverlay");
  function isSmallScreen(){ return window.matchMedia("(max-width: 980px)").matches; }
  function isPortrait(){ return window.innerHeight > window.innerWidth; }

  function updateRotateOverlay(){
    const needRotate = isSmallScreen() && isPortrait();
    if (rotateOverlay){
      rotateOverlay.style.display = needRotate ? "flex" : "none";
    }
    return !needRotate;
  }

  // ì²« ì‹¤í–‰ + í™”ë©´ íšŒì „/ë¦¬ì‚¬ì´ì¦ˆì— ëŒ€ì‘
  updateRotateOverlay();
  window.addEventListener("orientationchange", updateRotateOverlay);
  window.addEventListener("resize", updateRotateOverlay);

  // ê°€ëŠ¥í•˜ë©´(ì§€ì› ë¸Œë¼ìš°ì €) ê°€ë¡œ ì ê¸ˆ ì‹œë„: ì‹¤íŒ¨í•´ë„ ë¬´ì‹œ
  function tryLockLandscape(){
    try{
      if (screen && screen.orientation && screen.orientation.lock){
        screen.orientation.lock("landscape").catch(()=>{});
      }
    }catch(e){}
  }
  // ì‚¬ìš©ì ì œìŠ¤ì²˜ ë•Œ í•œë²ˆ ë” ì‹œë„(ëª¨ë°”ì¼ì—ì„œ ì„±ê³µ í™•ë¥ â†‘)
  window.addEventListener("pointerdown", tryLockLandscape, { once:true, passive:true });

  const groundH = 90;
  const SIDEWALK_H = 22; // âœ… sidewalk thickness used by physics + drawing
  function groundY(){ return CH() - groundH + SIDEWALK_H; }

  // =============================
  // ì´ë¯¸ì§€ ë¡œë“œ
  // =============================
  const playerImg = new Image();
  playerImg.src = "character.png";

  const enemySrcs = ["enemy1.png","enemy2.png","enemy3.png","enemy4.png","enemy5.png"];
  const enemyImgs = enemySrcs.map(src => {
    const im = new Image();
    im.src = src;
    return im;
  });

  // âœ… ë“œë¡ (ê³µì¤‘ ì´ë²¤íŠ¸ ì ) ì´ë¯¸ì§€
  const droneImg = new Image();
  droneImg.src = "drone.png";

  
  // =============================
  // ë°°ê²½ ì´ë¯¸ì§€(10ì¥ ëœë¤)
  //  - ë‹¨ê³„(level) ì‹œì‘í•  ë•Œë§ˆë‹¤ 10ê°œ ì¤‘ 1ê°œë¥¼ ëœë¤ ì„ íƒ
  //  - ë°°ê²½ì€ 'ìŠ¤í¬ë¡¤'í•˜ì§€ ì•Šê³ , í”Œë ˆì´ì–´/ì  ì›€ì§ì„ì— ë§ì¶° ì¢Œìš°ë¡œ ì‚´ì§ í”ë“¤ë¦¼
  // =============================
  const BG_FILES = [
    "city1-4k.png","city2-4k.png","city3-4k.png","city4-4k.png","city5-4k.png",
    "rural1-4k.png","rural2-4k.png","rural3-4k.png","rural4-4k.png","rural5-4k.png",
  ];

  const BG_LIST = BG_FILES.map(src => {
    const im = new Image();
    im.src = src;
    return im;
  });

  const bgState = { idx: 0, theme: "city" };

  function pickRandomBg(){
    const idx = Math.floor(Math.random() * BG_LIST.length);
    bgState.idx = idx;
    bgState.theme = BG_FILES[idx].startsWith("city") ? "city" : "rural";
  }

  // ìº”ë²„ìŠ¤ ì „ì²´ë¥¼ 'cover' ë°©ì‹ìœ¼ë¡œ ê½‰ ì±„ìš°ê¸°(ë¹„ìœ¨ ìœ ì§€)
  function drawCoverImage(img, offsetX, offsetY){
    // ìº”ë²„ìŠ¤ê°€ 'ê°€ìƒ ì¢Œí‘œê³„(VIEW_W,VIEW_H)'ë¡œ ìŠ¤ì¼€ì¼ëœ ìƒíƒœì—ì„œ í˜¸ì¶œë¨
    if (!img || !img.complete || !img.naturalWidth) return false;

    const iw = img.naturalWidth, ih = img.naturalHeight;
    const sw = CW(), sh = CH();

    // âœ… í”ë“¤ë¦¼ ë•Œë¬¸ì— ê°€ì¥ìë¦¬ê°€ ë³´ì´ì§€ ì•Šë„ë¡ 'ì˜¤ë²„ìŠ¤ìº”(ì—¬ìœ ë¶„)'ì„ í¬í•¨í•œ cover
    const ox = Math.abs(offsetX || 0);
    const oy = Math.abs(offsetY || 0);

    // í™”ë©´ì—ì„œ ìµœëŒ€ í”ë“¤ë¦¼ í”½ì…€ì˜ 2ë°°ë§Œí¼ ì—¬ìœ ë¥¼ í™•ë³´(ì–‘ìª½ ëª¨ë‘ ì»¤ë²„)
    // + ì¶”ê°€ ì•ˆì „ ì—¬ìœ (ìµœì†Œ 6%)
    const extraX = (ox * 2) / Math.max(1, sw);
    const extraY = (oy * 2) / Math.max(1, sh);
    const extra = Math.max(0.06, extraX, extraY); // ìµœì†Œ 6% í™•ëŒ€

    const scale = Math.max(sw / iw, sh / ih) * (1 + extra);
    const dw = iw * scale;
    const dh = ih * scale;

    const dx = (sw - dw) / 2 + (offsetX || 0);
    const dy = (sh - dh) / 2 + (offsetY || 0);

    ctx.drawImage(img, dx, dy, dw, dh);
    return true;
  }

  function drawRandomBackground(nowMs){
    const t = nowMs * 0.001;

    // ê¸°ë³¸ 'ì”ì”í•œ í”ë“¤ë¦¼'
    let sway = Math.sin(t * 1.25) * 10;

    // í”Œë ˆì´ì–´/ì  ì›€ì§ì„ì— ë°˜ì‘í•˜ëŠ” í”ë“¤ë¦¼(í•œìª½ìœ¼ë¡œ ê³„ì† ë°€ë¦¬ì§€ ì•Šê²Œ 'ì‘ê²Œ'ë§Œ)
    const pvx = (player && typeof player.vx === "number") ? player.vx : 0;
    sway += clamp(pvx * 1.4, -18, 18);

    // âœ… ìµœì¢… í”ë“¤ë¦¼ í•œê³„(ê²€ì€ ê°€ì¥ìë¦¬ ë°©ì§€)
    sway = clamp(sway, -18, 18);

if (LOW_POWER_STRICT) sway *= 0.55;

    ctx.save();
    const img = BG_LIST[bgState.idx];

    // ì´ë¯¸ì§€ê°€ ì•„ì§ ë¡œë“œ ì „ì´ë©´, ê¸°ì¡´ í”„ë¡œì‹œì €ëŸ´ ë°°ê²½ìœ¼ë¡œ ì„ì‹œ í‘œì‹œ(ì•ˆì „ì¥ì¹˜)
    if (!drawCoverImage(img, sway, 0)){
      drawParallaxBackground(bgState.theme, t);
    }
    ctx.restore();
  }

// =============================
// í”„ë¡œì‹œì €ëŸ´(ê·¸ë ¤ì§€ëŠ”) ë°°ê²½ + íŒ¨ëŸ´ë™ìŠ¤(ì…ì²´ê°)
//  - ì´ë¯¸ì§€ ì—†ì–´ë„ ë™ì‘
//  - ì‹œê°„ì´ ì§€ë‚˜ë©´ 'ë„ì‹œ ë‚®â†’ë…¸ì„â†’ë°¤'ì²˜ëŸ¼ ê³„ì† ë³€í•¨
// =============================
function clamp01(v){ return Math.max(0, Math.min(1, v)); }
function lerp(a,b,t){ return a + (b-a)*t; }
function mixColor(c1,c2,t){
  // c: [r,g,b]
  return [
    Math.round(lerp(c1[0],c2[0],t)),
    Math.round(lerp(c1[1],c2[1],t)),
    Math.round(lerp(c1[2],c2[2],t)),
  ];
}
function rgb(c){ return `rgb(${c[0]},${c[1]},${c[2]})`; }

// ê°„ë‹¨ í•´ì‹œ(í•­ìƒ ê°™ì€ ëœë¤ ëŠë‚Œ)
function hash01(n){
  // âœ… Faster deterministic hash (no Math.sin) for mobile performance
  // returns 0~1
  // n can be float; convert to int bucket
  let x = (n * 1000) | 0;
  x ^= x << 13; x ^= x >>> 17; x ^= x << 5;
  // unsigned to 0..1
  return ((x >>> 0) / 4294967295);
}

function drawParallaxBackground(stage, tSec){
  // stage: city / rural / space (ì ìˆ˜ ê¸°ë°˜)
  // tSec: ì´ˆ ë‹¨ìœ„ ì‹œê°„(ë°°ê²½ ë³€í™”ìš©)

  // --- 1) í•˜ëŠ˜ ê·¸ë¼ë°ì´ì…˜ (ë„ì‹œëŠ” ì‹œê°„ì— ë”°ë¼ ë³€í•¨) ---
  let topA, botA, topB, botB, cycle = 0;

  if (stage === "city"){
    // 0~1 ì£¼ê¸°: ë‚®(0) â†’ ë…¸ì„(0.5) â†’ ë°¤(1)
    cycle = (tSec / 18) % 1; // 18ì´ˆì— í•œ ë²ˆ ì²œì²œíˆ ë³€í™”
    // ë‚® â†’ ë…¸ì„
    const dayTop=[135,206,235], dayBot=[210,240,255];
    const eveTop=[255,170,120], eveBot=[255,220,170];
    const nightTop=[16,22,40],  nightBot=[40,55,90];

    if (cycle < 0.55){
      const tt = clamp01(cycle/0.55);
      topA = mixColor(dayTop, eveTop, tt);
      botA = mixColor(dayBot, eveBot, tt);
    }else{
      const tt = clamp01((cycle-0.55)/0.45);
      topA = mixColor(eveTop, nightTop, tt);
      botA = mixColor(eveBot, nightBot, tt);
    }
  } else if (stage === "rural"){
    topA=[120,200,255]; botA=[220,255,235];
  } else { // space
    topA=[6,10,22]; botA=[25,30,50];
  }

  const g = ctx.createLinearGradient(0, 0, 0, CH());
  g.addColorStop(0, rgb(topA));
  g.addColorStop(1, rgb(botA));
  ctx.fillStyle = g;
  ctx.fillRect(0, 0, CW(), CH());

  // --- 2) íƒœì–‘/ë‹¬ ---
  if (stage === "city"){
    const x = CW()*0.78;
    const y = CH()*0.18;
    if (cycle < 0.78){
      // í•´
      ctx.globalAlpha = 0.55;
      ctx.fillStyle = "rgba(255,240,160,1)";
      ctx.beginPath(); ctx.arc(x, y, 28, 0, Math.PI*2); ctx.fill();
      ctx.globalAlpha = 1;
    }else{
      // ë‹¬
      ctx.globalAlpha = 0.55;
      ctx.fillStyle = "rgba(235,240,255,1)";
      ctx.beginPath(); ctx.arc(x, y, 22, 0, Math.PI*2); ctx.fill();
      // ë‹¬ í¬ë ˆì„¼íŠ¸ ëŠë‚Œ
      ctx.fillStyle = rgb(topA);
      ctx.beginPath(); ctx.arc(x+8, y-4, 20, 0, Math.PI*2); ctx.fill();
      ctx.globalAlpha = 1;
    }
  }

  // --- 3) êµ¬ë¦„(ê°€ì¥ ëŠë¦¬ê²Œ) ---
  if (stage !== "space"){
    const cloudSpeed = scrollSpeed * 0.12;
    const off = -((t * cloudSpeed) % (CW() + 260));
    for (let i=0;i<(LOW_POWER_STRICT?3:6);i++){
      const cx = off + i*260 + 120;
      const cy = 70 + (i%3)*28;
      ctx.globalAlpha = 0.18;
      ctx.fillStyle = "#fff";
      ctx.beginPath();
      ctx.arc(cx, cy, 22, 0, Math.PI*2);
      ctx.arc(cx+26, cy+6, 18, 0, Math.PI*2);
      ctx.arc(cx-26, cy+8, 16, 0, Math.PI*2);
      ctx.fill();
      ctx.globalAlpha = 1;
    }
  }

  // --- 4) ë¨¼ ë°°ê²½(ìŠ¤ì¹´ì´ë¼ì¸/ì‚°) : ì•„ì£¼ ëŠë¦¬ê²Œ ---
  const farY = stage==="space" ? CH()*0.55 : CH()*0.58;
  const farSpeed = scrollSpeed * 0.18;
  const segW1 = LOW_POWER_STRICT ? 110 : 70;

  const farBase = (stage==="rural") ? "rgba(60,130,90,0.45)" :
                  (stage==="space") ? "rgba(120,140,180,0.18)" :
                  "rgba(20,30,50,0.25)";
  ctx.fillStyle = farBase;

  const start1 = Math.floor(((t*farSpeed) / segW1));
  const offset1 = -((t*farSpeed) % segW1);

  for (let i=-2;i<Math.ceil(CW()/segW1)+4;i++){
    const k = start1 + i;
    const r = hash01(k*3.1 + (stage==="rural"?10: (stage==="space"?20:0)));
    const h = 40 + r*90;
    const x = offset1 + i*segW1;
    ctx.fillRect(x, farY - h, segW1, h);
  }

  // --- 5) ì¤‘ê°„ ë°°ê²½(ê±´ë¬¼/ë‚˜ë¬´) : ì¡°ê¸ˆ ë¹ ë¥´ê²Œ(ì…ì²´ê°) ---
  const midY = stage==="space" ? CH()*0.66 : CH()*0.72;
  const midSpeed = scrollSpeed * 0.35;
  const segW2 = LOW_POWER_STRICT ? 98 : 56;

  let midCol;
  if (stage==="rural") midCol="rgba(40,105,70,0.65)";
  else if (stage==="space") midCol="rgba(140,160,210,0.22)";
  else{
    // ë„ì‹œëŠ” ì‹œê°„ì— ë”°ë¼ ìƒ‰ ì¡°ê¸ˆ ë³€í•˜ê²Œ
    midCol = (cycle < 0.6) ? "rgba(30,45,70,0.45)" : "rgba(18,22,35,0.55)";
  }
  ctx.fillStyle = midCol;

  const start2 = Math.floor(((t*midSpeed) / segW2));
  const offset2 = -((t*midSpeed) % segW2);

  for (let i=-2;i<Math.ceil(CW()/segW2)+4;i++){
    const k = start2 + i;
    const r = hash01(k*7.7 + (stage==="rural"?30:(stage==="space"?40:0)));
    const h = 70 + r*140;
    const x = offset2 + i*segW2;

    // ruralì´ë©´ 'ë‚˜ë¬´' ì‹¤ë£¨ì—£ ëŠë‚Œ
    if (stage==="rural"){
      ctx.beginPath();
      ctx.roundRect(x+10, midY-h*0.35, 12, h*0.35, 6);
      ctx.fill();
      ctx.beginPath();
      ctx.arc(x+16, midY-h*0.45, 26, 0, Math.PI*2);
      ctx.globalAlpha = 0.55;
      ctx.fill();
      ctx.globalAlpha = 1;
    } else {
      // city/space: ê±´ë¬¼
      ctx.fillRect(x, midY - h, segW2, h);
      // ì°½ë¬¸(ì•„ì£¼ ì•½í•˜ê²Œ)
      if (!LOW_POWER && stage==="city" && cycle > 0.7){
        ctx.globalAlpha = 0.12;
        ctx.fillStyle = "rgba(255,220,120,1)";
        for (let w=10; w<segW2-10; w+=12){
          for (let yy=midY-h+12; yy<midY-12; yy+=18){
            if (hash01(k*13 + w + yy) > 0.7) ctx.fillRect(x+w, yy, 6, 10);
          }
        }
        ctx.globalAlpha = 1;
        ctx.fillStyle = midCol;
      }
    }
  }
}

// =============================
// ë„ë¡œ(ì•„ìŠ¤íŒ”íŠ¸) + ë³´ë„ë¸”ëŸ­(ê·¸ë¦¼ìœ¼ë¡œ ì§ì ‘ ê·¸ë¦¬ê¸°)
// =============================

function drawRoadAndSidewalk(stage){
  const gy = CH() - groundH; // âœ… sidewalk top (visual)

  const sidewalkH = SIDEWALK_H;
  const roadH = groundH - sidewalkH;

  // -----------------------------
  // 1) Sidewalk (tile)
  // -----------------------------
  ctx.fillStyle = "rgba(200,205,210,0.92)";
  ctx.fillRect(0, gy, CW(), sidewalkH);

  // tile grid (cheap)
  ctx.strokeStyle = "rgba(0,0,0,0.18)";
  ctx.lineWidth = 1;
  const tileW = 34, tileH = 11;
  const stepX = (LOW_POWER ? tileW*2 : tileW);
  const stepY = (LOW_POWER ? tileH*2 : tileH);

  for (let y=gy; y<gy+sidewalkH; y+=stepY){
    ctx.beginPath();
    ctx.moveTo(0, y);
    ctx.lineTo(CW(), y);
    ctx.stroke();
  }
  for (let x=0; x<CW(); x+=stepX){
    ctx.beginPath();
    ctx.moveTo(x, gy);
    ctx.lineTo(x, gy+sidewalkH);
    ctx.stroke();
  }

  // curb
  ctx.fillStyle = "rgba(0,0,0,0.28)";
  ctx.fillRect(0, gy+sidewalkH-2, CW(), 2);

  // -----------------------------
  // 2) Asphalt road (static look)
  // -----------------------------
  const roadY = gy + sidewalkH;
  ctx.fillStyle = (stage==="space") ? "#1c1f28" : "#262b2f";
  ctx.fillRect(0, roadY, CW(), roadH);

  // asphalt grain (static-ish)
  ctx.save();
  ctx.globalAlpha = 0.10;
  ctx.fillStyle = "#fff";
  const dots = LOW_POWER_STRICT ? 80 : 200;
  for (let i=0;i<dots;i++){
    // deterministic "random" based on i only -> no shimmering
    const rx = hash01(i*9.1 + 123.4) * CW();
    const ry = hash01(i*3.3 + 987.6) * roadH;
    const x = rx | 0;
    const y = (roadY + ry) | 0;
    ctx.fillRect(x, y, 2, 1);
  }
  ctx.restore();

  // -----------------------------
  // 3) Lane lines (yellow stays, scroll only when running)
  // -----------------------------
  const isRunning = (player && player.onGround && Math.abs(player.vx) > 0.5);
  // move dashes only when running; direction follows player.vx
  const dir = (player && player.vx < 0) ? -1 : 1;
  const dashMove = isRunning ? (t * 8.0 * (scrollSpeed/4) * dir) : 0;

  // edge white lines
  ctx.save();
  ctx.strokeStyle = "rgba(255,255,255,0.22)";
  ctx.lineWidth = 2;
  ctx.beginPath();
  ctx.moveTo(0, roadY + 10);
  ctx.lineTo(CW(), roadY + 10);
  ctx.moveTo(0, roadY + roadH - 10);
  ctx.lineTo(CW(), roadY + roadH - 10);
  ctx.stroke();

  // center yellow dashed line
  const cy = roadY + roadH * 0.5;
  ctx.strokeStyle = "rgba(243,186,47,0.95)";
  ctx.lineWidth = 4;
  ctx.setLineDash([28, 22]);     // dash length, gap
  ctx.lineDashOffset = -dashMove;
  ctx.beginPath();
  ctx.moveTo(-80, cy);
  ctx.lineTo(CW()+80, cy);
  ctx.stroke();

  // subtle glow (only when running -> feels "alive", idle still looks like a road)
  if (isRunning && !LOW_POWER_STRICT){
    ctx.globalAlpha = 0.22;
    ctx.lineWidth = 10;
    ctx.setLineDash([28, 22]);
    ctx.lineDashOffset = -dashMove;
    ctx.beginPath();
    ctx.moveTo(-80, cy);
    ctx.lineTo(CW()+80, cy);
    ctx.stroke();
    ctx.globalAlpha = 1;
  }

  ctx.setLineDash([]);
  ctx.restore();
}



// =============================
  // ìƒíƒœ
  // =============================
  const hudEnergy = document.getElementById("energyText");
  const hudScore = document.getElementById("scoreText");

  // âœ… ëˆ„ì  ì‚¬í† ì‹œ ì‚¬í† ì‹œ(HOF) í‘œì‹œ
  const hudTotal = document.getElementById("totalText");
  const hudEmailMask = document.getElementById("emailMask");
  const btnChangeEmail = document.getElementById("btnChangeEmail");
  const btnReauthEmail = document.getElementById("btnReauthEmail");
  const btnExitMain = document.getElementById("btnExitMain");
  const hudSaveStatus = document.getElementById("saveStatus");

  // =============================
  // â˜ï¸ Google Sheet Sync (Game2)
  //  - ê°™ì€ ìŠ¤í”„ë ˆë“œì‹œíŠ¸, íƒ­ë§Œ ë¶„ë¦¬: "game2"
  //  - ë“±ë¡ì€ í•„ìš”í•  ë•Œë§Œ(ìºì‹œ ì—†ìœ¼ë©´ ì…ë ¥)
  // =============================
  const GAME2_WEB_APP_URL = "https://script.google.com/macros/s/AKfycbxJPlMspnCMdvrgdqdlfQfEkWjs_2YaxmJxJtDPkud3ky668nIV1C1N3aN-1TY5eKItcA/exec";
  const LS_GAME2_EMAIL = "game2_email";
  const GUEST_MAX_LEVEL = 5; // 1~5ë‹¨ê³„ëŠ” ê²ŒìŠ¤íŠ¸ ê°€ëŠ¥, 6ë‹¨ê³„ë¶€í„° ì´ë©”ì¼ í•„ìš”
  let _emailGateMode = "startup";
  let _pendingNextLevel = null;

  function normEmail(v){
    return String(v||"").trim().toLowerCase();
  }
  function maskEmail(email){
    const e = normEmail(email);
    if (!e || !e.includes("@")) return "-";
    const head = e.split("@")[0];
    const show = head.slice(0, Math.min(4, head.length));
    return show + "***";
  }
  function getAnyEmail(){
    // 1) Game1 email ìˆìœ¼ë©´ ìš°ì„  ì‚¬ìš©
    const e1 = normEmail(localStorage.getItem("registeredEmail"));
    if (e1 && e1.includes("@")) return e1;

    // 2) Game2 email
    const e2 = normEmail(localStorage.getItem(LS_GAME2_EMAIL));
    if (e2 && e2.includes("@")) return e2;

    return "";
  }

  let currentEmail = "";

  function syncEmailHudButtons(){
    try{
      const has = !!currentEmail;
      if (btnChangeEmail) btnChangeEmail.style.display = has ? "" : "none";
      if (btnReauthEmail) btnReauthEmail.style.display = has ? "none" : "";
      if (hudEmailMask && !has) hudEmailMask.textContent = "-";
    }catch(_){}
  }

  let totalSatoshi = 0;
  let _saveTimer = null;
  let _saving = false;
  let _lastSaveAt = 0;
  let _gameOverSaved = false;
  let _dirty = false;

  async function tgGame2Get(){
    if (!currentEmail) return Promise.resolve(false);
    try{
      const url = GAME2_WEB_APP_URL + "?action=getgame2&email=" + encodeURIComponent(currentEmail) + "&_=" + Date.now();
      const r = await fetch(url, { cache:"no-store" });
      const j = await r.json();
      if (j && j.ok){
        if (typeof j.total_satoshi === "number" && isFinite(j.total_satoshi)) totalSatoshi = j.total_satoshi;
        if (typeof j.level === "number" && isFinite(j.level)) level = clamp(j.level, 1, SEASON_MAX);
        if (typeof j.energy === "number" && isFinite(j.energy)) energy = clamp(Math.round(j.energy), 0, 15);
      }
    }catch(e){
      // ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨í•´ë„ ê²Œì„ì€ ê·¸ëƒ¥ ì§„í–‰
      console.warn("Game2 GET failed:", e);
    }
  }

  function tgGame2Post(reason, opts){
    if (!currentEmail) return Promise.resolve(false);
    opts = opts || {};
    // allow a "forced" save (e.g., on exit) even if an autosave is in progress
    if (_saving && !opts.force) return Promise.resolve(false);
    _saving = true;
    try{ if (hudSaveStatus) hudSaveStatus.textContent = "saving..."; }catch(_){ }

    const now = Date.now();
    _lastSaveAt = now;

    try{
      const fd = new URLSearchParams();
      fd.append("action", "savegame2");
      fd.append("mode", "game2");
      fd.append("email", currentEmail);

      // ì €ì¥ ë°ì´í„°
      fd.append("run_satoshi", String(score)); // í˜„ì¬ ì‚¬í† ì‹œ
      fd.append("total_satoshi", String(totalSatoshi)); // ëˆ„ì  ì‚¬í† ì‹œ
      fd.append("level", String(level));
      fd.append("energy", String(energy));
      fd.append("reason", String(reason||""));

      return fetch(GAME2_WEB_APP_URL, { method:"POST", mode:"cors", body: fd, keepalive: !!opts.keepalive })
        .then(async (res)=>{
          try{ const tx = await res.text(); console.log("Game2 SAVE:", res.status, tx);
            if (res.ok) { _dirty = false; }
            try{ if (hudSaveStatus) hudSaveStatus.textContent = (res.ok ? "OK" : ("HTTP " + res.status)); }catch(_){ }
          }catch(_){ }
          return !!res.ok;
        })
        .catch((err)=>{ console.warn("Game2 SAVE failed:", err);
          try{ if (hudSaveStatus) hudSaveStatus.textContent = "FAIL"; }catch(_){ }
          return false; })
        .finally(()=>{ _saving = false; });
    }catch(_){
      _saving = false;
    }
  }

  // âœ… ì™¸ë¶€(ë²„íŠ¼)ì—ì„œ í˜¸ì¶œ ê°€ëŠ¥í•œ ìˆ˜ë™ ì €ì¥ í•¨ìˆ˜
  //  - ë‚´ë¶€ ìƒíƒœ(_saving/_dirty/saveStatus)ë¥¼ ê·¸ëŒ€ë¡œ ì‚¬ìš©
  window.tgGame2ManualSave = async function(){
    try{
      if (!currentEmail){
        alert("ì´ë©”ì¼ì´ ì•„ì§ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
        return false;
      }
      // ì§„í–‰ ì¤‘ ì €ì¥ì´ ìˆìœ¼ë©´ ê°•ì œë¡œ í•œ ë²ˆ ë” ì‹œë„
      const ok = await tgGame2Post("manual_save", { force:true });
      return !!ok;
    }catch(_){
      return false;
    }
  };

  
  function tgGame2BeaconSave(reason){
    try{
      if (!currentEmail) return false;
      const fd = new URLSearchParams();
      fd.append("action", "savegame2");
      fd.append("mode", "game2");
      fd.append("email", currentEmail);
      fd.append("run_satoshi", String(score));
      fd.append("total_satoshi", String(totalSatoshi));
      fd.append("level", String(level));
      fd.append("energy", String(energy));
      fd.append("reason", String(reason||""));
      // sendBeaconì€ ì¢…ë£Œ ì§ì „ì—ë„ ì „ì†¡ ì„±ê³µë¥ ì´ ë†’ìŒ
      if (navigator.sendBeacon) {
        return navigator.sendBeacon(GAME2_WEB_APP_URL, fd);
      }
    }catch(_){}
    return false;
  }

function tgGame2Save(reason, force){
    if (force) {
      _dirty = false; // ê°•ì œ ì €ì¥ ì§í›„ì—” dirtyë¥¼ ì„œë²„ ì‘ë‹µìœ¼ë¡œ ë‹¤ì‹œ ë§ì¶”ì§€ë§Œ, ìš°ì„  false ì²˜ë¦¬
      tgGame2Post(reason);
      return;
    }
    _dirty = true;

    // ë„ˆë¬´ ìì£¼ ì €ì¥í•˜ì§€ ì•Šê²Œ 900ms ë””ë°”ìš´ìŠ¤
    const now = Date.now();
    if (now - _lastSaveAt < 600) return;

    clearTimeout(_saveTimer);
    _saveTimer = setTimeout(()=> tgGame2Post(reason), 900);
  }

  async function tgGame2EnsureEmail(opts){
    const gate = document.getElementById("emailGate");
    const inp  = document.getElementById("emailInput");
    const btn  = document.getElementById("emailBtn");
    const later= document.getElementById("emailLaterBtn");

    opts = opts || {};
    const promptIfMissing = (opts.promptIfMissing !== false);
    const mode = opts.mode || "startup";
    _emailGateMode = mode;

    currentEmail = getAnyEmail();
    syncEmailHudButtons();

    // ì´ë¯¸ ìˆìœ¼ë©´ gate ì—†ì´ ë°”ë¡œ
    if (currentEmail){
      if (gate) gate.style.display = "none";
      if (hudEmailMask) hudEmailMask.textContent = maskEmail(currentEmail);
      syncEmailHudButtons();
      syncEmailHudButtons();
      try{ if (btnChangeEmail) btnChangeEmail.style.display = ""; }catch(_){ }
      await tgGame2Get();
      try{ if (hudSaveStatus) hudSaveStatus.textContent = "loaded"; }catch(_){ }
      return;
    }

    // ì—†ìœ¼ë©´ ì…ë ¥ ë°›ê¸°
    if (!promptIfMissing){
      if (gate) gate.style.display = "none";
      if (later) later.style.display = "none";
      return false;
    }

    if (gate) gate.style.display = "flex";
    if (later) later.style.display = ((mode === "level6" || mode === "reauth") ? "block" : "none");
    if (mode === "level6" || mode === "reauth") userPaused = true;
    if (inp){ try{ inp.value = ""; }catch(_){ } }

    function submit(){
      const v = normEmail(inp ? inp.value : "");
      if (!v || !v.includes("@")){
        alert("ì´ë©”ì¼ì„ ì˜¬ë°”ë¥´ê²Œ ì…ë ¥í•´ì£¼ì„¸ìš”.");
        return;
      }
      currentEmail = v;
      try{ localStorage.setItem(LS_GAME2_EMAIL, currentEmail); }catch(_){}
      if (hudEmailMask) hudEmailMask.textContent = maskEmail(currentEmail);
      try{ if (btnChangeEmail) btnChangeEmail.style.display = ""; }catch(_){ }
      if (gate) gate.style.display = "none";

      // âœ… 6ë‹¨ê³„ ì§„ì…ìš© ê²Œì´íŠ¸ì—ì„œ ì´ë©”ì¼ì„ ë°›ì€ ê²½ìš°: ë°”ë¡œ ë‹¤ìŒ ë‹¨ê³„ë¡œ ì§„í–‰ + ì¦‰ì‹œ ì €ì¥
      if (_emailGateMode === "level6" && _pendingNextLevel){
        const goLv = _pendingNextLevel;
        _pendingNextLevel = null;
        _emailGateMode = "startup";
        userPaused = false;
        try{ if (hudSaveStatus) hudSaveStatus.textContent = "linked"; }catch(_){ }
        startLevel(goLv);
        tgGame2Save("email_link", true);
        return;
      }

      tgGame2Get().then(()=>{
        try{ if (hudSaveStatus) hudSaveStatus.textContent="loaded"; }catch(_){ }

        // âœ… ì¬ì¸ì¦/ì´ˆê¸° ë¡œë“œ í›„: ì €ì¥ëœ ë ˆë²¨/ì—ë„ˆì§€ ìƒíƒœì— ë§ê²Œ ê²Œì„ì„ ë‹¤ì‹œ ì‹œì‘
        // - ì—ë„ˆì§€ê°€ 0ì´ë©´(ì£½ì€ ìƒíƒœë¡œ ì €ì¥ë¨) 1ë‹¨ê³„ ìƒˆ ëŸ°ìœ¼ë¡œ ë¦¬ì…‹í•´ì„œ ë°”ë¡œ í”Œë ˆì´ ê°€ëŠ¥í•˜ê²Œ
        try{
          userPaused = false;
          if (energy <= 0){
            level = 1;
            score = 0;
            startLevel(1); // ì—¬ê¸°ì„œ ENERGY_STARTë¡œ ìë™ ë¦¬ì…‹ë¨
          } else {
            startLevel(level);
          }
        }catch(_){}
      }); // ë¹„ë™ê¸° ë¡œë“œ
    }

    function decline(){
      if (gate) gate.style.display = "none";
      if (mode === "level6" || mode === "reauth"){
        resetGuestToLevel1();
      }
    }

    if (btn){
      btn.onclick = submit;
    }
    if (later){
      later.onclick = decline;
    }
    if (inp){
      inp.addEventListener("keydown", (e)=>{
        if (e.key === "Enter"){ e.preventDefault(); submit(); }
      });
      setTimeout(()=>{ try{ inp.focus(); }catch(_){ } }, 50);
    }
  }

  // =============================
  // ğŸ§‘â€ğŸš€ Guest reset (Level6ì—ì„œ ì´ë©”ì¼ ê±°ì ˆ ì‹œ)
  // =============================
  function resetGuestToLevel1(){
    try{ localStorage.removeItem(LS_GAME2_EMAIL); }catch(_){ }
    currentEmail = "";
    try{ if (hudEmailMask) hudEmailMask.textContent = "-"; }catch(_){ }
    syncEmailHudButtons();
    try{ if (hudSaveStatus) hudSaveStatus.textContent = "guest"; }catch(_){ }

    // ì ìˆ˜/ì—ë„ˆì§€/ë ˆë²¨ ì´ˆê¸°í™”
    score = 0;
    totalSatoshi = 0;
    level = 1;
    energy = ENERGY_START;

    // ì—”í‹°í‹°/ì´í™íŠ¸ ì´ˆê¸°í™”
    try{ papers.length = 0; }catch(_){ }
    try{ enemies.length = 0; }catch(_){ }
    try{ enemyShots.length = 0; }catch(_){ }
    try{ coins.length = 0; }catch(_){ }
    try{ energyDrops.length = 0; }catch(_){ }
    try{ deathFx.length = 0; }catch(_){ }
    try{ particles.length = 0; }catch(_){ }
    try{ footDust.length = 0; }catch(_){ }
    try{ speedLines.length = 0; }catch(_){ }
    try{ drones.length = 0; }catch(_){ }
    try{ droneBombs.length = 0; }catch(_){ }

    // í”Œë ˆì´ì–´ ìœ„ì¹˜ ë¦¬ì…‹
    try{ player.x = 140; player.vx = 0; player.vy = 0; player.face = 1; player.onGround = false; player.invuln = 0; player.y = groundY() - player.h; }catch(_){ }

    // ìŠ¤í°/í†µê³„ ë¦¬ì…‹
    try{ nextSpawn = 0; }catch(_){ }
    try{ totalAttacks = 0; }catch(_){ }
    try{ droneAttacks = 0; }catch(_){ }
    try{ lastDroneSpawnAt = 0; }catch(_){ }

    // HUD ë°˜ì˜
    try{ if (hudLevel) hudLevel.textContent = "1"; }catch(_){ }
    try{ if (hudScore) hudScore.textContent = "0"; }catch(_){ }
    try{ if (hudTotal) hudTotal.textContent = "0"; }catch(_){ }
    try{ if (hudEnergy) hudEnergy.textContent = String(energy); }catch(_){ }

    // ê²Œì´íŠ¸ ìƒíƒœ ë¦¬ì…‹
    _pendingNextLevel = null;
    _emailGateMode = "startup";

    // 1ë‹¨ê³„ë¡œ ì¬ì‹œì‘
    try{ startLevel(1); }catch(_){ }
    userPaused = false;
  }

  
  // =============================
  // ğŸ‘¤ Change Email (Game2 only)
  // =============================
  if (btnChangeEmail){
    btnChangeEmail.addEventListener("pointerdown", (e)=>{
      try{ e.preventDefault(); e.stopPropagation(); }catch(_){}
      if (!confirm("ì´ë©”ì¼ì„ ë³€ê²½í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n(ë‹¤ìŒì— ë‹¤ì‹œ ì…ë ¥í•´ì•¼ í•©ë‹ˆë‹¤)")) return;
      try{ localStorage.removeItem(LS_GAME2_EMAIL); }catch(_){}
      // Game1 registeredEmailì€ ê±´ë“œë¦¬ì§€ ì•ŠìŒ
      location.reload();
    }, {passive:false});
  }


  // =============================
  // ğŸ” Re-auth Email button (when local cache cleared)
  // =============================
  if (btnReauthEmail){
    btnReauthEmail.addEventListener("pointerdown", (e)=>{
      try{ e.preventDefault(); e.stopPropagation(); }catch(_){}
      tgGame2EnsureEmail({ promptIfMissing:true, mode:"reauth" });
    }, {passive:false});
  }

let score = 0;
let energy = 10;


// =============================
// ë‚œì´ë„(ì‹œì¦Œ1): 1ë‹¨ê³„ ~ 100ë‹¨ê³„
//  - ê° ë‹¨ê³„ëŠ” "ì •í•´ì§„ ì‹œê°„"ì„ ë²„í‹°ë©´ ë‹¤ìŒ ë‹¨ê³„ë¡œ ë„˜ì–´ê°‘ë‹ˆë‹¤.
//  - ë§¤ ë‹¨ê³„ ì‹œì‘ ì‹œ 2ì´ˆê°„ ì ê¹ ë©ˆì¶”ê³ , ì¤‘ì•™ì— "Në‹¨ê³„ ì‹œì‘" ë©˜íŠ¸ê°€ ë‚˜ì™”ë‹¤ê°€ ì‚¬ë¼ì§‘ë‹ˆë‹¤.
//  - 100ë‹¨ê³„ ì™„ë£Œ ì‹œ "ë‹¤ìŒ ì‹œì¦Œì„ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”" ì•ˆë‚´(ì‹œì¦Œ ì¢…ë£Œ).
// =============================
const SEASON_MAX = 100;

const hudLevel = document.getElementById("levelText");
let level = 1;

// ë‹¨ê³„ íƒ€ì´ë¨¸
let levelStartedAt = performance.now();
let levelDurationSec = 60;

// ë‹¨ê³„ ì „í™˜ ì—°ì¶œ(ì¼ì‹œì •ì§€/ë©˜íŠ¸)
let levelPauseUntil = 0;      // ì´ ì‹œê°„ ì „ê¹Œì§€ update()ëŠ” ë©ˆì¶¤
let showLevelTextUntil = 0;   // ì´ ì‹œê°„ ì „ê¹Œì§€ "Në‹¨ê³„ ì‹œì‘" ë©˜íŠ¸ í‘œì‹œ

let seasonComplete = false;

// ìœ í‹¸
function clamp(v, a, b){ return Math.max(a, Math.min(b, v)); }
function lerp01(a, b, t){ return a + (b - a) * t; }

// âœ… ìš”êµ¬ì‚¬í•­: 1ë‹¨ê³„ëŠ” 40~90ì´ˆ(ëœë¤), ì´í›„ ë‹¨ê³„ëŠ” ì ì  ì§§ì•„ì§, 100ë‹¨ê³„ëŠ” ë§¤ìš° ì§§ê²Œ
function getLevelDurationSec(lv){
  // âœ… ìš”êµ¬ì‚¬í•­:
  //  - 1ë‹¨ê³„: 40ì´ˆ ê³ ì •
  //  - ëª¨ë“  ë‹¨ê³„: 60ì´ˆ(1ë¶„) ì´ë‚´
  if (lv === 1) return 40;
  return 60;
}

// =============================
// â¤ï¸ ì—ë„ˆì§€ ì‹œìŠ¤í…œ (Run ê¸°ë°˜ / ìœ ì§€í˜•)
// - ì‹œì‘: 10
// - ë‹¨ê³„ê°€ ì˜¬ë¼ê°€ë„ ìë™ ë¦¬ì…‹/ì¦ê°€ ì—†ìŒ (í˜„ì¬ ì—ë„ˆì§€ ê·¸ëŒ€ë¡œ ìœ ì§€)
// - ìµœëŒ€: 15
// - ì—ë„ˆì§€ 0ì´ë©´ GAME OVER â†’ Restartë¡œ 1ë‹¨ê³„ë¶€í„°(ì—ë„ˆì§€ 10) ì¬ì‹œì‘
// - ë‹¨ê³„ í´ë¦¬ì–´ ì‹œ 'í‰ê·  ì—ë„ˆì§€ ê³µê¸‰ëŸ‰'ì„ ëˆ„ì  ì‚¬í† ì‹œ(ì†Œìˆ˜ì  ëˆ„ì  ì‚¬í† ì‹œ)í•´ì„œ ê°€ë” +1 ì§€ê¸‰
//   * 1~5ë‹¨ê³„:  +1.0
//   * 6~15ë‹¨ê³„: +0.6
//   * 16ë‹¨ê³„~:  +0.3
// =============================
const ENERGY_START = 10;
const ENERGY_CAP   = 15;

let _stageEnergyFrac = 0;      // ì†Œìˆ˜ì  ëˆ„ì  ì‚¬í† ì‹œìš©(ì˜ˆ: 0.6+0.6=1.2 â†’ +1 ì§€ê¸‰ í›„ 0.2 ë‚¨ê¹€)
let _runStartedOnce  = false;  // ì²« ëŸ° ì‹œì‘ ì—¬ë¶€

function getStageEnergyRate(lv){
  if (lv <= 5) return 1.0;
  if (lv <= 15) return 0.6;
  return 0.3;
}

// ë‹¨ê³„(ìŠ¤í…Œì´ì§€) í´ë¦¬ì–´ ë³´ìƒ: ëˆ„ì  ì‚¬í† ì‹œí•´ì„œ +1ì”© ì§€ê¸‰(ìº¡ 15)
// ì—ë„ˆì§€ê°€ ì´ë¯¸ 15ë©´, ëˆ„ì  ì‚¬í† ì‹œì€ ìœ ì§€í–ˆë‹¤ê°€ ë‚˜ì¤‘ì— ì—ë„ˆì§€ê°€ ê¹ì˜€ì„ ë•Œ ë°˜ì˜ë  ìˆ˜ ìˆìŒ
function grantStageEnergyOnClear(lv){
  _stageEnergyFrac += getStageEnergyRate(lv);

  // ì—ë„ˆì§€ê°€ ëª¨ìë„ ë•Œë§Œ ì‹¤ì œ +1ë¡œ ë³€í™˜ (ìº¡ ë„ë‹¬ ì‹œ ëˆ„ì  ì‚¬í† ì‹œë§Œ ìœ ì§€)
  while (_stageEnergyFrac >= 1 && energy < ENERGY_CAP){
    energy = Math.min(ENERGY_CAP, energy + 1);
    _stageEnergyFrac -= 1;
  }
}
// ë‹¨ê³„ ì‹œì‘(2ì´ˆ ì •ì§€ + ë©˜íŠ¸ í‘œì‹œ)
function startLevel(lv){
  level = clamp(lv, 1, SEASON_MAX);

  // âœ… Run ì‹œì‘(1ë‹¨ê³„ ì§„ì…)ì¼ ë•Œë§Œ ì—ë„ˆì§€ ì´ˆê¸°í™”
  // - ì¤‘ê°„ ë‹¨ê³„ë¡œ ë„˜ì–´ê°ˆ ë• ì—ë„ˆì§€ë¥¼ ê·¸ëŒ€ë¡œ ìœ ì§€í•©ë‹ˆë‹¤.
  if (level === 1 && (!_runStartedOnce || energy <= 0 || !isFinite(energy))){
    energy = ENERGY_START;
    _stageEnergyFrac = 0;
    _runStartedOnce = true;

    // âœ… ìƒˆ ëŸ°(1ë‹¨ê³„) ì‹œì‘ì´ë©´ ê²Œì„ì˜¤ë²„ ì €ì¥ í”Œë˜ê·¸ë„ ë¦¬ì…‹
    _gameOverSaved = false;
  }

  if (hudEnergy) hudEnergy.textContent = String(energy);
levelDurationSec = getLevelDurationSec(level);
  levelStartedAt = performance.now();

  // âœ… ë‹¨ê³„ê°€ ë°”ë€” ë•Œë§ˆë‹¤ ë°°ê²½ì„ 10ê°œ ì¤‘ ëœë¤ìœ¼ë¡œ ì„ íƒ
  pickRandomBg();

  const now = performance.now();
  levelPauseUntil = now + 2000;     // 2ì´ˆ ë©ˆì¶¤
  showLevelTextUntil = now + 1600;  // ë©˜íŠ¸ëŠ” 1.6ì´ˆ ì •ë„ë§Œ

  if (hudLevel) hudLevel.textContent = String(level);
}

// ë‹¨ê³„ -> ë‚œì´ë„ íŒŒë¼ë¯¸í„°(0~1)
function levelT(){ return (level - 1) / (SEASON_MAX - 1); }

function getScrollSpeed(){
  // ë‚œì´ë„(ì´ë™ ì†ë„): 1ë‹¨ê³„ëŠ” ì•„ì£¼ ì²œì²œíˆ, 100ë‹¨ê³„ëŠ” ë¹ ë¥´ê²Œ
  // 3.6 -> 8.2 (ì ì§„ì ìœ¼ë¡œ ì¦ê°€)
  return lerp01(3.6, 8.2, levelT());
}
function getSpawnGap(){
  // ì  ìŠ¤í° ê°„ê²©(ms): ì´ˆë°˜ì€ ë„ë„, í›„ë°˜ìœ¼ë¡œ ê°ˆìˆ˜ë¡ ì´˜ì´˜
  // 2400~3400 -> 520~980
  const min = lerp01(2400, 520, levelT());
  const max = lerp01(3400, 980, levelT());
  return { min, max };
}
function getShotGap(){
  // ì  ê³µê²© ê°„ê²©(ms): ì´ˆë°˜ì€ ë§¤ìš° ëŠë¦¬ê²Œ, í›„ë°˜ì€ ë¹ ë¥´ê²Œ
  // 2600~3600 -> 650~1150
  const min = lerp01(2600, 650, levelT());
  const max = lerp01(3600, 1150, levelT());
  return { min, max };
}
function getEnemyShotSpeed(){
  // íˆ¬ì‚¬ì²´ ì†ë„(px/frame): ì´ˆë°˜ì€ ëŠë¦¬ê²Œ, í›„ë°˜ì€ ë¹ ë¥´ê²Œ
  // 8.5 -> 18.5
  return lerp01(8.5, 18.5, levelT());
}


  // ìë™ ëŸ¬ë„ˆ (í”Œë ˆì´ì–´ëŠ” ê±°ì˜ ì œìë¦¬, ì›”ë“œê°€ ì›€ì§ì´ëŠ” ëŠë‚Œ)
  let scrollSpeed = 4;

  const PLAYER_SPRITE_Y_OFFSET = 34; // ğŸ”§ micro-adjust +4px (final touch) // ğŸ”§ micro-adjust: final ground contact // ğŸ”§ fine-tuned: feet touch ground // âœ… sprite has transparent padding; push drawing down

  const player = {
    x: 140,
    y: 0,
    w: 118,
    h: 177,
    vx: 0,
    vy: 0,
    onGround: false,
    invuln: 0,     // ë¬´ì  í”„ë ˆì„
    face: 1
  };
  player.y = groundY() - player.h;

  const papers = []; // {x,y,w,h,vx,vy?,life}
  const enemies = []; // {x,y,w,h,img,hp,nextShotAt}
  const enemyShots = []; // {x,y,w,h,vx,life}
  const coins = []; // {x,y,r,vy,life}
  const energyDrops = []; // {x,y,r,vy,life}

  // âœ… í•˜íŠ¸(ì—ë„ˆì§€) ë“œë í™•ë¥ : ì´ˆë°˜ ë†’ê²Œ, í›„ë°˜ ë‚®ê²Œ
  function getHeartDropChance(){
    if (level <= 5) return 0.10;
    if (level <= 15) return 0.06;
    return 0.03;
  }
  const deathFx = []; // {x,y,w,h,img,vy,rot,vr,alpha,life,mode}
  const particles = []; // {x,y,vx,vy,r,life,alpha}
  const footDust = [];  // {x,y,vx,vy,r,life,alpha}  // âœ… ë‹¬ë¦´ ë•Œ ë°œë°‘ ë¨¼ì§€
  const speedLines = []; // {x1,y1,x2,y2,life,alpha}
  const drones = [];     // ê³µì¤‘ ë“œë¡ (ì²˜ì¹˜ ë¶ˆê°€)
  const droneBombs = []; // ë“œë¡  ì†ŒìŒíƒ„(ğŸ’¥) ë‚™í•˜

  // ë“œë¡  ë¹ˆë„ ì œì–´(ê³µê²© ê¸°ì¤€ 20% ë¯¸ë§Œ + ì¿¨íƒ€ì„)
  let totalAttacks = 0;
  let droneAttacks = 0;
  let lastDroneSpawnAt = 0;

  // ì…ë ¥: Space ì í”„, Q ì„œë¥˜
  const keys = {};

  // =============================
  // ğŸ“± ëª¨ë°”ì¼ ë²„íŠ¼(í‚¤ë³´ë“œ ëŒ€ì²´)
  //  - ì¢Œ/ìš°: ëˆ„ë¥´ëŠ” ë™ì•ˆ ì´ë™
  //  - ì í”„/ê³µê²©: íƒ­(í´ë¦­)
  // =============================
  function bindHold(btn, downFn, upFn){
    if (!btn) return;
    const down = (e)=>{
      try{ e.preventDefault(); e.stopPropagation(); }catch(_){}
      downFn && downFn();
    };
    const up   = (e)=>{
      try{ e.preventDefault(); e.stopPropagation(); }catch(_){}
      upFn && upFn();
    };
    // âœ… passive:false ë¡œ preventDefaultê°€ í™•ì‹¤íˆ ë™ì‘í•˜ê²Œ
    btn.addEventListener("pointerdown", down, {passive:false});
    btn.addEventListener("pointerup", up, {passive:false});
    btn.addEventListener("pointercancel", up, {passive:false});
    btn.addEventListener("pointerleave", up, {passive:false});
  }

  const btnLeft  = document.getElementById("btnLeft");
  const btnRight = document.getElementById("btnRight");
  const btnJump  = document.getElementById("btnJump");
  const btnAtk   = document.getElementById("btnAtk");
const btnAtkUp = document.getElementById("btnAtkUp");

  // =============================
  // â“˜ Help í† ê¸€ (DOM ë¡œë“œ í›„ ë°”ì¸ë”©)
  // =============================
  window.addEventListener("DOMContentLoaded", () => {
    const helpBtn = document.getElementById("helpBtn");
    const helpPanel = document.getElementById("helpPanel");
    const pauseBtn = document.getElementById("pauseBtn");
    let helpOpen = false;

    function setHelp(open){
      helpOpen = !!open;
      if (!helpPanel) return;
      helpPanel.style.display = helpOpen ? "block" : "none";
      helpPanel.setAttribute("aria-hidden", helpOpen ? "false" : "true");
    }

    if (helpBtn){
      helpBtn.addEventListener("pointerdown", (e)=>{
        try{ e.preventDefault(); }catch(_){}
        setHelp(!helpOpen);
      });
    }

    if (pauseBtn){
      pauseBtn.addEventListener("pointerdown", (e)=>{
        try{ e.preventDefault(); }catch(_){}
        togglePause();
      });
    }

    // íŒ¨ë„ ë°”ê¹¥ í´ë¦­í•˜ë©´ ë‹«ê¸°
    window.addEventListener("pointerdown", (e)=>{
      if (!helpOpen) return;
      const t = e.target;
      if (helpBtn && (t === helpBtn || helpBtn.contains(t))) return;
      if (helpPanel && (t === helpPanel || helpPanel.contains(t))) return;
      setHelp(false);
    }, { passive:true });
  });

  // âœ… ì•±ê²Œì„ ëŠë‚Œ: D-pad ì „ì²´ ì˜ì—­ì—ì„œ ì†ê°€ë½ ìœ„ì¹˜ë¡œ ì¢Œ/ìš° ê²°ì • (ìŠ¤ì™€ì´í”„ ì „í™˜)
  //    - setPointerCaptureë¡œ "ëˆ„ë¥¸ ì±„ë¡œ ì¢Œâ†”ìš° ì´ë™"ì´ ëŠê¸°ì§€ ì•ŠìŒ
  (function bindDpadSwipe(){
    const zone = document.getElementById("dpadZone");
    if (!zone) return;

    let activePointerId = null;

    function setDirFromEvent(e){
      const r = zone.getBoundingClientRect();
      const x = e.clientX - r.left;
      const half = r.width / 2;

      if (x < half){
        keys["ArrowLeft"] = true;
        keys["ArrowRight"] = false;
      }else{
        keys["ArrowRight"] = true;
        keys["ArrowLeft"] = false;
      }
    }

    function clearDir(){
      keys["ArrowLeft"] = false;
      keys["ArrowRight"] = false;
    }

    zone.addEventListener("pointerdown", (e)=>{
      try{ e.preventDefault(); e.stopPropagation(); }catch(_){}
      activePointerId = e.pointerId;
      try{ zone.setPointerCapture(activePointerId); }catch(_){}
      setDirFromEvent(e);
    }, { passive:false });

    zone.addEventListener("pointermove", (e)=>{
      if (activePointerId === null) return;
      if (e.pointerId !== activePointerId) return;
      setDirFromEvent(e);
    }, { passive:true });

    zone.addEventListener("pointerup", (e)=>{
      if (e.pointerId !== activePointerId) return;
      activePointerId = null;
      clearDir();
    }, { passive:true });

    zone.addEventListener("pointercancel", (e)=>{
      if (e.pointerId !== activePointerId) return;
      activePointerId = null;
      clearDir();
    }, { passive:true });

    // í˜¹ì‹œ ìº¡ì²˜ê°€ ì•ˆ ë˜ëŠ” í™˜ê²½ ëŒ€ë¹„(ì•ˆì „ë§)
    zone.addEventListener("lostpointercapture", ()=>{
      activePointerId = null;
      clearDir();
    }, { passive:true });
  })();


  // ì í”„/ê³µê²© íƒ­
  if (btnJump){
    btnJump.addEventListener("pointerdown", (e)=>{ try{ e.preventDefault(); }catch(_){} tryJump(); });
  }
  if (btnAtk){
    btnAtk.addEventListener("pointerdown", (e)=>{ try{ e.preventDefault(); }catch(_){} tryThrowPaper(); });
  }

  if (btnAtkUp){
    btnAtkUp.addEventListener("pointerdown", (e)=>{ try{ e.preventDefault(); }catch(_){} tryThrowPaperUp(); });
  }


  window.addEventListener("keydown", (e) => {
    keys[e.code] = true;

    // ìŠ¤í¬ë¡¤ ë°©ì§€(ìŠ¤í˜ì´ìŠ¤)
    if (e.code === "Space") e.preventDefault();

    // ì í”„: Space
    if (e.code === "Space") tryJump();

    // ì„œë¥˜: KeyQ(ì•) / KeyW(ìœ„)
    if (e.code === "KeyQ") tryThrowPaper();
    if (e.code === "KeyW") tryThrowPaperUp();

    // â¸ Pause/Resume: P
    if (e.code === "KeyP"){
      e.preventDefault();
      togglePause();
    }
  }, { passive:false });

  window.addEventListener("keyup", (e) => {
    keys[e.code] = false;
  });

  function tryJump(){
    if (!alive()) return;
    if (player.onGround){
      player.vy = -16;
      player.onGround = false;
      TG_AUDIO.sfx("jump");
    }
  }

  let lastThrowAt = 0;
  const THROW_COOLDOWN = 220; // ms

  function tryThrowPaper(){
    if (!alive()) return;
    const now = performance.now();
    if (now - lastThrowAt < THROW_COOLDOWN) return;
    lastThrowAt = now;

    // ì„œë¥˜ ìƒì„± (í”Œë ˆì´ì–´ê°€ ë°”ë¼ë³´ëŠ” ë°©í–¥ìœ¼ë¡œ)
    const w = 26, h = 16;

    // face: ì˜¤ë¥¸ìª½=1, ì™¼ìª½=-1
    const dir = (player.face === -1 ? -1 : 1);

    // ì‹œì‘ ìœ„ì¹˜: ë°©í–¥ì— ë”°ë¼ ëª¸ ì•ìª½ì—ì„œ ë‚˜ì˜¤ê²Œ
    const x = (dir === 1) ? (player.x + player.w - 4) : (player.x - w + 4);
    const y = player.y + player.h * 0.45;

    // ì†ë„ë„ ë°©í–¥ ë°˜ì˜
    papers.push({ x, y, w, h, vx: 12 * dir, life: 63 });
    TG_AUDIO.sfx("shoot");
  }


// W: ìœ„ë¡œ ì„œë¥˜ ë˜ì§€ê¸°(ë“œë¡  ê³µê²©ìš©)
function tryThrowPaperUp(){
  if (!alive()) return;
  const now = performance.now();
  if (now - lastThrowAt < THROW_COOLDOWN) return;
  lastThrowAt = now;

  const w = 20, h = 28;

  // ì•½ê°„ ì•ìª½ì—ì„œ ìœ„ë¡œ ì˜¬ë¼ê°€ê²Œ(ë„ˆë¬´ ìˆ˜ì§ì´ë©´ ì¬ë¯¸ê°€ ëœí•¨)
  const dir = (player.face === -1 ? -1 : 1);
  const x = player.x + player.w*0.5 - w/2 + dir*10;
  const y = player.y + player.h*0.05; // âœ… ë” ìœ„ì—ì„œ ì‹œì‘(ë“œë¡ ê¹Œì§€ ë‹¿ê²Œ)

  papers.push({ x, y, w, h, vx: 1.8 * dir, vy: -22.0, life: 98 });
}

  function alive(){ return energy > 0; }

  // =============================
  // ìŠ¤í°(ì )
  // =============================
  let nextSpawn = 0;

  function spawnEnemy(){
    const idx = Math.floor(Math.random() * enemyImgs.length);
    const img = enemyImgs[idx];

    const baseW = 92, baseH = 92;
    const scale = 0.95 + Math.random() * 0.25;
    const w = Math.round(baseW * scale);
    const h = Math.round(baseH * scale);

    // ì¢Œ/ìš° ëœë¤ ë“±ì¥
    // side = -1 : left -> right
    // side =  1 : right -> left
    const side = (Math.random() < 0.5) ? 1 : -1;

    const spawnX = (side === 1)
      ? (CW() + 80 + Math.random() * 220)
      : (-80 - Math.random() * 220);

    enemies.push({
      x: spawnX,
      y: groundY() - h,
      w, h,
      img,
      hp: 1,

      side,
      face: (-side), // âœ… facing direction (1=right, -1=left)
      vy: 0,
      onGround: true,

      warnUntil: 0, // âœ… ğŸ’¥ ê²½ê³ (ë°œì‚¬ ì§ì „)

      nextShotAt: performance.now() + (() => { const g = getShotGap(); return g.min + Math.random()*(g.max-g.min); })(),
      nextJumpAt: performance.now() + (900 + Math.random()*1400)
    ,

      // âœ… ë°©í–¥ ì „í™˜(ëœë¤) : ê°€ë” ì˜¤ë¥¸ìª½ìœ¼ë¡œ ê°€ë‹¤ ì™¼ìª½ìœ¼ë¡œ / ë°˜ëŒ€ë¡œë„ ì „í™˜
      //  - ë„ˆë¬´ ìì£¼ ë°”ë€Œë©´ ì–´ì§€ëŸ¬ìš°ë‹ˆ 0.9~2.4ì´ˆ ê°„ê²©ìœ¼ë¡œë§Œ ê°€ëŠ¥
      nextTurnAt: performance.now() + (900 + Math.random()*1500),
      turnMinMs: 900,
      turnMaxMs: 2400,
      turnProb: 0.35});
  }
  // =============================
  // âœˆï¸ ë“œë¡ (ê³µì¤‘ ì´ë²¤íŠ¸ ì ) + ì†ŒìŒíƒ„(ğŸ’¥) ë‚™í•˜
  //  - ì²˜ì¹˜ ë¶ˆê°€ / í”¼í•˜ê¸°ë§Œ
  //  - ë§ìœ¼ë©´ ì§€ìƒ ì ê³¼ ë™ì¼í•˜ê²Œ ì—ë„ˆì§€ -1
  //  - ì „ì²´ ê³µê²© ì¤‘ 20% ë¯¸ë§Œ + ë“œë¡  ì—°ì† ë“±ì¥ ë°©ì§€(ì¿¨íƒ€ì„)
  // =============================
  const DRONE_MAX_RATIO = 0.42;      // âœ… ë“œë¡  ë¹„ìœ¨ ìƒí•œ(ì•½ 40%ëŒ€)
  const DRONE_SPAWN_CD  = 3800;      // âœ… ë“œë¡  ìµœì†Œ ë“±ì¥ ê°„ê²©(ms)
  const DRONE_WARN_MS   = 420;       // ë–¨ì–´ëœ¨ë¦¬ê¸° ì „ ğŸ’¥ ì˜ˆê³ (ms)

  function canSpawnDrone(now){
    // ê³µê²© ë¹„ìœ¨ì´ 18%ë¥¼ ë„˜ìœ¼ë©´ ìŠ¤í° ê¸ˆì§€
    const ratio = droneAttacks / Math.max(1, totalAttacks);
    if (ratio > DRONE_MAX_RATIO) return false;

    // ë„ˆë¬´ ìì£¼ ë“±ì¥ ë°©ì§€
    if (now - lastDroneSpawnAt < DRONE_SPAWN_CD) return false;

    return true;
  }

  function spawnDrone(now){
    // ë“œë¡ ì€ í™”ë©´ ìƒë‹¨, ì¢Œìš° ëœë¤ ìœ„ì¹˜ì— ì ê¹ ë“±ì¥
    const w = 110, h = 58;
    const x = 180 + Math.random() * (CW() - 360);
    const y = 78 + Math.random() * 70;

    drones.push({
      x, y, w, h,
      vx: (Math.random() < 0.5 ? -1 : 1) * (0.6 + Math.random()*0.6), // ì‚´ì§ ì¢Œìš° ë– ë‹¤ë‹˜
      attacksLeft: 2 + Math.floor(Math.random()*2), // 2~3íšŒ íˆ¬í•˜
      nextDropAt: now + (900 + Math.random()*900),   // ì²« íˆ¬í•˜ê¹Œì§€ ë”œë ˆì´
      dropAt: 0,              // ì‹¤ì œ íˆ¬í•˜ ì‹œê°(ì˜ˆê³  í¬í•¨)
      leaving: false
    });

    lastDroneSpawnAt = now;
  }

  function maybeSpawnDrone(now){
    // ìŠ¤í° ì¡°ê±´ + í™•ë¥ (ì²´ê°ìƒ "ê°€ë”"ë§Œ)
    if (!canSpawnDrone(now)) return;
    if (Math.random() > 0.65) return; // âœ… ì¡°ê±´ ë§Œì¡±í•´ë„ 65%ë§Œ ìŠ¤í°(ë¹„ìœ¨/ì¿¨íƒ€ì„ê³¼ í•¨ê»˜ 40%ëŒ€ ì²´ê°)
    spawnDrone(now);
  }

  function updateDrones(now, dtScale){
    if (!dtScale) dtScale = 1;
    for (let i = drones.length - 1; i >= 0; i--){
      const d = drones[i];

      // ì¢Œìš° ë¶€ìœ  ì´ë™
      d.x += d.vx * dtScale;
      if (d.x < 60){ d.x = 60; d.vx = Math.abs(d.vx); }
      if (d.x + d.w > CW() - 60){ d.x = CW() - 60 - d.w; d.vx = -Math.abs(d.vx); }

      // í‡´ì¥ ì²˜ë¦¬(íˆ¬í•˜ ëë‚˜ë©´ ìœ„ë¡œ ì‚¬ë¼ì§)
      if (d.leaving){
        d.y -= 1.8 * dtScale;
        if (d.y + d.h < -40) drones.splice(i,1);
        continue;
      }

      // íˆ¬í•˜ íƒ€ì´ë° ì„¤ì •(ì˜ˆê³  í¬í•¨)
      if (!d.dropAt && now > d.nextDropAt){
        d.dropAt = now + DRONE_WARN_MS; // ì˜ˆê³  í›„ ì‹¤ì œ íˆ¬í•˜
      }

      // ì‹¤ì œ íˆ¬í•˜
      if (d.dropAt && now >= d.dropAt){
        // ì†ŒìŒíƒ„(ğŸ’¥) ìƒì„±
        const bw = 22, bh = 22;
        droneBombs.push({
          x: d.x + d.w*0.5 - bw/2,
          y: d.y + d.h - 6,
          w: bw, h: bh,
          vy: 10 + levelT()*4,  // í›„ë°˜ì¼ìˆ˜ë¡ ì¡°ê¸ˆ ë¹ ë¥´ê²Œ
          life: 240
        });

        // ê³µê²© ì¹´ìš´íŠ¸(ë¹„ìœ¨ ì œì–´ìš©)
        droneAttacks++;
        totalAttacks++;

        d.attacksLeft--;
        d.dropAt = 0;
        d.nextDropAt = now + (900 + Math.random()*900);

        // ë‹¤ ë–¨ì–´ëœ¨ë ¸ìœ¼ë©´ í‡´ì¥
        if (d.attacksLeft <= 0){
          d.leaving = true;
        }
      }
    }
  }

  function updateDroneBombs(dtScale){
    if (!dtScale) dtScale = 1;
    for (let i = droneBombs.length - 1; i >= 0; i--){
      const b = droneBombs[i];
      b.y += b.vy * dtScale;
      b.life -= dtScale;

      // ë°”ë‹¥ì— ë‹¿ìœ¼ë©´ ì‚¬ë¼ì§
      if (b.y + b.h >= groundY()){
        droneBombs.splice(i,1);
        continue;
      }

      // í”Œë ˆì´ì–´ ë§ìŒ -> ì—ë„ˆì§€ -1 (ì§€ìƒ ì ê³¼ ë™ì¼)
      if (alive() && player.invuln === 0 && aabb(player, b)){
        energy = Math.max(0, energy - 1);
        TG_AUDIO.sfx("hurtCharacter");
        player.invuln = 70; // ì•½ 1ì´ˆ ë¬´ì 
        player.vy = -10;
        player.onGround = false;
        droneBombs.splice(i,1);
        continue;
      }

      if (b.life <= 0) droneBombs.splice(i,1);
    }
  }

  function drawDrones(now){
    for (const d of drones){
      // ë“œë¡  ê·¸ë¦¼ì(ë°”ë‹¥ì— ì•½í•˜ê²Œ)
      ctx.globalAlpha = 0.12;
      ctx.fillStyle = "#000";
      ctx.beginPath();
      ctx.ellipse(d.x + d.w/2, groundY()+8, 28, 9, 0, 0, Math.PI*2);
      ctx.fill();
      ctx.globalAlpha = 1;

      // ë“œë¡  ì´ë¯¸ì§€
      ctx.drawImage(droneImg, d.x, d.y, d.w, d.h);

      // ğŸ’¥ ì˜ˆê³ (íˆ¬í•˜ ì§ì „)
      if (d.dropAt){
        const dt = d.dropAt - now;
        if (dt > 0 && dt <= DRONE_WARN_MS){
          if (Math.floor(now / 110) % 2 === 1){
            ctx.save();
            ctx.font = "900 22px system-ui, -apple-system, Segoe UI, Roboto, sans-serif";
            ctx.textAlign = "center";
            ctx.textBaseline = "middle";
            ctx.fillStyle = "rgba(255,90,90,0.95)";
            ctx.shadowColor = "rgba(0,0,0,0.65)";
            ctx.shadowBlur = 10;
            ctx.fillText("ğŸ’¥", d.x + d.w*0.5, d.y - 14);
            ctx.restore();
          }
        }
      }
    }
  }

  function drawDroneBombs(){
    ctx.save();
    ctx.font = "900 20px system-ui, -apple-system, Segoe UI, Roboto, sans-serif";
    ctx.textAlign = "center";
    ctx.textBaseline = "middle";
    for (const b of droneBombs){
      // ì†ŒìŒíƒ„ì€ ğŸ’¥ ì´ëª¨ì§€ë¡œ í‘œí˜„
      ctx.fillText("ğŸ’¥", b.x + b.w/2, b.y + b.h/2);
    }
    ctx.restore();
  }


  // =============================
  // ì¶©ëŒ(AABB)
  // =============================

  // =============================
  // ì´í™íŠ¸: í­íŒŒ íŒŒí‹°í´ + ì  ë‚ ì•„ê°€ê¸°(í˜ì´ë“œ)
  // =============================
  function spawnExplosion(cx, cy){
    // ì‘ì€ í­ë°œ íŒŒí‹°í´ 14~22ê°œ
    const count = Math.round((14 + Math.floor(Math.random()*9)) * (LOW_POWER_STRICT?0.55:(LOW_POWER?0.65:1)));
    for (let i=0;i<count;i++){
      const ang = Math.random()*Math.PI*2;
      const spd = 2.5 + Math.random()*5.2;
      particles.push({
        x: cx + (Math.random()*8 - 4),
        y: cy + (Math.random()*8 - 4),
        vx: Math.cos(ang)*spd,
        vy: Math.sin(ang)*spd - (1.2 + Math.random()*1.6),
        r: 2 + Math.random()*3.2,
        life: 26 + Math.floor(Math.random()*18), // í”„ë ˆì„
        alpha: 1
      });
    }
  }

  function spawnEnemyDeathEffect(e){
    // 50%: í­íŒŒ / 50%: í•˜ëŠ˜ë¡œ ë‚ ì•„ê°
    const mode = (Math.random() < 0.5) ? "boom" : "fly";

    const cx = e.x + e.w*0.5;
    const cy = e.y + e.h*0.45;

    if (mode === "boom"){
      spawnExplosion(cx, cy);
      // í­íŒŒ ëŠë‚Œìœ¼ë¡œ ì ë„ ì‚´ì§ ìœ„ë¡œ íŠ•ê¸°ë©° ì‚¬ë¼ì§€ê¸°
      deathFx.push({
        x: e.x, y: e.y, w: e.w, h: e.h, img: e.img,
        vy: -(6 + Math.random()*4),
        rot: 0,
        vr: (Math.random()*0.24 + 0.12) * (Math.random()<0.5?-1:1),
        alpha: 1,
        life: 28,
        mode
      });
    } else {
      // í•˜ëŠ˜ë¡œ ë‚ ì•„ê°€ë©° íšŒì „/í˜ì´ë“œ
      deathFx.push({
        x: e.x, y: e.y, w: e.w, h: e.h, img: e.img,
        vy: -(10 + Math.random()*6),
        rot: 0,
        vr: (Math.random()*0.20 + 0.10) * (Math.random()<0.5?-1:1),
        alpha: 1,
        life: 46,
        mode
      });
    }
  }
  function aabb(a,b){
    return a.x < b.x + b.w &&
           a.x + a.w > b.x &&
           a.y < b.y + b.h &&
           a.y + a.h > b.y;
  }


  // =============================
  // ğŸ’¥ ë°œì‚¬ ì˜ˆê³ (ì†ŒìŒ í‘œì‹œ) : ì  ë¨¸ë¦¬ ìœ„ì— ğŸ’¥ê°€ ê¹œë¹¡ì„
  // =============================
  const WARN_MS = 320; // ë°œì‚¬ ëª‡ ms ì „ì— ë³´ì—¬ì¤„ì§€

  function drawEnemyWarning(e, now){
    if (!e || !e.warnUntil) return;

    // warnUntilì—ëŠ” "ì‹¤ì œ ë°œì‚¬ ì˜ˆì • ì‹œê°"ì´ ë“¤ì–´ìˆìŒ
    const dt = e.warnUntil - now;
    if (dt <= 0 || dt > WARN_MS) return;

    // ê¹œë¹¡ì„(100ms ì£¼ê¸°)
    if (Math.floor(now / 100) % 2 === 0) return;

    ctx.save();
    ctx.font = "900 22px system-ui, -apple-system, Segoe UI, Roboto, sans-serif";
    ctx.textAlign = "center";
    ctx.textBaseline = "middle";
    ctx.fillStyle = "rgba(255,90,90,0.95)";
    ctx.shadowColor = "rgba(0,0,0,0.65)";
    ctx.shadowBlur = 10;

    ctx.fillText("ğŸ’¥", e.x + e.w * 0.5, e.y - 14);
    ctx.restore();
  }
  // =============================
  // ì—…ë°ì´íŠ¸
  // =============================
  function update(dtScale){
    if (!dtScale) dtScale = 1;
    const now = performance.now();

    // ëª¨ë°”ì¼ ì„¸ë¡œ ëª¨ë“œë©´ ì§„í–‰ ì¤‘ì§€(ê°€ë¡œë¡œ ëŒë¦¬ë©´ ìë™ ì¬ê°œ)
    if (!updateRotateOverlay()) return;

    // ì‹œì¦Œ í´ë¦¬ì–´ë©´ ë” ì´ìƒ ì§„í–‰/ìŠ¤í° ì—†ìŒ
    if (typeof seasonComplete === 'boolean' && seasonComplete) return;

    // âœ… ë‹¨ê³„ ì‹œì‘ ì—°ì¶œ: 2ì´ˆ ë™ì•ˆ ê²Œì„ì„ ì ê¹ ë©ˆì¶¤
    if (now < levelPauseUntil) return;

    // âœ… ë‹¨ê³„ ì‹œê°„ ì¢…ë£Œ â†’ ë‹¤ìŒ ë‹¨ê³„ë¡œ
    const elapsedSec = (now - levelStartedAt) / 1000;
    if (elapsedSec >= levelDurationSec){
      if (level < SEASON_MAX){
        // âœ… ë‹¨ê³„ í´ë¦¬ì–´ ì‹œ ì €ì¥(1íšŒ)  â† Game2 íƒ­ row ìƒì„± íŠ¸ë¦¬ê±°
        tgGame2Save("stage_clear");

        // âœ… ë‹¨ê³„ í´ë¦¬ì–´ ë³´ìƒ(í‰ê·  ê³µê¸‰ëŸ‰ ì ìš©)
        grantStageEnergyOnClear(level);
        if (hudEnergy) hudEnergy.textContent = String(energy);

        const nextLv = level + 1;
        // âœ… 1~5ë‹¨ê³„ëŠ” ê²ŒìŠ¤íŠ¸ í”Œë ˆì´ OK, 6ë‹¨ê³„ë¶€í„°ëŠ” ì´ë©”ì¼ í•„ìš”
        if (!currentEmail && nextLv === (GUEST_MAX_LEVEL + 1)){
          _pendingNextLevel = nextLv;
          tgGame2EnsureEmail({ promptIfMissing: true, mode: "level6" });
          return;
        }
        startLevel(nextLv);
      } else {
        seasonComplete = true;
        try{ document.getElementById("seasonOverlay").style.display = "flex"; }catch(e){}
      }
      return;
    }


    // =============================
    // ì´í™íŠ¸ ì—…ë°ì´íŠ¸(íŒŒí‹°í´/ì£½ìŒ ì—°ì¶œ)
    // =============================
    for (let i = particles.length - 1; i >= 0; i--){
      const p = particles[i];
      p.vy += 0.28 * dtScale;
      p.x += p.vx * dtScale;
      p.y += p.vy * dtScale;
      p.life -= dtScale;
      p.alpha = Math.max(0, p.life / 36);
      // ì•½ê°„ ê°ì†
      p.vx *= Math.pow(0.96, dtScale);
      p.vy *= Math.pow(0.98, dtScale);
      if (p.life <= 0) particles.splice(i,1);
    }

    
    // âœ… ë‹¬ë¦´ ë•Œ ì†ë„ì„ (ëª¨ì…˜ ë¸”ëŸ¬ ëŠë‚Œ) ì—…ë°ì´íŠ¸
    for (let i = speedLines.length - 1; i >= 0; i--){
      const s = speedLines[i];
      // ì•½ê°„ ë’¤ë¡œ ë°€ë¦¬ë©° ì‚¬ë¼ì§
      s.x1 += s.vx * dtScale;
      s.x2 += s.vx * dtScale;
      s.life -= dtScale;
      s.alpha = Math.max(0, s.life / 14);
      if (s.life <= 0) speedLines.splice(i,1);
    }

// âœ… ë°œë°‘ ë¨¼ì§€(ë‹¬ë¦´ ë•Œ) ì—…ë°ì´íŠ¸
    for (let i = footDust.length - 1; i >= 0; i--){
      const d = footDust[i];
      d.vy += 0.18 * dtScale;
      d.x += d.vx * dtScale;
      d.y += d.vy * dtScale;
      d.life -= dtScale;
      d.alpha = Math.max(0, d.life / 22);
      d.vx *= Math.pow(0.92, dtScale);
      d.vy *= Math.pow(0.98, dtScale);
      if (d.life <= 0) footDust.splice(i,1);
    }


    for (let i = deathFx.length - 1; i >= 0; i--){
      const d = deathFx[i];
      d.vy += 0.30 * dtScale;
      d.y += d.vy * dtScale;
      d.rot += d.vr * dtScale;
      d.life -= dtScale;
      d.alpha = Math.max(0, d.life / (d.mode === "fly" ? 46 : 28));
      if (d.life <= 0) deathFx.splice(i,1);
    }

    // HUD(í˜¹ì‹œë¼ë„)
    if (hudLevel) hudLevel.textContent = String(level);

    // ë‹¨ê³„ì— ë”°ë¼ ì›”ë“œ ì†ë„ ì ìš©

    scrollSpeed = getScrollSpeed();
    // =============================
    // ì¢Œ / ìš° ì´ë™ (â† â†’ ë˜ëŠ” A / D)
    // =============================
    const MOVE_SPEED = 6;
    if (keys["ArrowLeft"] || keys["KeyA"]) {
      player.vx = -MOVE_SPEED;
      player.face = -1;
    } else if (keys["ArrowRight"] || keys["KeyD"]) {
      player.vx = MOVE_SPEED;
      player.face = 1;
    } else {
      player.vx = 0;
    }
    player.x += player.vx * dtScale;
    // í™”ë©´ ë°–ìœ¼ë¡œ ëª» ë‚˜ê°€ê²Œ
    player.x = Math.max(0, Math.min(CW() - player.w, player.x));

    // ì¤‘ë ¥
    player.vy += 0.85 * dtScale;
    player.y += player.vy * dtScale;

    // ë°”ë‹¥
    const gy = groundY(); // âœ… physics ground aligns with road top

    if (player.y + player.h >= gy){
      player.y = gy - player.h;
      player.vy = 0;
      player.onGround = true;
    }

    
    // âœ… ë‹¬ë¦´ ë•Œ ì†ë„ì„ (ëª¨ì…˜ ë¸”ëŸ¬ ëŠë‚Œ)
    if (player.onGround && Math.abs(player.vx) > 0.5){
      // ì„±ëŠ¥ ê³ ë ¤: ë‚®ì€ í™•ë¥ ë¡œë§Œ ìƒì„±
      const chance = (LOW_POWER_STRICT ? 0.26 : 0.38) * dtScale;
      if (Math.random() < chance){
        const dir = (player.vx < 0 ? -1 : 1); // -1: ì™¼ìª½ìœ¼ë¡œ ë‹¬ë¦¼, 1: ì˜¤ë¥¸ìª½ìœ¼ë¡œ ë‹¬ë¦¼
        const baseY = player.y + 28 + Math.random()*52; // ëª¸í†µ~ë‹¤ë¦¬ ê·¼ì²˜
        const len = 22 + Math.random()*28;              // ì„  ê¸¸ì´
        const tilt = (Math.random()*10 - 5);            // ì‚´ì§ ê¸°ìš¸ì´ê¸°
        const tail = (dir === 1) ? (player.x - 10 - Math.random()*28) : (player.x + player.w + 10 + Math.random()*28);
        const head = tail - dir * len;

        speedLines.push({
          x1: tail,
          y1: baseY,
          x2: head,
          y2: baseY + tilt,
          vx: -dir * (2.2 + Math.random()*1.6), // ë‹¬ë¦¬ëŠ” ë°˜ëŒ€ ë°©í–¥ìœ¼ë¡œ ì‚´ì§ íë¥´ê¸°
          life: 10 + Math.random()*6,
          alpha: 1
        });

        // ë„ˆë¬´ ë§ì•„ì§€ë©´ ì œí•œ(ëª¨ë°”ì¼ ì•ˆì •)
        if (speedLines.length > (LOW_POWER_STRICT ? 18 : 30)) speedLines.shift();
      }
    }

// âœ… ë‹¬ë¦´ ë•Œ ë°œë°‘ ë¨¼ì§€ ì´í™íŠ¸(ë…¸ë€ ì°¨ì„  ëŒ€ì‹  'ì†ë„ê°' ìš©)
    if (player.onGround && Math.abs(player.vx) > 0.5){
      // ê¸°ê¸° ì„±ëŠ¥/í”„ë ˆì„ì— ë”°ë¼ ìë™ ì¡°ì ˆ
      const chance = (LOW_POWER_STRICT ? 0.18 : 0.28) * dtScale;
      if (Math.random() < chance){
        const dir = (player.vx < 0 ? -1 : 1);
        footDust.push({
          x: player.x + player.w*0.35 + Math.random()*18,
          y: groundY() + 6 + Math.random()*6,
          vx: (-2.2*dir) + (Math.random()*-1.2),
          vy: -1.6 - Math.random()*1.4,
          r: 2 + Math.random()*2.6,
          life: 18 + Math.random()*8,
          alpha: 1
        });
      }
    }


    if (player.invuln > 0) player.invuln = Math.max(0, player.invuln - dtScale);

    // ì„œë¥˜ ì´ë™ (Q: ì• / W: ìœ„)
for (let i = papers.length - 1; i >= 0; i--){
  const p = papers[i];
  p.x += p.vx * dtScale;
  if (typeof p.vy === "number") {
    p.y += p.vy * dtScale;
    // ìœ„ë¡œ ë˜ì§„ ì„œë¥˜ëŠ” ì‚´ì§ ì¤‘ë ¥ ì ìš©
    p.vy += 0.35 * dtScale;
  }
  p.life -= dtScale;

  // í™”ë©´ ë°– / ìˆ˜ëª… ë
  const outX = (p.x > CW() + 80) || ((p.x + p.w) < -80);
  const outY = (p.y + p.h < -220) || (p.y > CH() + 220);
  if (outX || outY || p.life <= 0){
    papers.splice(i,1);
  }
}

    
    // ì  íˆ¬ì‚¬ì²´(ì´ì•Œ/ëŒ) ì´ë™
    for (let i = enemyShots.length - 1; i >= 0; i--){
      const s = enemyShots[i];
      s.x += s.vx * dtScale;
      s.life -= dtScale;

      // í”Œë ˆì´ì–´ì™€ ì¶©ëŒ -> ì—ë„ˆì§€ ê°ì†Œ
      if (alive() && player.invuln === 0 && aabb(player, s)){
        energy = Math.max(0, energy - 1);
        TG_AUDIO.sfx("hurtCharacter");
        player.invuln = 70; // ì•½ 1ì´ˆ ë¬´ì 
        // ì‚´ì§ íŠ•ê¸°ê¸°
        player.vy = -10;
        player.onGround = false;
        enemyShots.splice(i,1);
        continue;
      }

      // í™”ë©´ ë°– / ìˆ˜ëª… ë
      if ((s.vx < 0 && (s.x + s.w) < -160) || (s.vx > 0 && s.x > CW() + 160) || s.life <= 0){
        enemyShots.splice(i,1);
      }
    }
    // =============================
    // ë“œë¡ (ê³µì¤‘) + ì†ŒìŒíƒ„(ğŸ’¥)
    // =============================
    updateDrones(now, dtScale);
    updateDroneBombs(dtScale);


// âœ… ë“œë¡ ì„ ì„œë¥˜ë¡œ ê³µê²© ê°€ëŠ¥(Wë¡œ ìœ„ë¡œ ë˜ì ¸ ë§ì¶”ê¸°)
for (let di = drones.length - 1; di >= 0; di--){
  const d = drones[di];
  // âœ… í™”ë©´ ì•ˆì—ì„œë§Œ ë“œë¡  ì²˜ì¹˜ ê°€ëŠ¥(ìŠ¤í° ì§í›„ í™”ë©´ ë°–ì—ì„œ ë§ëŠ” í˜„ìƒ ë°©ì§€)
  const droneOnScreen = (d.x + d.w > 0) && (d.x < CW()) && (d.y + d.h > 0) && (d.y < CH());
  if (!droneOnScreen) continue;
  for (let pj = papers.length - 1; pj >= 0; pj--){
    const p = papers[pj];
    if (aabb(p, d)){
      // ë“œë¡  ì œê±° + ë³´ìƒ(ì‚¬í† ì‹œ 1)
      drones.splice(di, 1);
      papers.splice(pj, 1);

      TG_AUDIO.sfx("dropCoin");
          coins.push({
        x: d.x + d.w * 0.5,
        y: d.y + d.h * 0.5,
        r: 12,
        vy: -6,
        life: 600
      });
      break;
    }
  }
}


// ì  ìŠ¤í° íƒ€ì´ë° (ë‹¨ê³„ê°€ ì˜¬ë¼ê°ˆìˆ˜ë¡ ë” ìì£¼)
    if (performance.now() > nextSpawn && alive()){
      spawnEnemy();
      maybeSpawnDrone(performance.now());
      const g = getSpawnGap();
      nextSpawn = performance.now() + (g.min + Math.random() * (g.max - g.min));
    }

    // ì  ì´ë™
    for (let i = enemies.length - 1; i >= 0; i--){
      const e = enemies[i];

      // ì¢Œ/ìš° ëª¨ë‘ì—ì„œ ì´ë™
      // e.side = 1  -> ì˜¤ë¥¸ìª½ì—ì„œ ì™¼ìª½ìœ¼ë¡œ(ê¸°ì¡´ì²˜ëŸ¼)
      // e.side = -1 -> ì™¼ìª½ì—ì„œ ì˜¤ë¥¸ìª½ìœ¼ë¡œ
      e.x -= scrollSpeed * e.side * dtScale;

      // âœ… (NEW) ì ì´ ê°€ë” ë°©í–¥ ì „í™˜í•˜ë„ë¡
      // side ì˜ë¯¸:
      //   side =  1  -> ì˜¤ë¥¸ìª½ì—ì„œ ì™¼ìª½ìœ¼ë¡œ(ì™¼ìª½ ì´ë™)
      //   side = -1  -> ì™¼ìª½ì—ì„œ ì˜¤ë¥¸ìª½ìœ¼ë¡œ(ì˜¤ë¥¸ìª½ ì´ë™)
      //
      // 1) í™”ë©´ ê°€ì¥ìë¦¬ ê·¼ì²˜ë©´ ìë™ìœ¼ë¡œ ì•ˆìª½ìœ¼ë¡œ ëŒë¦¬ê¸°(ê²€ì€ í™”ë©´/ì¦‰ì‹œ í‡´ì¥ ë°©ì§€)
      const EDGE = 24;
      if (e.x < EDGE) e.side = -1; // ë„ˆë¬´ ì™¼ìª½ì´ë©´ ì˜¤ë¥¸ìª½ìœ¼ë¡œ
      if (e.x + e.w > CW() - EDGE) e.side = 1; // ë„ˆë¬´ ì˜¤ë¥¸ìª½ì´ë©´ ì™¼ìª½ìœ¼ë¡œ

      // 2) í‰ì†Œì—ëŠ” 'ê°€ë”' ëœë¤ìœ¼ë¡œ ë°©í–¥ ì „í™˜
      const nowTurn = performance.now();
      if (e.onGround && nowTurn > (e.nextTurnAt || 0)){
        // í”Œë ˆì´ì–´ê°€ ê°€ê¹Œìš°ë©´(í™”ë©´ ì•ˆìª½) ë°©í–¥ ì „í™˜ í™•ë¥ ì„ ì¡°ê¸ˆ ë‚®ì¶°ì„œ ë” ìì—°ìŠ¤ëŸ½ê²Œ
        const px = player.x + player.w/2;
        const ex = e.x + e.w/2;
        const dist = Math.abs(px - ex);

        const baseProb = (typeof e.turnProb === "number") ? e.turnProb : 0.35;
        const prob = (dist < 320) ? baseProb * 0.55 : baseProb; // ê°€ê¹Œìš°ë©´ ëœ ëŒê¸°

        if (Math.random() < prob){
          e.side *= -1;
        }
        const minMs = e.turnMinMs || 900;
        const maxMs = e.turnMaxMs || 2400;
        e.nextTurnAt = nowTurn + (minMs + Math.random() * (maxMs - minMs));
      }

      // âœ… face direction follows movement
      e.face = (-e.side);
// ëœë¤ ì í”„(ì •ì  ëŠë‚Œ ì œê±°) - ë‹¨ê³„ê°€ ì˜¬ë¼ê°ˆìˆ˜ë¡ ì¡°ê¸ˆ ë” ìì£¼
      const nowT = performance.now();
      const jt = levelT(); // 0~1
      const jumpChance = 0.10 + jt * 0.18; // 10% ~ 28%
      if (e.onGround && nowT > (e.nextJumpAt || 0) && Math.random() < jumpChance){
        e.vy = -(10 + Math.random() * 5); // ì í”„ ë†’ì´
        e.onGround = false;
        e.nextJumpAt = nowT + (650 + Math.random()*1400); // ë‹¤ìŒ ì í”„ íƒ€ì´ë°
      }

      // ì¤‘ë ¥
      e.vy += 0.85 * dtScale;
      e.y += e.vy * dtScale;

      // ë°”ë‹¥ ì²˜ë¦¬
      const gy2 = groundY();
      if (e.y + e.h >= gy2){
        e.y = gy2 - e.h;
        e.vy = 0;
        e.onGround = true;
      }

      // âœ… ì ë„ ë‹¬ë¦´ ë•Œ 'ë‹¤ë¦¬ ê·¼ì²˜ ì´í™íŠ¸'(ì£¼ì¸ê³µì²˜ëŸ¼ ìì—°ìŠ¤ëŸ½ê²Œ)
      // - ë‹¤ë¦¬ í”„ë ˆì„ì´ ì—†ì–´ì„œ, ë°œë°‘ ë¨¼ì§€ + ì§§ì€ ì†ë„ì„ ë§Œ ì¶”ê°€
      if (e.onGround){
        const evx = -scrollSpeed * e.side; // í™”ë©´ ê¸°ì¤€ ì´ë™ ë°©í–¥
        if (Math.abs(evx) > 0.5){
          const dir = (evx < 0 ? -1 : 1);

          // (1) ë°œë°‘ ë¨¼ì§€(ì£¼ì¸ê³µë³´ë‹¤ ì•½í•˜ê²Œ)
          const dustChance = (LOW_POWER_STRICT ? 0.10 : 0.16) * dtScale;
          if (Math.random() < dustChance){
            footDust.push({
              x: e.x + e.w*0.35 + Math.random()*18,
              y: groundY() + 6 + Math.random()*6,
              vx: (-1.6*dir) + (Math.random()*-0.9),
              vy: -1.2 - Math.random()*1.0,
              r: 1.8 + Math.random()*2.0,
              life: 14 + Math.random()*7,
              alpha: 1
            });
          }

          // (2) ì§§ì€ ì†ë„ì„ (ì£¼ì¸ê³µë³´ë‹¤ ì ê²Œ)
          const lineChance = (LOW_POWER_STRICT ? 0.12 : 0.18) * dtScale;
          if (Math.random() < lineChance){
            const baseY = e.y + 26 + Math.random()*44;
            const len = 16 + Math.random()*18;
            const tilt = (Math.random()*8 - 4);
            const tail = (dir === 1) ? (e.x - 8 - Math.random()*20) : (e.x + e.w + 8 + Math.random()*20);
            const head = tail - dir * len;

            speedLines.push({
              x1: tail,
              y1: baseY,
              x2: head,
              y2: baseY + tilt,
              vx: -dir * (1.6 + Math.random()*1.2),
              life: 8 + Math.random()*5,
              alpha: 1
            });

            if (speedLines.length > (LOW_POWER_STRICT ? 22 : 34)) speedLines.shift();
          }
        }
      }

      // ì ì´ ì¼ì • ê°„ê²©ìœ¼ë¡œ í•œ ë°œì”© ë˜ì§(íˆ¬ì‚¬ì²´)
      const nowT2 = performance.now();

      // âœ… ë°œì‚¬ ì§ì „ ğŸ’¥ ê²½ê³ (ì†ŒìŒ í‘œì‹œ)
      if (alive() && e.warnUntil === 0 && nowT2 > (e.nextShotAt - WARN_MS) && nowT2 <= e.nextShotAt && e.x < CW() - 120 && e.x > -40){
        e.warnUntil = e.nextShotAt; // "ë°œì‚¬ ì˜ˆì • ì‹œê°" ì €ì¥
      }

      if (alive() && nowT2 > e.nextShotAt && e.x < CW() - 120 && e.x > -40){
        const bw = 18, bh = 10;
        const bx = (e.side === 1) ? (e.x - 8) : (e.x + e.w - 10);
        const by = e.y + e.h * 0.55;
        enemyShots.push({
          x: bx, y: by, w: bw, h: bh,
          vx: -(scrollSpeed + getEnemyShotSpeed()) * e.side,
          life: 240
        });
        totalAttacks++; // âœ… ì „ì²´ ê³µê²© ì¹´ìš´íŠ¸(ë“œë¡  20% ì œì–´ìš©)
        e.warnUntil = 0; // âœ… ê²½ê³  í•´ì œ
        const g = getShotGap();
        e.nextShotAt = nowT2 + (g.min + Math.random()*(g.max-g.min));
      }

      // í”Œë ˆì´ì–´ì™€ ì¶©ëŒ -> ì—ë„ˆì§€ ê°ì†Œ
      if (alive() && player.invuln === 0 && aabb(player, e)){
        energy = Math.max(0, energy - 1);
        TG_AUDIO.sfx("hurtCharacter");
        player.invuln = 70; // ì•½ 1ì´ˆ ë¬´ì 
        player.vy = -10;
        player.onGround = false;
      }

      // ì„œë¥˜ì™€ ì¶©ëŒ -> ì  ì œê±° + ì‚¬í† ì‹œ ì½”ì¸ ìƒì„± (+ 10% í™•ë¥  ì—ë„ˆì§€ ë“œë)
      // âœ… í™”ë©´ ì•ˆ(ë³´ì´ëŠ” êµ¬ê°„)ì—ì„œë§Œ ì²˜ì¹˜ ê°€ëŠ¥: ìŠ¤í° ì§í›„(í™”ë©´ ë°–) 'ì„ ì œ ì²˜ì¹˜' ë°©ì§€
      const enemyOnScreen = (e.x + e.w > 0) && (e.x < CW());
      let killed = false;
      if (enemyOnScreen){
      for (let j = papers.length - 1; j >= 0; j--){
        const p = papers[j];
        if (aabb(p, e)){
          // âœ… ì£½ëŠ” ì—°ì¶œ(í­íŒŒ or í•˜ëŠ˜ë¡œ ë‚ ì•„ê°)
          spawnEnemyDeathEffect(e);
          TG_AUDIO.sfx("hurtEnemy");

          // ì œê±°
          enemies.splice(i,1);
          papers.splice(j,1);
          killed = true;

          // âœ… ê¸°ë³¸ ë³´ìƒ: ì‚¬í† ì‹œ 1ê°œ
          coins.push({
            x: e.x + e.w * 0.5,
            y: e.y + e.h * 0.35,
            r: 12,
            vy: -6,
            life: 600
          });

          // âœ… ì¶”ê°€ ë³´ìƒ: í™•ë¥ ë¡œ ì—ë„ˆì§€(í•˜íŠ¸) 1ê°œ ë“œë (í›„ë°˜ì¼ìˆ˜ë¡ ë‚®ì•„ì§)
          if (energy < ENERGY_CAP && Math.random() < getHeartDropChance()){
            energyDrops.push({
              x: e.x + e.w * 0.5 + (Math.random()*18 - 9),
              y: e.y + e.h * 0.22,
              r: 14,
              vy: -7,
              life: 600
            });
          }
          break;
        }
      }
      }
      if (killed) continue;

      // í™”ë©´ ë°–(ë°©í–¥ë³„ ì œê±°)
      if ((e.side === 1 && (e.x + e.w) < -180) || (e.side === -1 && e.x > CW() + 180)) {
        enemies.splice(i,1);
      }
    }

    // ì½”ì¸ ë¬¼ë¦¬/íšë“
    for (let i = coins.length - 1; i >= 0; i--){
      const c = coins[i];
      c.vy += 0.45 * dtScale;
      c.y += c.vy * dtScale;
      c.life -= dtScale;

      // ë°”ë‹¥ íŠ•ê¹€(í•œ ë²ˆ ëŠë‚Œ)
      const floor = groundY() - 10;
      if (c.y > floor){
        c.y = floor;
        c.vy *= -0.35;
        if (Math.abs(c.vy) < 0.8) c.vy = 0;
      }

      // í”Œë ˆì´ì–´ íšë“ (ì›í˜•-ì‚¬ê°í˜• ê°„ë‹¨ íŒì •)
      const px = player.x + player.w/2;
      const py = player.y + player.h/2;
      const dx = Math.abs(c.x - px);
      const dy = Math.abs(c.y - py);
      if (dx < (player.w/2 + c.r) && dy < (player.h/2 + c.r)){
        score += 1;
        totalSatoshi += 1;
        _dirty = true;
        if (score === 1) tgGame2Save("first_coin");
        TG_AUDIO.sfx("coinRecieved");
        coins.splice(i,1);
        continue;
      }

      // ì˜¤ë˜ë˜ë©´ ì‚¬ë¼ì§
      if (c.life <= 0) coins.splice(i,1);
    }
    // ì—ë„ˆì§€ ë“œë ë¬¼ë¦¬/íšë“ (10% í™•ë¥  ë“œë)
    for (let i = energyDrops.length - 1; i >= 0; i--){
      const h = energyDrops[i];
      h.vy += 0.45 * dtScale;
      h.y += h.vy * dtScale;
      h.life -= dtScale;

      // ë°”ë‹¥ íŠ•ê¹€
      const floor = groundY() - 12;
      if (h.y > floor){
        h.y = floor;
        h.vy *= -0.35;
        if (Math.abs(h.vy) < 0.8) h.vy = 0;
      }

      // í”Œë ˆì´ì–´ íšë“
      const px = player.x + player.w/2;
      const py = player.y + player.h/2;
      const dx = Math.abs(h.x - px);
      const dy = Math.abs(h.y - py);
      if (dx < (player.w/2 + h.r) && dy < (player.h/2 + h.r)){
        // ì—ë„ˆì§€ +1 (ìµœëŒ€ 15 ìº¡)
        const cap = ENERGY_CAP;
        energy = Math.min(cap, energy + 1);
        energyDrops.splice(i,1);
        continue;
      }

      if (h.life <= 0) energyDrops.splice(i,1);
    }


    // HUD
    hudEnergy.textContent = String(energy);
    hudScore.textContent = String(score);
    if (hudTotal) hudTotal.textContent = String(totalSatoshi);

    // Game Over ì €ì¥(1íšŒ)
    // âœ… ì£½ìœ¼ë©´ ë‹¤ìŒ ëŸ°ì€ ë¬´ì¡°ê±´ 1ë‹¨ê³„ë¶€í„° ì‹œì‘ë˜ë„ë¡ levelì„ 1ë¡œ ë¦¬ì…‹í•´ì„œ ì €ì¥í•©ë‹ˆë‹¤.
    // (ì—ë„ˆì§€ë¥¼ 0ìœ¼ë¡œ ì €ì¥í•´ë‘ë©´, ë‹¤ìŒ ì‹œì‘(startLevel(1))ì—ì„œ ENERGY_STARTë¡œ ìë™ ë¦¬ì…‹ë©ë‹ˆë‹¤.)
    if (energy <= 0 && !_gameOverSaved){
      _gameOverSaved = true;

      level = 1;
      energy = 0;
      score = 0; // í˜„ì¬ ì‚¬í† ì‹œ ì‚¬í† ì‹œ(ì ìˆ˜)ëŠ” ë¦¬ì…‹ (ëˆ„ì  ì‚¬í† ì‹œ totalSatoshiëŠ” ê·¸ëŒ€ë¡œ)

      try{ if (hudLevel) hudLevel.textContent = "1"; }catch(_){ }
      try{ if (hudEnergy) hudEnergy.textContent = "0"; }catch(_){ }
      try{ if (hudScore) hudScore.textContent = "0"; }catch(_){ }

      tgGame2Save("gameover");
    }

  }

  // =============================
  // ë Œë”
  // =============================
  let t = 0;
  function draw(){
    // âœ… ì‹¤ì œ í™”ë©´ ì „ì²´ í´ë¦¬ì–´(í”½ì…€ ì¢Œí‘œ)
    ctx.setTransform(1,0,0,1,0,0);
    ctx.clearRect(0,0,canvas.width,canvas.height);

    // âœ… ë°ìŠ¤í¬íƒ‘ì—ì„œ ë‚¨ëŠ” ì˜ì—­(ë ˆí„°ë°•ìŠ¤)ì´ 'ê·¸ë¦¼ì'ì²˜ëŸ¼ ë³´ì´ì§€ ì•Šê²Œ ê²€ì •ìœ¼ë¡œ ì±„ì›€
    ctx.fillStyle = "#000";
    ctx.fillRect(0,0,canvas.width,canvas.height);

    // âœ… ê°€ìƒ í™”ë©´ì„ í™”ë©´ì— ë§ê²Œ ì¶•ì†Œ/ì¤‘ì•™ì •ë ¬(ì¤Œì•„ì›ƒ)
    ctx.setTransform(viewScale,0,0,viewScale,viewOffX,viewOffY);
    ctx.fillStyle = "#000";
    ctx.fillRect(0,0,CW(),CH());
// =============================
// ë°°ê²½(ì…ì²´ê° íŒ¨ëŸ´ë™ìŠ¤) + ë„ë¡œ/ë³´ë„
// =============================
// âœ… ë°°ê²½: ë‹¨ê³„(level)ë§ˆë‹¤ 10ê°œ ì¤‘ ëœë¤ìœ¼ë¡œ ì„ íƒ(=startLevelì—ì„œ pickRandomBg)
//    ë°°ê²½ì€ ìŠ¤í¬ë¡¤í•˜ì§€ ì•Šê³ , í”Œë ˆì´ì–´/ì  ì›€ì§ì„ì— ë§ì¶° ì¢Œìš°ë¡œ ì‚´ì§ í”ë“¤ë¦¬ê²Œ
const now = performance.now();
drawRandomBackground(now);

// (2) ë„ë¡œ/ë³´ë„: ì§ì ‘ ê·¸ë ¤ì„œ 'ê²Œì„ ì™„ì„± ëŠë‚Œ'
drawRoadAndSidewalk(bgState.theme);

    // =============================
    // ë“œë¡ (ê³µì¤‘) + ì†ŒìŒíƒ„(ğŸ’¥)
    // =============================
    drawDrones(now);
    drawDroneBombs();

    
    // âœ… ë‹¬ë¦´ ë•Œ ì†ë„ì„ (ëª¨ì…˜ ë¸”ëŸ¬ ëŠë‚Œ) - ìºë¦­í„° ë’¤ì—ë§Œ ì‚´ì§
    ctx.save();
    ctx.lineCap = "round";
    ctx.strokeStyle = "rgba(255,255,255,0.9)";
    ctx.lineWidth = 3;
    for (const s of speedLines){
      ctx.globalAlpha = Math.max(0, s.alpha) * 0.35;
      ctx.beginPath();
      ctx.moveTo(s.x1, s.y1);
      ctx.lineTo(s.x2, s.y2);
      ctx.stroke();
    }
    ctx.restore();
    ctx.globalAlpha = 1;

// âœ… ë°œë°‘ ë¨¼ì§€(ì†ë„ê°)
    for (const d of footDust){
      ctx.globalAlpha = Math.max(0, d.alpha) * 0.55;
      ctx.fillStyle = "rgba(255,255,255,0.9)";
      ctx.beginPath();
      ctx.arc(d.x, d.y, d.r, 0, Math.PI*2);
      ctx.fill();
    }
    ctx.globalAlpha = 1;

    // í”Œë ˆì´ì–´ ê·¸ë¦¼ì
    ctx.globalAlpha = 0.25;
    ctx.fillStyle = "#000";
    ctx.beginPath();
    ctx.ellipse(player.x + player.w/2, groundY()+8, 26, 9, 0, 0, Math.PI*2);
    ctx.fill();
    ctx.globalAlpha = 1;

    // í”Œë ˆì´ì–´ (í”¼ê²© ì‹œ ê¹œë¹¡) + ì‚´ì•„ì›€ì§ì„(ìˆ¨ì‰¬ê¸°/ëŸ°ë°”ìš´ìŠ¤/ì í”„ ìŠ¤ì¿¼ì‹œ)
    const blink = (player.invuln > 0) && ((player.invuln % 10) < 5);

    // (ìœ„ì—ì„œ const now ì •ì˜ë¨)
    const breathe = 0; // âœ… keep feet grounded (no vertical bob)
    const runBob  = 0; // âœ… keep feet grounded (no vertical bob)

    // ì í”„ ì¤‘ì´ë©´ ì„¸ë¡œë¡œ ëŠ˜ë¦¬ê³ , ê°€ë¡œë¡œ ì‚´ì§ ì¤„ì´ê¸°(ìŠ¤ì¿¼ì‹œ/ìŠ¤íŠ¸ë ˆì¹˜)
    let scaleX = 1, scaleY = 1;
    if (!player.onGround) { scaleX = 0.95; scaleY = 1.06; }
    else if (player.vx !== 0) { scaleX = 1.02; scaleY = 0.98; }

    // íˆ¬ëª…ë„(í”¼ê²© ê¹œë¹¡)
    if (blink) ctx.globalAlpha = 0.35;

    // ê°€ìš´ë° ê¸°ì¤€ìœ¼ë¡œ ìŠ¤ì¼€ì¼ ì ìš©
    ctx.save();
    const cx = player.x + player.w/2;
    const cy = player.y + player.h/2 + breathe + runBob;

    // ë°©í–¥(ì¢Œ/ìš°)ë„ ë°˜ì˜
    ctx.translate(cx, cy);
    ctx.scale(scaleX * player.face, scaleY);
    ctx.drawImage(playerImg, -player.w/2, -player.h/2 + PLAYER_SPRITE_Y_OFFSET, player.w, player.h);
    ctx.restore();

    ctx.globalAlpha = 1;

    // ì„œë¥˜(íˆ¬ì‚¬ì²´)
    for (const p of papers){
      // ì¢…ì´ ë°”íƒ•
      ctx.fillStyle = "#fff";
      ctx.strokeStyle = "rgba(0,0,0,0.35)";
      ctx.lineWidth = 2;
      ctx.beginPath();
      ctx.roundRect(p.x, p.y, p.w, p.h, 4);
      ctx.fill();
      ctx.stroke();

      // í…ìŠ¤íŠ¸ ì¤„(ëŠë‚Œë§Œ)
      ctx.strokeStyle = "rgba(0,0,0,0.2)";
      ctx.lineWidth = 1;
      ctx.beginPath();
      ctx.moveTo(p.x+5, p.y+6); ctx.lineTo(p.x+p.w-5, p.y+6);
      ctx.moveTo(p.x+5, p.y+10); ctx.lineTo(p.x+p.w-10, p.y+10);
      ctx.stroke();
    }

    // ì  íˆ¬ì‚¬ì²´(ì´ì•Œ/ëŒ)
    for (const s of enemyShots){
      ctx.fillStyle = "rgba(255,255,255,0.92)";
      ctx.strokeStyle = "rgba(0,0,0,0.35)";
      ctx.lineWidth = 2;
      ctx.beginPath();
      ctx.roundRect(s.x, s.y, s.w, s.h, 6);
      ctx.fill();
      ctx.stroke();

      ctx.fillStyle = "rgba(207,48,74,0.9)";
      ctx.beginPath();
      ctx.arc(s.x + s.w - 4, s.y + s.h/2, 3, 0, Math.PI*2);
      ctx.fill();
    }


    // ì 
    for (const e of enemies){
      // ê·¸ë¦¼ì
      ctx.globalAlpha = 0.18;
      ctx.fillStyle = "#000";
      ctx.beginPath();
      ctx.ellipse(e.x + e.w/2, groundY()+8, 22, 7, 0, 0, Math.PI*2);
      ctx.fill();
      ctx.globalAlpha = 1;

      // ì´ë¯¸ì§€ (ì¢Œ/ìš° ì´ë™ ë°©í–¥ì— ë”°ë¼ ì¢Œìš° ë°˜ì „)
      ctx.save();
      const ex = e.x + e.w/2;
      const ey = e.y + e.h/2;
      ctx.translate(ex, ey);
      ctx.scale((e.face || -1), 1);
      ctx.drawImage(e.img, -e.w/2, -e.h/2, e.w, e.h);
      ctx.restore();

      drawEnemyWarning(e, now);
}


    // ğŸ’¥ í­ë°œ íŒŒí‹°í´
    for (const p of particles){
      ctx.globalAlpha = Math.max(0, p.alpha);
      ctx.fillStyle = "rgba(255,220,120,0.95)";
      ctx.beginPath();
      ctx.arc(p.x, p.y, p.r, 0, Math.PI*2);
      ctx.fill();
    }
    ctx.globalAlpha = 1;

    // ğŸŒ€ ì  ì£½ìŒ ì—°ì¶œ(ë‚ ì•„ê°€ë©°/í­íŒŒ í›„ í˜ì´ë“œ)
    for (const d of deathFx){
      ctx.save();
      ctx.globalAlpha = Math.max(0, d.alpha);

      const cx = d.x + d.w/2;
      const cy = d.y + d.h/2;

      ctx.translate(cx, cy);
      ctx.rotate(d.rot);
      ctx.drawImage(d.img, -d.w/2, -d.h/2, d.w, d.h);

      ctx.restore();
    }
    ctx.globalAlpha = 1;

    // ì—ë„ˆì§€(í•˜íŠ¸) ë“œë
    for (const h of energyDrops){
      // í•˜íŠ¸ ë°°ê²½
      ctx.beginPath();
      ctx.arc(h.x, h.y, h.r, 0, Math.PI*2);
      ctx.fillStyle = "rgba(255,255,255,0.92)";
      ctx.fill();
      ctx.strokeStyle = "rgba(0,0,0,0.25)";
      ctx.lineWidth = 3;
      ctx.stroke();

      // â™¥ ì•„ì´ì½˜
      ctx.fillStyle = "rgba(207,48,74,0.92)";
      ctx.font = "900 16px system-ui, sans-serif";
      ctx.textAlign = "center";
      ctx.textBaseline = "middle";
      ctx.fillText("â™¥", h.x, h.y+0.5);
    }

    // ì½”ì¸(ì‚¬í† ì‹œ)
    for (const c of coins){
      // ì½”ì¸
      ctx.beginPath();
      ctx.arc(c.x, c.y, c.r, 0, Math.PI*2);
      ctx.fillStyle = "#f3ba2f";
      ctx.fill();

      // í…Œë‘ë¦¬
      ctx.strokeStyle = "rgba(0,0,0,0.25)";
      ctx.lineWidth = 3;
      ctx.stroke();

      // â‚¿
      ctx.fillStyle = "rgba(0,0,0,0.65)";
      ctx.font = "900 14px system-ui, sans-serif";
      ctx.textAlign = "center";
      ctx.textBaseline = "middle";
      ctx.fillText("â‚¿", c.x, c.y+0.5);
    }

    
    // ë‹¨ê³„ ì‹œì‘ ë©˜íŠ¸ + 'ì ê¹ ë©ˆì¶¤' í‘œì‹œ(ì²´ê°ë˜ê²Œ)
    const _nowLv = performance.now();
    const inPause = (!seasonComplete && alive() && _nowLv < levelPauseUntil);

    if (inPause){
      const showIntro = (_nowLv < showLevelTextUntil);

      ctx.save();
      // í™”ë©´ ì‚´ì§ ì–´ë‘¡ê²Œ(ë©ˆì¶¤ ì²´ê°)
      ctx.fillStyle = "rgba(0,0,0,0.45)";
      ctx.fillRect(0,0,CW(),CH());

      ctx.fillStyle = "#fff";
      ctx.textAlign = "center";
      ctx.textBaseline = "middle";

      // í° ê¸€ì”¨
      ctx.font = "900 44px system-ui, -apple-system, Segoe UI, Roboto, sans-serif";
      ctx.fillText(showIntro ? `${level}ë‹¨ê³„ ì‹œì‘` : "ì ê¹ ë©ˆì¶¤...", CW()/2, CH()/2);

      // ì‘ì€ ì•ˆë‚´
      ctx.globalAlpha = 0.92;
      ctx.font = "900 16px system-ui, -apple-system, Segoe UI, Roboto, sans-serif";
      ctx.fillText("Ready!", CW()/2, CH()/2 + 46);

      ctx.restore();
    }

// ê²Œì„ì˜¤ë²„
    if (!alive()){
      ctx.save();
      ctx.fillStyle = "rgba(0,0,0,0.55)";
      ctx.fillRect(0,0,CW(),CH());

      ctx.fillStyle = "#fff";
      ctx.font = "900 44px system-ui, sans-serif";
      ctx.textAlign = "center";
      ctx.textBaseline = "middle";
      ctx.fillText("GAME OVER", CW()/2, CH()/2 - 20);

      ctx.font = "900 18px system-ui, sans-serif";
      ctx.fillText("ì‚¬í† ì‹œ: " + score + "  |  Restart ë²„íŠ¼ì„ ëˆ„ë¥´ì„¸ìš”", CW()/2, CH()/2 + 28);
      ctx.restore();
    }

    // =============================
    // POST-DRAW BLACK BAR MASK
    //  - ìŠ¤ì¼€ì¼ ê²½ê³„ì˜ ì•ˆí‹°ì•¨ë¦¬ì–´ì‹±(í¬ë¯¸í•œ 'ê·¸ë¦¼ì')ë¥¼ ì™„ì „íˆ ë®ì–´ì”Œì›€
    // =============================
    ctx.setTransform(1,0,0,1,0,0);
    ctx.fillStyle = "#000";
    const drawW = VIEW_W * viewScale;
    const drawH = VIEW_H * viewScale;

    // left bar
    if (viewOffX > 0) ctx.fillRect(0, 0, viewOffX + 1, canvas.height);
    // right bar
    const rightX = viewOffX + drawW;
    if (rightX < canvas.width) ctx.fillRect(rightX - 1, 0, canvas.width - rightX + 1, canvas.height);

    // top bar
    if (viewOffY > 0) ctx.fillRect(0, 0, canvas.width, viewOffY + 1);
    // bottom bar
    const bottomY = viewOffY + drawH;
    if (bottomY < canvas.height) ctx.fillRect(0, bottomY - 1, canvas.width, canvas.height - bottomY + 1);


    // =============================
    // â¸ï¸ PAUSED overlay
    // =============================
    if (userPaused){
      ctx.save();
      ctx.setTransform(1,0,0,1,0,0);
      ctx.fillStyle = "rgba(0,0,0,0.55)";
      ctx.fillRect(0,0,canvas.width,canvas.height);
      ctx.fillStyle = "#fff";
      ctx.font = "950 34px system-ui";
      ctx.textAlign = "center";
      ctx.textBaseline = "middle";
      ctx.fillText("PAUSED", canvas.width/2, canvas.height/2 - 10);
      ctx.font = "900 14px system-ui";
      ctx.fillStyle = "rgba(255,255,255,0.85)";
      ctx.fillText("Press P or tap Resume", canvas.width/2, canvas.height/2 + 26);
      ctx.restore();
    }

    // ë‹¤ì‹œ ê²Œì„ ì¢Œí‘œê³„(ê°€ìƒ í™”ë©´)ë¡œ ëŒì•„ê°ˆ í•„ìš”ëŠ” ì—†ìŒ(ë‹¤ìŒ í”„ë ˆì„ì—ì„œ ë‹¤ì‹œ ì„¤ì •í•¨)
  }

  // =============================
  // ë£¨í”„
  // =============================
  
  // =============================
  // ë£¨í”„ (ê¸°ê¸°ë³„ FPS ì°¨ì´ì—ë„ 'ì†ë„'ê°€ ë™ì¼í•˜ê²Œ ë³´ì´ë„ë¡: dtScale ì ìš©)
  //  - 60fps ê¸°ì¤€ìœ¼ë¡œ ì„¤ê³„ëœ ê°’ë“¤ì„ dtScale(= í˜„ì¬í”„ë ˆì„/16.666ms)ë¡œ ë³´ì •
  // =============================
  let _lastT = performance.now();
  function loop(now){
    // dtScale: 60fpsì´ë©´ 1.0, 120fpsì´ë©´ 0.5, 30fpsì´ë©´ 2.0
    let dtScale = (now - _lastT) / 16.666;
    _lastT = now;

    if (!isFinite(dtScale) || dtScale <= 0) dtScale = 1;
    // íƒ­ ì „í™˜/ë ‰ìœ¼ë¡œ dtê°€ ë„ˆë¬´ ì»¤ì§€ë©´ ë¬¼ë¦¬ íŠ ë°©ì§€ (ìµœëŒ€ 2í”„ë ˆì„ì¹˜ë¡œ ì œí•œ)
    if (dtScale > 2.0) dtScale = 2.0;

    // âœ… ì‹œê°„ ê¸°ë°˜ìœ¼ë¡œ 'í”„ë ˆì„ ì¹´ìš´í„°' ëˆ„ì  ì‚¬í† ì‹œ (ê¸°ì¡´ t=í”„ë ˆì„ ëŠë‚Œ ìœ ì§€)
    t += dtScale;

    if (alive() && !userPaused) update(dtScale);
    draw();

    requestAnimationFrame(loop);
  }
// ì‹œì‘
  (async function(){
    // âœ… ì´ë©”ì¼ì€ 6ë‹¨ê³„ë¶€í„° ë°›ê¸°: ì €ì¥ëœ ì´ë©”ì¼ì´ ìˆì„ ë•Œë§Œ ìë™ ë¡œë“œ
    currentEmail = getAnyEmail();
    syncEmailHudButtons();
    if (currentEmail){
      await tgGame2EnsureEmail({ promptIfMissing:false, mode:"startup" });
    } else {
      try{ if (hudSaveStatus) hudSaveStatus.textContent = "guest"; }catch(_){ }
      try{ if (hudEmailMask) hudEmailMask.textContent = "-"; }catch(_){ }
      try{ if (btnChangeEmail) btnChangeEmail.style.display = "none"; }catch(_){ }
    }

    // ì‹œì‘
    startLevel(level);

    requestAnimationFrame(loop);
  })();
})();
</script>

<br>
<!-- â“˜ Help (ê¸°ë³¸ ìˆ¨ê¹€, ë²„íŠ¼ìœ¼ë¡œ í† ê¸€) -->
<button id="helpBtn" type="button" aria-label="help">â“˜</button>
<div id="helpPanel" role="dialog" aria-label="help panel" aria-hidden="true">
  <div class="hp-title">Quick Help</div>
  <div class="hp-body">
    <div><b>PC</b> : â† â†’ ì´ë™ Â· Space ì í”„ Â· Q ì„œë¥˜ Â· <b>W ìœ„ê³µê²©(ë“œë¡ )</b></div>
    <div style="margin-top:4px;"><b>Mobile</b> : ğŸ“„ ì„œë¥˜(Q) Â· â¬†ğŸ“„ <b>ìœ„ê³µê²©(W)</b> Â· â—€ ì´ë™ Â· â¬† ì í”„ Â· â–¶ ì´ë™</div>
    <div style="margin-top:6px; opacity:0.9;">Tip: ë“œë¡ ì€ ìœ„ê³µê²©(W)ìœ¼ë¡œë§Œ ì²˜ì¹˜ ê°€ëŠ¥ Â· ë§ìœ¼ë©´ â¤ï¸ -1</div>
    <div style="margin-top:4px; opacity:0.9;">Tip: ì ì„ ì„œë¥˜ë¡œ ì¡ìœ¼ë©´ ğŸª™ ì‚¬í† ì‹œ ë“œë (10% â™¥ ì—ë„ˆì§€)</div>
  </div>
</div>


</body>
</html>
